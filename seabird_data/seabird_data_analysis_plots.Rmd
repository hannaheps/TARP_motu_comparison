---
title: "seabird_analysis"
author: "CEB"
date: '2023-08-28'
output: html_document
---

Analysis of seabird data from Tetiaroa. Original correlations analysis done in seabird_data_prep.Rmd file

#load packages
```{r}
library(tidyverse)

library(lme4)
library(car)
library(jtools)

library(vegan)

library(emmeans)


library(RColorBrewer)
library(cowplot)


```


#load data
```{r}
#load seabird data----
load("outputs/seabird_dens_bio_data.RData")

#by species:
#sb_dat_focal_nests_motu_sp
#sb_dat_focal_nests_100m_sp
#sb_dat_focal_nests_200m_sp
#sb_dat_focal_nests_side_sp

#sb_dat_focal_adults_motu_sp
#sb_dat_focal_adults_100m_sp
#sb_dat_focal_adults_200m_sp
#sb_dat_focal_adults_side_sp

#plus iti by species:
#sb_dat_iti_adults_sp
#sb_dat_iti_nests_sp

#aggregated:
#seabird_focal_all
#seabird_side_w_iti


#load metadata----
site_metdata<-read.csv("../metadata/TARP_Nov2021_site_metadata_version2.csv")
str(site_metdata)   

```


#combine seabird data + metadata
```{r}
str(seabird_focal_all)
str(site_metdata)   

#in seabird data - change to lowercase, change name of exposure -> "protection"
seabird_focal_all2<-
  seabird_focal_all%>%
  rename_with(tolower)%>%
  mutate(motu = str_to_lower(motu),
         exposure = str_to_lower(exposure))%>%
  rename(protection = exposure)
  
seabird_focal_all2

seabird_focal_all_meta<-right_join(select(site_metdata, 
                                                             c("motu", "site.name", "protection", "island.side", "rat.eradication.status")), seabird_focal_all2, by = join_by(motu, protection))

seabird_focal_all_meta

```

#check which seabird species dominates density/biomsas
```{r}
sb_dat_focal_nests_motu_sp %>%
  group_by(SpeciesName)%>%
  summarize(sum_abundance = sum(Abundance),
            sum_density = sum(Density_ha),
            sum_biomass = sum(biomass_kg_ha))

#density:
4.210526/(4.210526+268.823529	+13.034056	+382.807018) #0.006294936
268.823529/(4.210526+268.823529	+13.034056	+382.807018) #0.4019039
13.034056/(4.210526+268.823529	+13.034056	+382.807018) #0.01948653
382.807018/(4.210526+268.823529	+13.034056	+382.807018) #0.5723146


#biomass:
0.4736842/(0.4736842+50.8076471	+1.5249845	+373.2368421) #0.001111822
50.8076471/(0.4736842+50.8076471	+1.5249845	+373.2368421) #0.1192547
1.5249845/(0.4736842+50.8076471	+1.5249845	+373.2368421) #0.003579413
373.2368421/(0.4736842+50.8076471	+1.5249845	+373.2368421) #0.8760541

```



#test of rat status vs. seabird metric(s) (no Iti, because that doesn't make sense to include for this - different motu with different rat status)
```{r}
str(seabird_focal_all_meta)

#by side----
sb_br_bio_side_mod<-lmer(breeding_biomass_kgha_side~ rat.eradication.status + protection + (1|motu), data = seabird_focal_all_meta)

summary(sb_br_bio_side_mod)
plot(sb_br_bio_side_mod)
vif(sb_br_bio_side_mod)
Anova(sb_br_bio_side_mod)

plot_summs(sb_br_bio_side_mod)

#may not need random effect, because accounted for in rat status and expect 2 sides to be somewhat independent??

sb_br_bio_side_mod_lm<-lm(breeding_biomass_kgha_side~ protection + rat.eradication.status, data = seabird_focal_all_meta)
summary(sb_br_bio_side_mod_lm)
plot(sb_br_bio_side_mod_lm)


sb_br_bio_side_mod_lm<-lm(breeding_biomass_kgha_side~rat.eradication.status, data = seabird_focal_all_meta)
summary(sb_br_bio_side_mod_lm)
plot_summs(sb_br_bio_side_mod_lm)


sb_br_bio_side_mod_lm<-lm(breeding_biomass_kgha_side~ 0 + rat.eradication.status, data = seabird_focal_all_meta)
summary(sb_br_bio_side_mod_lm)
plot_summs(sb_br_bio_side_mod_lm)

#motu-level hard because only 3 points??

```


#do community analysis with seabird data?
```{r}
str(sb_dat_focal_nests_side_sp)

sb_sp_br_density_side_wide<-pivot_wider(sb_dat_focal_nests_side_sp,
                                        id_cols = c(Motu, Exposure), values_from = Density_m2, values_fn = sum, 
                                        values_fill = 0, names_from = SpeciesName)
sb_sp_br_density_side_wide

sb_sp_br_density_side_wide_sp<-sb_sp_br_density_side_wide[,(3:6)]

###RUN NMDS----
nmds_sb_br_dens_focal<-metaMDS(sb_sp_br_density_side_wide_sp, distance = "bray", trymax=200, k=2)
nmds_sb_br_dens_focal
#stress = 0 - warning - insufficient data***

plot(nmds_sb_br_dens_focal)


#try with euclidean beacuase that's okay with 0s:
nmds_sb_br_dens_focal_euc<-metaMDS(sb_sp_br_density_side_wide_sp, distance = "euclidean", trymax=200, k=2)
nmds_sb_br_dens_focal_euc
#same issue

plot(nmds_sb_br_dens_focal_euc)
scores(nmds_sb_br_dens_focal_euc, display="species")


#look at plot and centroids, for now just motu and exposure (so sitename). will need to add explanatory variables
plot(nmds_sb_br_dens_focal)
ord.fit<-envfit(nmds_sb_br_dens_focal~Motu+Exposure, data = sb_sp_br_density_side_wide, na.rm=TRUE)
ord.fit #looks like some differences among motu
plot(ord.fit)
#draw polygons
ordihull(nmds_sb_br_dens_focal, sb_sp_br_density_side_wide$Motu, pty=3)
#some clustering, but so few sites....
#could do transect level??


#PERMANOVA
#anosim more influenced by dispersion, so use adonis
#run analysis
ad_sb1<-adonis2(sb_sp_br_density_side_wide_sp ~ Motu, data = sb_sp_br_density_side_wide, method="euclidean")
ad_sb1
#marginal, but warnings**


#test dispersion using PERMDISP
mod_sb <- betadisper(vegdist(sb_sp_br_density_side_wide_sp, method = "euclidean"), sb_sp_br_density_side_wide$Motu)
mod_sb
#test for overall differences
anova(mod_sb)
#warning, but significant


###----LOTS OF WARNINGS ABOUT PERFICT FIT/INSUFFICENT DATA -> UNRELIABLE----

```

#re-run analysis with spatial scale as a predictor
```{r}
seabird_focal_all_meta

#start with breeding biomass:
seabird_focal_all_meta_br_bio<-
  seabird_focal_all_meta[,(1:9)]
seabird_focal_all_meta_br_bio


seabird_focal_all_meta_long<-pivot_longer(seabird_focal_all_meta_br_bio,
                                          cols = starts_with("breeding_biomass_kgha"),
                                          names_to = "spatial_scale",
                                          values_to = "breeding_biomass")%>%
  mutate(spatial_scale = str_remove(spatial_scale, 'breeding_biomass_kgha_'))
seabird_focal_all_meta_long


##now run analysis----
sb_br_bio_space_mod<-lmer(breeding_biomass~ rat.eradication.status + protection + spatial_scale + (1|motu), 
                          data = seabird_focal_all_meta_long)
#warnings
summary(sb_br_bio_space_mod)
vif(sb_br_bio_space_mod)
plot(sb_br_bio_space_mod)

plot_summs(sb_br_bio_space_mod)
summ(sb_br_bio_space_mod)
anova(sb_br_bio_space_mod)
Anova(sb_br_bio_space_mod)
#weirdly, only protection coming up 'significant'
#is it because motu is accounted for in both fixed and random effects???

sb_br_bio_space_mod2<-lmer(breeding_biomass~ rat.eradication.status + protection + spatial_scale + (1|motu) + (1|motu:protection), 
                          data = seabird_focal_all_meta_long)
summary(sb_br_bio_space_mod2)
Anova(sb_br_bio_space_mod2)
#yup, I think not working to have random effects.....


#run regular lm----
sb_br_bio_space_mod_lm<-lm(breeding_biomass~ rat.eradication.status + protection + spatial_scale, 
                          data = seabird_focal_all_meta_long)
summary(sb_br_bio_space_mod_lm)
plot_summs(sb_br_bio_space_mod_lm)
Anova(sb_br_bio_space_mod_lm)
##THIS LOOKS PROMISING - hierarchy in seabird biomass by rat status, protected sides also tend to have higher biomass...
#no trends by spatial scale...

#do post-hoc test for rat eradication? - Tukey HSD didn't work, use emmeans for estiamtes:
sb_br_bio_space_mod_lm %>% 
  emmeans(~ rat.eradication.status,
          type = "response") 


sb_br_bio_space_mod_lm %>% 
  emmeans(~ rat.eradication.status|protection,
          type = "response") 


#looks good, except some estimates below 0 so that doesn't make sense....may need to use a different distribution***
#OR do log***

#run log model to avoid negative values for seabird estimates----
#(need log + 1 because one 0 value)
sb_br_bio_space_mod_log_lm<-lm(log(breeding_biomass+1)~ rat.eradication.status + protection + spatial_scale, 
                          data = seabird_focal_all_meta_long)
summary(sb_br_bio_space_mod_log_lm)
plot_summs(sb_br_bio_space_mod_log_lm)
Anova(sb_br_bio_space_mod_log_lm)

sb_br_bio_space_mod_log_lm %>% 
  emmeans(~ rat.eradication.status,
          type = "response") 
#now makes sense***

sb_br_bio_space_mod_log_lm %>% 
  emmeans(~ rat.eradication.status|protection,
          type = "response") 


sb_br_bio_space_mod_log_lm %>% 
  emmeans(~ rat.eradication.status|spatial_scale,
          type = "response") 


sb_br_bio_space_mod_log_lm %>% 
  emmeans(~ rat.eradication.status|spatial_scale + protection,
          type = "response") 


```

#maybe show plots of raw values and model estimates
```{r}

#emmeans plot----
plot(emmeans(sb_br_bio_space_mod_log_lm, ~ rat.eradication.status,
          type = "response"))

emmip(sb_br_bio_space_mod_log_lm, ~ rat.eradication.status,
          type = "response", CIs = TRUE)+
   geom_point(data = seabird_focal_all_meta_long, 
             aes(y = breeding_biomass, x = rat.eradication.status, shape = protection, color = spatial_scale, fill = spatial_scale))+
  theme_bw()

#response plot----
plot_data<-emmip(sb_br_bio_space_mod_log_lm, ~ rat.eradication.status,
          type = "response", CIs = TRUE, plotit=FALSE)%>%
  mutate(rat.eradication.status = fct_relevel(rat.eradication.status, c("None", "eradicated_2018", "eradicated_2022")))
plot_data

my_colors <- RColorBrewer::brewer.pal(9, "Blues")[c(2, 4, 6, 8)]

seabird_rat_response_plot<-
  ggplot(data = plot_data, aes(x = rat.eradication.status, y = yvar))+
  geom_point(pch = 4)+
  geom_pointrange(aes(ymin = LCL, ymax = UCL), alpha = .3, linewidth = 5, size = 0) + 
  geom_point(data = seabird_focal_all_meta_long, 
             aes(y = breeding_biomass, x = rat.eradication.status, shape = protection,                  
                 color = spatial_scale, fill = spatial_scale), size = 2.5, alpha = .5)+
  scale_fill_manual(values = my_colors)+
  scale_color_manual(values = my_colors) +
  ylab("Seabird breeding biomass (kg/ha)")+
  xlab("")+
    scale_x_discrete(labels = c('no rats','rats eradicated 2018','rats'))+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.9,.7) )

seabird_rat_response_plot


#log plot----
plot_data_log<-emmip(sb_br_bio_space_mod_log_lm, ~ rat.eradication.status,
           CIs = TRUE, plotit=FALSE)%>%
  mutate(rat.eradication.status = fct_relevel(rat.eradication.status, c("None", "eradicated_2018", "eradicated_2022")))
plot_data_log



seabird_rat_log_plot<-
  ggplot(data = plot_data_log, aes(x = rat.eradication.status, y = yvar))+
  geom_point(pch = 4)+
  geom_pointrange(aes(ymin = LCL, ymax = UCL), alpha = .3, linewidth = 5, size = 0) + 
  geom_point(data = seabird_focal_all_meta_long, 
             aes(y = log(breeding_biomass+1), x = rat.eradication.status, shape = protection, 
                 color = spatial_scale, fill = spatial_scale), size = 2.5, alpha = .5)+
  scale_fill_manual(values = my_colors)+
  scale_color_manual(values = my_colors) +
  ylab("Seabird breeding biomass (log kg/ha)")+
  xlab("")+
    scale_x_discrete(labels = c('no rats','rats eradicated 2018','rats'))+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.9,.7) )
seabird_rat_log_plot
  
```

##save/print plots
```{r}
seabird_rat_log_plot
seabird_rat_response_plot

#go with log-plot to see everything - save plot

ggsave("outputs/seabird_vs_rat_log_plot.pdf", plot = seabird_rat_log_plot)

```

##make plot of seabird proportions by motu
```{r}
sb_dat_focal_nests_motu_sp%>%
  ggplot(aes(fill = SpeciesName, y = Density_ha, x = Motu))+
  geom_bar(position = "stack", stat =  "identity")

sb_dat_focal_nests_motu_sp%>%
  ggplot(aes(fill = SpeciesName, y = biomass_kg_ha, x = Motu))+
  geom_bar(position = "stack", stat =  "identity")


#clean up plots and save:
sb_dens_stack_plot<-
sb_dat_focal_nests_motu_sp%>%
  ggplot(aes(fill = SpeciesName, y = Density_ha, x = Motu))+
  geom_bar(position = "stack", stat =  "identity")+
  ylab("Seabird breeding density/ha")+
  xlab("")+
  scale_fill_manual(values = c("#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3"),  #rcolorbrewer - set2, colorblind friendly
                    name = "Species",
                                            breaks=c("Aminutus",  "Astolidus", "Galba",  "Ssula"),
                       labels=c("Anous minutus (black noddy)", "Anous stolidus (brown noddy)", "Gygis alba (fairy tern)", "Sula sula (red-footed booby)")
                    )+ 
  theme_bw()+
 theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
       legend.position = c(.75,.8)
       )
sb_dens_stack_plot



sb_bio_stack_plot<-
sb_dat_focal_nests_motu_sp%>%
  ggplot(aes(fill = SpeciesName, y = biomass_kg_ha, x = Motu))+
  geom_bar(position = "stack", stat =  "identity")+
  ylab("Seabird breeding biomass kg/ha")+
  xlab("")+
  scale_fill_manual(values = c("#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3"), #rcolorbrewer - set2, colorblind friendly
                    name = "Species",
                                            breaks=c("Aminutus",  "Astolidus", "Galba",  "Ssula"),
                       labels=c("Anous minutus (black noddy)", "Anous stolidus (brown noddy)", "Gygis alba (fairy tern)", "Sula sula (red-footed booby)")
                    )+ 
  theme_bw()+
 theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
      # legend.position = c(.75,.8)
        legend.position = "none"
        )

sb_bio_stack_plot


seabird_stack_plots<-plot_grid(sb_bio_stack_plot, sb_dens_stack_plot, labels = "auto")
seabird_stack_plots



ggsave(filename = "outputs/seabird_stack_plots.pdf", 
       plot = seabird_stack_plots,
       width = 10,
       height = 5,
       units = "in",
      dpi = 500)



```

