---
title: "seabirds_vs_fish_condition"
author: "CEB"
date: '2024-01-23'
output: html_document
---


#load packages
```{r}
library(tidyverse)

library(lme4)
library(car)
library(jtools)

library(emmeans)

library(corrplot)

```


#load data
```{r}
seabirds <- read.csv("../output/n15_seabirds_combined_no_iti.csv", strip.white = T, header = T)
fish_n15 <- read.csv("../../fish_isotopes/raw_data/fish_isotopes_focal_spp_only.csv", stringsAsFactors = TRUE)
fish_cond <- read.csv("../../fish_isotopes/raw_data/fish_capture_data_focal_motu_spp_only.csv", stringsAsFactors = TRUE)

```



#merge data
```{r}
#make combined site name column in fish_n15

fish_n15_dat<-
  fish_n15%>%
  mutate(protection = if_else(wind.exposure == "leeward", "Protected", "Exposed"))%>%
  unite("site.name", c(motu, protection), sep = "_", remove = FALSE)

fish_n15_dat

fishn15.seabirds<-left_join(select(fish_n15_dat, c("site.name", "motu", "fish.id", "species", 
                                                   "month.caught", "year.caught", "protection", "n15",
                                                   "c13", "n.percent", "c.percent")),
                            select(seabirds, c("site.name", "breeding_biomass_kgha_side")), 
                                   by = "site.name")%>%
  mutate(site.name = as.factor(site.name))
fishn15.seabirds


fishn15.seabirds.cond<-left_join(fishn15.seabirds, 
                                 select(fish_cond, c("fish.id", "TL.cm", "FL.cm", "SL.cm", "whole.weight.g", 
                                                     "gonad.weight.g", "sex", "stage.coarse", 
                                                     "stage.detailed", "liver.weight.g")), 
                                   by = "fish.id") %>%
  relocate(c(breeding_biomass_kgha_side, protection, month.caught, year.caught), .before = fish.id)
  
  
  
fishn15.seabirds.cond

```

#calculate condition indices, add seabird levels
```{r}
fishn15.seabirds.cond<-
  fishn15.seabirds.cond%>%
  mutate(K = 100*(whole.weight.g/(TL.cm^3)),
         HSI = liver.weight.g/whole.weight.g*100,
         GSI = gonad.weight.g/whole.weight.g*100)
fishn15.seabirds.cond



#4 sites:
#Aie protected = 378.720000	
#Aie exposed = 128.000000	
#Reiono exposed = 115.353333
#Rimatuu protected = 5.390526

fishn15.seabirds.cond<-
  fishn15.seabirds.cond%>%
  mutate(seabird_level = case_when(breeding_biomass_kgha_side<7 ~"low",
                                   breeding_biomass_kgha_side>7&breeding_biomass_kgha_side <200 ~"mid",
                                   breeding_biomass_kgha_side>200 ~"high"))%>%
  mutate(seabird_level = as.factor(seabird_level))%>%
  mutate(seabird_level = fct_relevel(seabird_level, "low", "mid", "high"))%>%
  relocate(seabird_level, .before = breeding_biomass_kgha_side)

fishn15.seabirds.cond

```

#quick plots:
```{r}

#by seabird biomass----
fishn15.seabirds.cond%>%
group_by(species, breeding_biomass_kgha_side)%>%
  summarize(mean_n15 = mean(n15),
            n_n15 = length(n15),
            se_n15 = sd(n15)/sqrt(n_n15))%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = mean_n15, color = species, fill = species, group = species))+
  geom_point(alpha = .5)+
  geom_errorbar(aes(ymin = (mean_n15-se_n15), ymax = (mean_n15+se_n15)), alpha = .5, width = 0)+
  geom_line(alpha = .5)+
  theme_bw() 


fishn15.seabirds.cond%>%
group_by(species, breeding_biomass_kgha_side)%>%
  summarize(mean_K = mean(K),
            n_K = length(K),
            se_K = sd(K)/sqrt(n_K))%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = mean_K, color = species, fill = species, group = species))+
  geom_point(alpha = .5)+
  geom_errorbar(aes(ymin = (mean_K-se_K), ymax = (mean_K+se_K)), alpha = .5, width = 0)+
  geom_line(alpha = .5)+
  theme_bw() 


fishn15.seabirds.cond%>%
group_by(species, breeding_biomass_kgha_side)%>%
  summarize(mean_HSI = mean(HSI),
            n_HSI = length(HSI),
            se_HSI = sd(HSI)/sqrt(n_HSI))%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = mean_HSI, color = species, fill = species, group = species))+
  geom_point(alpha = .5)+
  geom_errorbar(aes(ymin = (mean_HSI-se_HSI), ymax = (mean_HSI+se_HSI)), alpha = .5, width = 0)+
  geom_line(alpha = .5)+
  theme_bw() 


fishn15.seabirds.cond%>%
group_by(species, sex, breeding_biomass_kgha_side)%>%
  summarize(mean_GSI = mean(GSI),
            n_GSI = length(GSI),
            se_GSI = sd(GSI)/sqrt(n_GSI))%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = mean_GSI, color = species, fill = species, group = species))+
  geom_point(alpha = .5)+
  geom_errorbar(aes(ymin = (mean_GSI-se_GSI), ymax = (mean_GSI+se_GSI)), alpha = .5, width = 0)+
  geom_line(alpha = .5)+
  theme_bw() +
  facet_wrap(~sex)



#by seabird level----
fishn15.seabirds.cond%>%
group_by(species, seabird_level)%>%
  summarize(mean_n15 = mean(n15),
            n_n15 = length(n15),
            se_n15 = sd(n15)/sqrt(n_n15))%>%
  ggplot(aes(x = seabird_level, y = mean_n15, color = species, fill = species, group = species))+
  geom_point(alpha = .5)+
  geom_errorbar(aes(ymin = (mean_n15-se_n15), ymax = (mean_n15+se_n15)), alpha = .5, width = 0)+
  geom_line(alpha = .5)+
  theme_bw() 


fishn15.seabirds.cond%>%
group_by(species, seabird_level)%>%
  summarize(mean_K = mean(K),
            n_K = length(K),
            se_K = sd(K)/sqrt(n_K))%>%
  ggplot(aes(x = seabird_level, y = mean_K, color = species, fill = species, group = species))+
  geom_point(alpha = .5)+
  geom_errorbar(aes(ymin = (mean_K-se_K), ymax = (mean_K+se_K)), alpha = .5, width = 0)+
  geom_line(alpha = .5)+
  theme_bw() 


fishn15.seabirds.cond%>%
group_by(species, seabird_level)%>%
  summarize(mean_HSI = mean(HSI),
            n_HSI = length(HSI),
            se_HSI = sd(HSI)/sqrt(n_HSI))%>%
  ggplot(aes(x = seabird_level, y = mean_HSI, color = species, fill = species, group = species))+
  geom_point(alpha = .5)+
  geom_errorbar(aes(ymin = (mean_HSI-se_HSI), ymax = (mean_HSI+se_HSI)), alpha = .5, width = 0)+
  geom_line(alpha = .5)+
  theme_bw() 


fishn15.seabirds.cond%>%
group_by(species, sex, seabird_level)%>%
  summarize(mean_GSI = mean(GSI),
            n_GSI = length(GSI),
            se_GSI = sd(GSI)/sqrt(n_GSI))%>%
  ggplot(aes(x = seabird_level, y = mean_GSI, color = species, fill = species, group = species))+
  geom_point(alpha = .5)+
  geom_errorbar(aes(ymin = (mean_GSI-se_GSI), ymax = (mean_GSI+se_GSI)), alpha = .5, width = 0)+
  geom_line(alpha = .5)+
  theme_bw() +
  facet_wrap(~sex)


##box plots by level----
fishn15.seabirds.cond%>%
  ggplot(aes(x = seabird_level, y = K, color = species, fill = species))+
  facet_wrap(~species, scales = "free")+
  geom_boxplot(alpha = .5)+
  geom_point(alpha = .7)


fishn15.seabirds.cond%>%
  ggplot(aes(x = seabird_level, y = n15, color = species, fill = species))+
  facet_wrap(~species, scales = "free")+
  geom_boxplot(alpha = .5)+
  geom_point(alpha = .7)


fishn15.seabirds.cond%>%
  ggplot(aes(x = seabird_level, y = HSI, color = species, fill = species))+
  facet_wrap(~species, scales = "free")+
  geom_boxplot(alpha = .5)+
  geom_point(alpha = .7)

fishn15.seabirds.cond%>%
  ggplot(aes(x = seabird_level, y = GSI, color = species, fill = species))+
  facet_wrap(~species, scales = "free")+
  geom_boxplot(alpha = .5)+
  geom_point(alpha = .7)

fishn15.seabirds.cond%>%
  filter(sex == "f")%>%
  ggplot(aes(x = seabird_level, y = GSI, color = species, fill = species))+
  facet_wrap(~species, scales = "free")+
  geom_boxplot(alpha = .5)+
  geom_point(alpha = .7)


#check sample size for C. argus - looks like not many for high seabirds:-----
fishn15.seabirds.cond%>%
  group_by(site.name, species)%>%
  summarize(length(K))


fishn15.seabirds.cond%>%
  group_by(seabird_level, species)%>%
  summarize(length(K))

#may not want to use C. argus because only 1 in high area....

#plot by n15: 
fishn15.seabirds.cond%>%
  ggplot(aes(x = n15, y = HSI))+
  geom_point(alpha = .5, aes(color = seabird_level, fill = seabird_level))+
  geom_smooth(method = "lm")+
  theme_bw() +
  facet_wrap(~species, scales = "free")


fishn15.seabirds.cond%>%
  filter(sex == "f")%>%
  ggplot(aes(x = n15, y = GSI))+
  geom_point(alpha = .5, aes(color = seabird_level, fill = seabird_level))+
  geom_smooth(method = "lm")+
  theme_bw() +
  facet_wrap(~species, scales = "free")


fishn15.seabirds.cond%>%
  ggplot(aes(x = n15, y = K))+
  geom_point(alpha = .5, aes(color = seabird_level, fill = seabird_level))+
  geom_smooth(method = "lm")+
  theme_bw() +
  facet_wrap(~species, scales = "free")

```

#run analysis with seabird levels - K 
#nothing interesting....
```{r}

#simple model:----
seabird_fish_K_levels_mod1<-lmer(K~ seabird_level*species + (1|site.name), 
                          data = fishn15.seabirds.cond)
summary(seabird_fish_K_levels_mod1)
Anova(seabird_fish_K_levels_mod1) #marginal interaction, sig effect of species

#emmeans----
EMM1 <- emmeans(seabird_fish_K_levels_mod1, ~ species * seabird_level)
pairs(EMM1, simple = "seabird_level")
test(pairs(EMM1, by = "species"), by = NULL, adjust = "mvt")
test(pairs(EMM1, by = "species"), by = NULL, adjust = "none")
#nothing actually "significant" (or really even close)


emm.summary.sb.fishk<-
seabird_fish_K_levels_mod1 %>% 
  emmeans(~ seabird_level|species) 
emm.summary.sb.fishk

emm_plot<-emmip(seabird_fish_K_levels_mod1, species ~ seabird_level, CIs = TRUE, level = c(0.75),
                 CIarg = list(lwd = .9, alpha = .25), lwd = 2, linearg = list(lwd = 1.2, alpha = .8), dotarg = list(lwd = 1.2, alpha = .8))

emm_plot_sb_k<-
emm_plot+
  ylab("K")+
  xlab("seabid biomass")+
  labs(colour = "fish species")+
  theme_bw()+
   theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
       # text = element_text(size = 14, family = "Arial"),
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA)
        )
  
emm_plot_sb_k


test(pairs(EMM, by = "species"), by = NULL, adjust = "none", level = 0.9, interval = c("confidence"))
predict(EMM, interval = c("confidence"), level = 0.9)


confint(pairs(EMM, by = "species"), by = NULL, adjust = "none", level = 0.75, interval = c("confidence"))
#at 75% confidence interval, Ab sem low is lower than mid and high....


#try additive model----
seabird_fish_K_levels_mod1_add<-lmer(K~ seabird_level+species + (1|site.name), 
                          data = fishn15.seabirds.cond)
summary(seabird_fish_K_levels_mod1_add)
Anova(seabird_fish_K_levels_mod1_add)

#LRT
anova(seabird_fish_K_levels_mod1, seabird_fish_K_levels_mod1_add) #yup, sig interaction


#so, look at each species separately:-----

stni_K_levels_mod1<-lmer(K~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Stegastes nigricans",])
#SINGULAR
summary(stni_K_levels_mod1)
Anova(stni_K_levels_mod1)
#ns


#try with motu instead because singular:
stni_K_levels_mod2<-lmer(K~ seabird_level  + (1|motu), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Stegastes nigricans",])
#SINGULAR - didn't help
summary(stni_K_levels_mod2)
Anova(stni_K_levels_mod2)



actr_K_levels_mod1<-lmer(K~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Acanthurus triostegus",])
summary(actr_K_levels_mod1)
Anova(actr_K_levels_mod1)
#ns


lufu_K_levels_mod1<-lmer(K~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Lutjanus fulvus",])
summary(lufu_K_levels_mod1)
Anova(lufu_K_levels_mod1)
#ns


cear_K_levels_mod1<-lmer(K~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Cephalopholis argus",])
#SINGULAR
summary(cear_K_levels_mod1)
Anova(cear_K_levels_mod1)
#significant
plot_summs(cear_K_levels_mod1)
#high is lower than both, mid slightly higher than low (but overlaps 0)


abse_K_levels_mod1<-lmer(K~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Abudefduf septemfasciatus",])
#SINGULAR
summary(abse_K_levels_mod1)
Anova(abse_K_levels_mod1)
#ns


##add in some other explanatory variables:----
seabird_fish_K_levels_mod2<-lmer(K~ seabird_level+species+ n15 + sex + TL.cm + (1|site.name), 
                          data = fishn15.seabirds.cond)

summary(seabird_fish_K_levels_mod2)
Anova(seabird_fish_K_levels_mod2) #only species significant


seabird_fish_K_levels_mod2<-lmer(K~ seabird_level+species + protection + year.caught + month.caught+ (1|site.name), 
                          data = fishn15.seabirds.cond)

summary(seabird_fish_K_levels_mod2)
Anova(seabird_fish_K_levels_mod2) #only species significant


##run regular lm with no random effects, and seabird biomass----
seabird_fish_K_mod_lm<-lm(K~ breeding_biomass_kgha_side*species, data = fishn15.seabirds.cond)
summary(seabird_fish_K_mod_lm)
Anova(seabird_fish_K_mod_lm)
#only species significant

seabird_fish_K_mod_lm2<-lm(K~ breeding_biomass_kgha_side+species+protection + year.caught + month.caught, data = fishn15.seabirds.cond)
summary(seabird_fish_K_mod_lm2)
Anova(seabird_fish_K_mod_lm2)
#only species significant

```

#run analysis with seabird levels - HSI 
#nothing interesting....
```{r}

#simple model:
seabird_fish_HSI_levels_mod1<-lmer(HSI~ seabird_level*species + (1|site.name), 
                          data = fishn15.seabirds.cond)
#SINGULAR
summary(seabird_fish_HSI_levels_mod1)
Anova(seabird_fish_HSI_levels_mod1) #marginal interaction, sig effect of species

#so, look at each species separately:

stni_HSI_levels_mod1<-lmer(HSI~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Stegastes nigricans",])
summary(stni_HSI_levels_mod1)
Anova(stni_HSI_levels_mod1)
#ns
plot_summs(stni_HSI_levels_mod1)


actr_HSI_levels_mod1<-lmer(HSI~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Acanthurus triostegus",])
#SINGULAR
summary(actr_HSI_levels_mod1)
Anova(actr_HSI_levels_mod1)
#ns


lufu_HSI_levels_mod1<-lmer(HSI~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Lutjanus fulvus",])
summary(lufu_HSI_levels_mod1)
Anova(lufu_HSI_levels_mod1)
#ns


cear_HSI_levels_mod1<-lmer(HSI~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Cephalopholis argus",])
summary(cear_HSI_levels_mod1)
Anova(cear_HSI_levels_mod1)
#ns


abse_HSI_levels_mod1<-lmer(HSI~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Abudefduf septemfasciatus",])
#SINGULAR
summary(abse_HSI_levels_mod1)
Anova(abse_HSI_levels_mod1)
#marginal
plot_summs(abse_HSI_levels_mod1)
#high lower than low, mid higher than low


##add in some other explanatory variables:
seabird_fish_HSI_levels_mod2<-lmer(HSI~ seabird_level+species+ n15 + TL.cm + sex + (1|site.name), 
                          data = fishn15.seabirds.cond)

summary(seabird_fish_HSI_levels_mod2)
Anova(seabird_fish_HSI_levels_mod2) #only species significant


seabird_fish_HSI_levels_mod3<-lmer(HSI~ seabird_level*species+ n15*species + TL.cm*species + sex*species + (1|site.name), 
                          data = fishn15.seabirds.cond)

summary(seabird_fish_HSI_levels_mod3)
Anova(seabird_fish_HSI_levels_mod3) #only species and n15
plot_summs(seabird_fish_HSI_levels_mod3)


seabird_fish_HSI_levels_mod3<-lmer(HSI~ n15+ species + TL.cm  + (1|site.name), 
                          data = fishn15.seabirds.cond)

summary(seabird_fish_HSI_levels_mod3)
Anova(seabird_fish_HSI_levels_mod3) #only species and n15
plot_summs(seabird_fish_HSI_levels_mod3)


seabird_fish_HSI_levels_mod2<-lmer(HSI~ seabird_level+species + protection + year.caught + month.caught+ (1|site.name), 
                          data = fishn15.seabirds.cond)

summary(seabird_fish_HSI_levels_mod2)
Anova(seabird_fish_HSI_levels_mod2) #only species significant




##run regular lm with no random effects, and seabird biomass----
seabird_fish_HSI_mod_lm<-lm(HSI~ breeding_biomass_kgha_side*species, data = fishn15.seabirds.cond)
summary(seabird_fish_HSI_mod_lm)
Anova(seabird_fish_HSI_mod_lm)
#sig interaction
plot(seabird_fish_HSI_mod_lm)
emtrends(seabird_fish_HSI_mod_lm,  ~ species, var = "breeding_biomass_kgha_side")
#A tri positive, C argus trending positive. All else trending negative


seabird_fish_HSI_mod_lm2<-lm(HSI~ breeding_biomass_kgha_side+species+protection + year.caught + month.caught, data = fishn15.seabirds.cond)
summary(seabird_fish_HSI_mod_lm2)
Anova(seabird_fish_HSI_mod_lm2)
#only species significant

```


#run analysis with seabird levels - GSI 
#nothing interesting....
```{r}

#limit to females:
fishn15.seabirds.cond.f <-
  fishn15.seabirds.cond %>%
  filter(sex == "f")


#simple model:
seabird_fish_GSI_levels_mod1<-lmer(GSI~ seabird_level*species + (1|site.name), 
                          data = fishn15.seabirds.cond.f)
#SINGULAR
summary(seabird_fish_GSI_levels_mod1)
Anova(seabird_fish_GSI_levels_mod1) #everything significant

#so, look at each species separately:
stni_GSI_levels_mod1<-lmer(GSI~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond.f[fishn15.seabirds.cond.f$species == "Stegastes nigricans",])
summary(stni_GSI_levels_mod1)
Anova(stni_GSI_levels_mod1)
#ns


actr_GSI_levels_mod1<-lmer(GSI~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond.f[fishn15.seabirds.cond.f$species == "Acanthurus triostegus",])
#SINGULAR
summary(actr_GSI_levels_mod1)
Anova(actr_GSI_levels_mod1)
#significant
plot_summs(actr_GSI_levels_mod1)
#high way higher than other two



lufu_GSI_levels_mod1<-lmer(GSI~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond.f[fishn15.seabirds.cond.f$species == "Lutjanus fulvus",])
summary(lufu_GSI_levels_mod1)
Anova(lufu_GSI_levels_mod1)
#ns


cear_GSI_levels_mod1<-lmer(GSI~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond.f[fishn15.seabirds.cond.f$species == "Cephalopholis argus",])
summary(cear_GSI_levels_mod1)
Anova(cear_GSI_levels_mod1)
#ns


abse_GSI_levels_mod1<-lmer(GSI~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond.f[fishn15.seabirds.cond.f$species == "Abudefduf septemfasciatus",])
summary(abse_GSI_levels_mod1)
Anova(abse_GSI_levels_mod1)
#ns


##add in some other explanatory variables:
seabird_fish_GSI_levels_mod2<-lmer(GSI~ seabird_level+species+ n15 + TL.cm + (1|site.name), 
                          data = fishn15.seabirds.cond.f)
#SINGULAR
summary(seabird_fish_GSI_levels_mod2)
Anova(seabird_fish_GSI_levels_mod2) #only species and seabird level significant


seabird_fish_GSI_levels_mod2<-lmer(GSI~ seabird_level+species + protection + year.caught + month.caught+ (1|site.name), 
                          data = fishn15.seabirds.cond.f)

summary(seabird_fish_GSI_levels_mod2)
Anova(seabird_fish_GSI_levels_mod2) #only species significant



##run regular lm with no random effects, and seabird biomass----
seabird_fish_GSI_mod_lm<-lm(GSI~ breeding_biomass_kgha_side*species, data = fishn15.seabirds.cond.f)
summary(seabird_fish_GSI_mod_lm)
Anova(seabird_fish_GSI_mod_lm)
#all 3 sig
plot(seabird_fish_GSI_mod_lm)
emtrends(seabird_fish_GSI_mod_lm,  ~ species, var = "breeding_biomass_kgha_side")
#A tri positive, Stegastes nig trending positive. All else trending negative


seabird_fish_GSI_mod_lm2<-lm(GSI~ breeding_biomass_kgha_side+species+protection + year.caught + month.caught, data = fishn15.seabirds.cond.f)
summary(seabird_fish_GSI_mod_lm2)
Anova(seabird_fish_GSI_mod_lm2)
#only species significant

```



#run analysis with seabird levels - n15 
#nothing interesting when break down by species....suggests that's not the way to do it (maybe because low n)
```{r}

#simple model:
seabird_fish_n15_levels_mod1<-lmer(n15~ seabird_level*species + (1|site.name), 
                          data = fishn15.seabirds.cond)
summary(seabird_fish_n15_levels_mod1)
Anova(seabird_fish_n15_levels_mod1) #sig interaction, sig effect of species

#so, look at each species separately:

stni_n15_levels_mod1<-lmer(n15~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Stegastes nigricans",])
summary(stni_n15_levels_mod1)
Anova(stni_n15_levels_mod1)
#ns
plot_summs(stni_n15_levels_mod1)


actr_n15_levels_mod1<-lmer(n15~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Acanthurus triostegus",])
summary(actr_n15_levels_mod1)
Anova(actr_n15_levels_mod1)
#ns


lufu_n15_levels_mod1<-lmer(n15~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Lutjanus fulvus",])
summary(lufu_n15_levels_mod1)
Anova(lufu_n15_levels_mod1)
#ns


cear_n15_levels_mod1<-lmer(n15~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Cephalopholis argus",])
summary(cear_n15_levels_mod1)
Anova(cear_n15_levels_mod1)
#ns


abse_n15_levels_mod1<-lmer(n15~ seabird_level + (1|site.name), 
                          data = fishn15.seabirds.cond[fishn15.seabirds.cond$species == "Abudefduf septemfasciatus",])
summary(abse_n15_levels_mod1)
Anova(abse_n15_levels_mod1)
#ns


##add in some other explanatory variables:
seabird_fish_n15_levels_mod2<-lmer(n15~ seabird_level+species+ n15 + TL.cm + sex + (1|site.name), 
                          data = fishn15.seabirds.cond)

summary(seabird_fish_n15_levels_mod2)
Anova(seabird_fish_n15_levels_mod2) #only species significant


seabird_fish_n15_levels_mod3<-lmer(n15~ seabird_level*species+ + TL.cm*species + sex*species + (1|site.name), 
                          data = fishn15.seabirds.cond)

summary(seabird_fish_n15_levels_mod3)
Anova(seabird_fish_n15_levels_mod3) #only species and species*TL
plot_summs(seabird_fish_n15_levels_mod3)


seabird_fish_n15_levels_mod3<-lmer(n15~  species + TL.cm  + (1|site.name), 
                          data = fishn15.seabirds.cond)

summary(seabird_fish_n15_levels_mod3)
Anova(seabird_fish_n15_levels_mod3) #only species
plot_summs(seabird_fish_n15_levels_mod3)


seabird_fish_n15_levels_mod2<-lmer(n15~ seabird_level+species + protection + year.caught + month.caught+ (1|site.name), 
                          data = fishn15.seabirds.cond)

summary(seabird_fish_n15_levels_mod2)
Anova(seabird_fish_n15_levels_mod2) #only species and seabird level significant

seabird_fish_n15_levels_mod5<-lmer(n15~ seabird_level*species + (1|motu), 
                          data = fishn15.seabirds.cond)
summary(seabird_fish_n15_levels_mod5)
Anova(seabird_fish_n15_levels_mod5)
#can't include protection...rank deficient

EMM <- emmeans(seabird_fish_n15_levels_mod5, ~ species * seabird_level)
pairs(EMM, simple = "seabird_level")
test(pairs(EMM, by = "species"), by = NULL, adjust = "none")
#nothing actually "significant" but trends definitely there*

confint(pairs(EMM, by = "species"), by = NULL, adjust = "none", level = 0.75, interval = c("confidence"))


##use emmeans to extract effects-----
##can i just plot/report some results from the model with 3 levels:----
plot(seabird_fish_n15_levels_mod1)

emm.summary.sb.fishn15<-
seabird_fish_n15_levels_mod1 %>% 
  emmeans(~ seabird_level|species) 
emm.summary.sb.fishn15

emm_plot<-emmip(seabird_fish_n15_levels_mod1, species ~ seabird_level, CIs = TRUE, level = c(0.75),
                 CIarg = list(lwd = .9, alpha = .25), lwd = 2, linearg = list(lwd = 1.2, alpha = .8), dotarg = list(lwd = 1.2, alpha = .8))

emm_plot_sb_n15<-
emm_plot+
  ylab("N15")+
  xlab("seabid biomass")+
  labs(colour = "fish species")+
  theme_bw()+
   theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
       # text = element_text(size = 14, family = "Arial"),
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA)
        )
  
emm_plot_sb_n15


EMM <- emmeans(seabird_fish_n15_levels_mod1, ~ species * seabird_level)
pairs(EMM, simple = "seabird_level")
test(pairs(EMM, by = "species"), by = NULL, adjust = "mvt")
test(pairs(EMM, by = "species"), by = NULL, adjust = "none")
#nothing actually "significant" (or really even close) but trends definitely there*

test(pairs(EMM, by = "species"), by = NULL, adjust = "none", level = 0.9, interval = c("confidence"))
predict(EMM, interval = c("confidence"), level = 0.9)


confint(pairs(EMM, by = "species"), by = NULL, adjust = "none", level = 0.75, interval = c("confidence"))
#at 75% CI Ab udefduf sept low is lower than mid and high....

```



##re-run without argus becasue low sample size:
```{r}
fishn15.seabirds.cond_nocear<-
  fishn15.seabirds.cond%>%
  filter(species != "Cephalopholis argus")%>%
  droplevels()

fishn15.seabirds.cond_nocear

#n15----
#simple model:
seabird_fish_n15_levels_mod1r<-lmer(n15~ seabird_level*species + (1|site.name), 
                          data = fishn15.seabirds.cond_nocear)
summary(seabird_fish_n15_levels_mod1r)
Anova(seabird_fish_n15_levels_mod1r) #sig interaction, sig effect of species


EMM <- emmeans(seabird_fish_n15_levels_mod1r, ~ species * seabird_level)
pairs(EMM, simple = "seabird_level")
test(pairs(EMM, by = "species"), by = NULL, adjust = "mvt")
test(pairs(EMM, by = "species"), by = NULL, adjust = "none")
test(pairs(EMM, by = "species"), adjust = "tukey", cross.adjust = "bonferroni")
#nothing actually "significant" (or really even close) but trends definitely there*

confint(pairs(EMM, by = "species"), by = NULL, adjust = "none", level = 0.75, interval = c("confidence"))
#same as above, because by species

emm.summary.sb.fishn15<-
seabird_fish_n15_levels_mod1r %>% 
  emmeans(~ seabird_level|species) 
emm.summary.sb.fishn15


emmeans(seabird_fish_n15_levels_mod1r, ~seabird_level) %>% test()
emmeans(seabird_fish_n15_levels_mod1r, ~seabird_level|species)
#low is consistently lower n15 than mid and high, but wide CIs so not statistically significant

contrast(emmeans(seabird_fish_n15_levels_mod1r, ~seabird_level))

```


#try comparing to algae N15 at 40 m, because that's where excpect n15 in fish to be coming from....
```{r}
fishn15.seabirds.cond

algae_n15<-read.csv("../output/n15_seabirds_combined_no_iti.csv")
algae_n15

fishn15.seabirds.cond.algae<-
  left_join(fishn15.seabirds.cond, 
            select(algae_n15, c("site.name", "N.15_at_10m", "N.15_at_20m","N.15_at_30m","N.15_at_40m")), 
            by = "site.name")
fishn15.seabirds.cond.algae


#quick plots----
fishn15.seabirds.cond.algae%>%
  group_by(species, N.15_at_40m)%>%
  summarize(mean_n15 = mean(n15),
            n_n15 = length(n15),
            se_n15 = sd(n15)/sqrt(n_n15))%>%
  ggplot(aes(x = N.15_at_40m, y = mean_n15, color = species, fill = species, group = species))+
  geom_point(alpha = .5)+
  geom_errorbar(aes(ymin = (mean_n15-se_n15), ymax = (mean_n15+se_n15)), alpha = .5, width = 0)+
  geom_line(alpha = .5)+
  theme_bw() 
#looks good, but weird because no 40 m for one side of Aie


fishn15.seabirds.cond.algae%>%
  group_by(species, N.15_at_30m)%>%
  summarize(mean_n15 = mean(n15),
            n_n15 = length(n15),
            se_n15 = sd(n15)/sqrt(n_n15))%>%
  ggplot(aes(x = N.15_at_30m, y = mean_n15, color = species, fill = species, group = species))+
  geom_point(alpha = .5)+
  geom_errorbar(aes(ymin = (mean_n15-se_n15), ymax = (mean_n15+se_n15)), alpha = .5, width = 0)+
  geom_line(alpha = .5)+
  theme_bw() 
#now a bit messier....


#simple model:---
seabird_fish_n15_algae_mod1r<-lmer(n15~ N.15_at_40m*species + (1|site.name), 
                          data = fishn15.seabirds.cond.algae)
summary(seabird_fish_n15_algae_mod1r)
Anova(seabird_fish_n15_algae_mod1r)
plot_summs(seabird_fish_n15_algae_mod1r)


seabird_fish_n15_algae_mod2r<-lmer(n15~ N.15_at_30m*species + (1|site.name), 
                          data = fishn15.seabirds.cond.algae)
summary(seabird_fish_n15_algae_mod2r)
Anova(seabird_fish_n15_algae_mod2r)
plot_summs(seabird_fish_n15_algae_mod2r)

#looks like strongest effect for Ab. sept.


#use emmeans to figure out what's happening:
seabird_fish_n15_algae_mod2r %>% 
  emmeans(~ species, var = "N.15_at_30m") 

seabird_fish_n15_algae_mod2r %>% 
emtrends(pairwise ~ species, var = "N.15_at_30m")

# plot
range(fishn15.seabirds.cond.algae$N.15_at_30m)
levels(fishn15.seabirds$species)
(mylist <- list(
    N.15_at_30m = seq(3, 7, by = 2),
    species = c("Abudefduf septemfasciatus", "Acanthurus triostegus" ,    "Cephalopholis argus"   ,    "Lutjanus fulvus"     ,     
 "Stegastes nigricans")
))

emmip(seabird_fish_n15_algae_mod2r, species ~ N.15_at_30m, at = mylist, CIs = TRUE)


#more emmeans
emtrends(seabird_fish_n15_algae_mod2r,  ~ species, var = "N.15_at_30m")

emmip(seabird_fish_n15_algae_mod2r, species ~ N.15_at_30m, cov.reduce = range)
#by far strongest trend for Ab. sept, everything else is only weakly positive


emtrends(seabird_fish_n15_algae_mod1r,  ~ species, var = "N.15_at_40m")
#same as above, but wider CIs probably because fewer data ponits...

```




