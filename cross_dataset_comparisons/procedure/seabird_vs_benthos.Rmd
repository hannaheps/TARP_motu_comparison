---
title: "seabirds_vs_benthos"
author: "CEB"
date: '2023-09-29'
output: html_document
---

#load packages
```{r}
library(tidyverse)

library(lme4)
library(car)
library(jtools)

library(emmeans)

library(corrplot)

library(vegan)


#if want pairwise adonis:
#install.packages('devtools')
#library(devtools)
#install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis") library(pairwise.adonis)

```


#load data
```{r}
seabirds <- read.csv("../output/n15_seabirds_combined_no_iti.csv", strip.white = T, header = T)
load("../../fish_benthic_surveys/output/data/benthic_community_data.Rdata")

benthic_vid<-tet_video_div_comm_dat_w_cover
benthic_situ<-tet_insitu_div_comm_dat_w_cover

```




#start with video data-----------
#merge data
```{r}
benthic_vid

#make combined site name column in benthic data
benthic_vid_dat<-
  benthic_vid%>%
  mutate(motu = str_to_title(motu),
         protection = str_to_title(protection))%>%
  unite("site.name", c(motu, protection), sep = "_", remove = FALSE)

benthic_vid_dat

benthic.vid.seabirds<-left_join(benthic_vid_dat,
                            select(seabirds, c("site.name", "breeding_biomass_kgha_side")), 
                                   by = "site.name")%>%
  mutate(site.name = as.factor(site.name))
benthic.vid.seabirds

```

##add seabird levels and algae n15 to data
```{r}
#add levels to data----
benthic.vid.seabirds.levels<-
  benthic.vid.seabirds%>%
    mutate(seabird_level = case_when(breeding_biomass_kgha_side<10 ~"low",
                                   breeding_biomass_kgha_side>10&breeding_biomass_kgha_side <200 ~"mid",
                                   breeding_biomass_kgha_side>200 ~"high"))%>%
  mutate(seabird_level = as.factor(seabird_level))%>%
  mutate(seabird_level = fct_relevel(seabird_level, "low", "mid", "high"))


#now add algae n15:----
algae_n15<-read.csv("../output/n15_seabirds_combined_no_iti.csv")
algae_n15


benthic.vid.seabirds.levels.algae<-left_join(benthic.vid.seabirds.levels, 
                                            select(algae_n15, c("site.name", "N.15_at_10m",  "N.15_at_20m", "N.15_at_30m", "N.15_at_40m")),
                                            by = "site.name")

benthic.vid.seabirds.levels.algae


```


#do some quick plots of data:
```{r}

benthic.vid.seabirds.levels.algae%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = hard_coral_percent_cover))+
  geom_point()+
  geom_smooth(method = "lm")

benthic.vid.seabirds.levels.algae%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = macroalgae_percent_cover))+
  geom_point()+
  geom_smooth(method = "lm")

benthic.vid.seabirds.levels.algae%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = macroalgae_percent_cover))+
  geom_point()+
  geom_smooth(method = "lm")


benthic.vid.seabirds.levels.algae%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = coral_shannon))+
  geom_point()+
  geom_smooth(method = "lm")



##stacked bar plot
benthic.vid.seabirds.levels.algae%>%
  select(-c(total_percent_cover))%>%
  pivot_longer(cols = ends_with("_percent_cover"),
                                          names_to = "group",
                                          values_to = "percent_cover")%>%
  mutate(group = str_remove(group, '_percent_cover'))%>%
  group_by(group, site.name)%>%
  summarize(mean_percent_cover = mean(percent_cover))%>%
  ggplot(aes(fill = group, y = mean_percent_cover, x = site.name))+
  geom_bar(position = "stack", stat =  "identity")

#doesn't look like much happening....

#limit stacked bar to major groups, and do by seabird level rather than site: 
benthic_vid_stack_barplot_seabird_level<-
benthic.vid.seabirds.levels.algae%>%
  select(-c(total_percent_cover, transect_tape_percent_cover, cca_percent_cover, dead_coral_percent_cover, 
            other_fish_inverts_percent_cover))%>%
  pivot_longer(cols = ends_with("_percent_cover"),
                                          names_to = "group",
                                          values_to = "percent_cover")%>%
  mutate(group = str_remove(group, '_percent_cover'))%>%
  group_by(group, seabird_level)%>%
  summarize(mean_percent_cover = mean(percent_cover))%>%
  mutate(group = as.factor(group))%>%
  mutate(group = fct_relevel(group, c("hard_coral", "macroalgae", "pavement", "rubble", "sand")))%>%
  ggplot(aes(fill = group, y = mean_percent_cover, x = seabird_level))+
  geom_bar(position = "stack", stat =  "identity")+
  scale_fill_brewer(palette = "Set2")+
  xlab("Seabird level")+
  ylab("% cover")+
    theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)
        )
  
  benthic_vid_stack_barplot_seabird_level

  
#ggsave(benthic_vid_stack_barplot_seabird_level, file = "../output/seabird-benthic/benthic_vid_stack_barplot_seabird_level.jpg",
#       width = 7, height = 5)
#

  
  
benthic.vid.seabirds.levels.algae%>%
 # select(-c(total_percent_cover, transect_tape_percent_cover, cca_percent_cover, dead_coral_percent_cover, 
  #          other_fish_inverts_percent_cover))%>%
  pivot_longer(cols = ends_with("_percent_cover"),
                                          names_to = "group",
                                          values_to = "percent_cover")%>%
  mutate(group = str_remove(group, '_percent_cover'))%>%
  group_by(group, seabird_level)%>%
  summarize(mean_percent_cover = mean(percent_cover))
  
```




##do NMDS with algae n15 as overlay
```{r}
#create data - all groups-----
tet_video_raw_meta_broad_sp_all<-
  benthic.vid.seabirds.levels.algae%>%
  ungroup()%>%
  select(hard_coral_percent_cover:macroalgae_percent_cover)
tet_video_raw_meta_broad_sp_all

#create data - remove rare groups-----
colSums(tet_video_raw_meta_broad_sp_all)

#count 0s
tet_video_raw_meta_broad_sp_all %>% 
#  group_by(site.name) %>% 
  summarize(n = n(),
            across(-n, ~sum(is.na(.) | . == 0)))

#count >1%
tet_video_raw_meta_broad_sp_all %>% 
#  group_by(site.name) %>% 
  summarize(n = n(),
            across(-n, ~sum(is.na(.) | . >1)))
#only time fish/inverts > 1% = 1.09% (so still close to 1, and not > 1 at any one site***)


tet_video_raw_meta_broad_sp<-
  benthic.vid.seabirds.levels.algae%>%
  ungroup()%>%
  select(hard_coral_percent_cover:macroalgae_percent_cover)%>%
  select(-c(cca_percent_cover, dead_coral_percent_cover, 
            other_fish_inverts_percent_cover))
tet_video_raw_meta_broad_sp

#run nmds----
nmds_video<-metaMDS(tet_video_raw_meta_broad_sp, distance = "bray", trymax=200, k=2, autotransform = FALSE)
nmds_video
#2 axes stress = 0.06113269, so all good

plot(nmds_video)
scores(nmds_video, display="species")


#look at plot and centroids with ordfit
plot(nmds_video)
ord.fit.level<-envfit(nmds_video~seabird_level+protection, data = benthic.vid.seabirds.levels.algae, na.rm=TRUE)
ord.fit.level 
plot(ord.fit.level)

plot(nmds_video)
ord.fit.algae<-envfit(nmds_video~N.15_at_30m+protection, data = benthic.vid.seabirds.levels.algae, na.rm=TRUE)
ord.fit.algae 
plot(ord.fit.algae)



#rotate by algae n15 so can more easily interpret----
nmds_video.rotate<-MDSrotate(nmds_video, benthic.vid.seabirds.levels.algae$N.15_at_30m)
nmds_video.rotate
plot(nmds_video.rotate)

ord.fit<-envfit(nmds_video.rotate~N.15_at_30m+protection, data = benthic.vid.seabirds.levels.algae, na.rm=TRUE)
ord.fit #p and r^2 are identical, just rotated so all with NMDS1 now.


##extract site/transect scores (non-rotated)----
video_spp.sc <- as.data.frame(scores(nmds_video, "species")) %>% #Using the scores function from vegan to extract the species scores and convert to a data.frame
  rownames_to_column(var="Species") %>% # create a column of species, from the rownames of species.scores
  mutate(Species = str_remove(Species, '_percent_cover'))%>%
  mutate(Species = str_replace(Species,  "_", " "))%>%
  mutate(Species= str_replace(Species,  "_", "/"))

video_spp.sc

video_site.sc <- scores(nmds_video, display = "sites", shrink = FALSE) 
video_site.sc

#merge site.sc with site and transect
nmds_video_site_scores<-
  bind_cols(benthic.vid.seabirds.levels.algae$site.name, benthic.vid.seabirds.levels.algae$transect,
                    as_tibble(video_site.sc))%>%
  rename('site.name' = '...1', 'transect' = '...2')
nmds_video_site_scores

#combine with other metadata:
benthic.vid.seabirds.levels.algae.w.nmds.norotate<-
 left_join(select(benthic.vid.seabirds.levels.algae, -c("Distance_to_centroid", "NMDS1", "NMDS2")), #remove old nmds from before combined with seabird and algae data
           nmds_video_site_scores, 
             by = c("site.name", "transect"))
benthic.vid.seabirds.levels.algae.w.nmds.norotate


##extract site/transect scores (rotated)----
video_spp.sc.rotate <- as.data.frame(scores(nmds_video.rotate, "species")) %>% #Using the scores function from vegan to extract the species scores and convert
  rownames_to_column(var="Species") %>% # create a column of species, from the rownames of species.scores
  mutate(Species = str_remove(Species, '_percent_cover'))%>%
  mutate(Species = str_replace(Species,  "_", " "))%>%
  mutate(Species= str_replace(Species,  "_", "/"))
video_spp.sc.rotate

video_site.sc.rotate <- scores(nmds_video.rotate, display = "sites", shrink = FALSE) 
video_site.sc.rotate

#merge site.sc with site and transect
nmds_video_site_scores_rotate<-
  bind_cols(benthic.vid.seabirds.levels.algae$site.name, benthic.vid.seabirds.levels.algae$transect,
                    as_tibble(video_site.sc.rotate))%>%
  rename('site.name' = '...1', 'transect' = '...2')
nmds_video_site_scores_rotate


#combine with other metadata:
benthic.vid.seabirds.levels.algae.w.nmds<-
 left_join(benthic.vid.seabirds.levels.algae.w.nmds.norotate,
           nmds_video_site_scores_rotate, 
             by = c("site.name", "transect")) %>%
             rename("NMDS1" = "NMDS1.x",
                    "NMDS2" = "NMDS2.x",
                    "NMDS1.rotate" = "NMDS1.y",
                    "NMDS2.rotate" = "NMDS2.y")
benthic.vid.seabirds.levels.algae.w.nmds

#NMDS plots - non-rotated:----
#get hull data - seabird level:
sb.low <- benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == "low", ][chull(benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == 
    "low", c("NMDS1", "NMDS2")]), ]

sb.mid <- benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == "mid", ][chull(benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == 
    "mid", c("NMDS1", "NMDS2")]), ]

sb.high <- benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == "high", ][chull(benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == 
    "high", c("NMDS1", "NMDS2")]), ]

hull.data.vid <- rbind(sb.low, sb.mid, sb.high)  #combine
hull.data.vid


##get arrows:
ord.fit.vid<-envfit(nmds_video ~ N.15_at_30m + wind.exposure, data = benthic.vid.seabirds.levels.algae.w.nmds, na.rm=TRUE)
ord.fit.vid #looks like seabird level is marginal

sb.scrs.vid <- as.data.frame(scores(ord.fit.vid, display = "vectors"))
sb.scrs.vid <- cbind(sb.scrs.vid, variable = rownames(sb.scrs.vid))
sb.scrs.vid<-
  sb.scrs.vid%>%
  mutate(variable2 = c("algae n15"))


benthic_video_nmds_plot<-
ggplot() + 
  geom_text(data=video_spp.sc,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .7, size = 3, hjust = .1) +  # add the species labels - 
  geom_point(data=benthic.vid.seabirds.levels.algae.w.nmds,aes(x=NMDS1,y=NMDS2,colour=seabird_level, fill = seabird_level, pch = seabird_level), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data.vid,aes(x=NMDS1,y=NMDS2,fill=seabird_level,group=seabird_level),alpha=0.30) + # add the convex hulls
 #   coord_fixed() + ## need aspect ratio of 1!
  scale_fill_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+ #low-mid-high = red-yellow-green
    scale_colour_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+#low-mid-high = red-yellow-green
  geom_segment(data = sb.scrs.vid,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm"))) +
    geom_text(data = sb.scrs.vid, aes(x = NMDS1, y = NMDS2, label = sb.scrs.vid$variable2),
            size = 3, vjust = "outward")+
labs(colour = "Seabird biomass", fill = "Seabird biomass", shape = "Seabird biomass")+
theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2, .88)) 

benthic_video_nmds_plot


#save plot
#ggsave(benthic_video_nmds_plot, file = "../output/seabird-benthic/benthic_video_nmds_plot.jpg",
#       width = 7, height = 5)

##


#NMDS plots - rotated:----
#get hull data - seabird level:
sb.low.rotate <- benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == "low", ][chull(benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == 
    "low", c("NMDS1.rotate", "NMDS2.rotate")]), ]

sb.mid.rotate <- benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == "mid", ][chull(benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == 
    "mid", c("NMDS1.rotate", "NMDS2.rotate")]), ]

sb.high.rotate <- benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == "high", ][chull(benthic.vid.seabirds.levels.algae.w.nmds[benthic.vid.seabirds.levels.algae.w.nmds$seabird_level == 
    "high", c("NMDS1.rotate", "NMDS2.rotate")]), ]

hull.data.vid.rotate <- rbind(sb.low.rotate, sb.mid.rotate, sb.high.rotate)  #combine
hull.data.vid.rotate


##get arrows:
ord.fit.vid.rotate<-envfit(nmds_video.rotate ~ N.15_at_30m + wind.exposure, data = benthic.vid.seabirds.levels.algae.w.nmds, na.rm=TRUE)
ord.fit.vid.rotate #looks like seabird level is marginal

sb.scrs.vid.rotate <- as.data.frame(scores(ord.fit.vid.rotate, display = "vectors"))
sb.scrs.vid.rotate <- cbind(sb.scrs.vid.rotate, variable = rownames(sb.scrs.vid.rotate))
sb.scrs.vid.rotate<-
  sb.scrs.vid.rotate%>%
  mutate(variable2 = c("algae n15"))


benthic_video_nmds_plot_rotate<-
ggplot() + 
  geom_point(data=benthic.vid.seabirds.levels.algae.w.nmds,aes(x=NMDS1.rotate,y=NMDS2.rotate,colour=seabird_level, fill = seabird_level, pch = seabird_level), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data.vid.rotate,aes(x=NMDS1.rotate,y=NMDS2.rotate,fill=seabird_level,group=seabird_level),alpha=0.30) + # add the convex hulls
  #  coord_fixed() + ## need aspect ratio of 1!
  scale_fill_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+ #low-mid-high = red-yellow-green
    scale_colour_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+#low-mid-high = red-yellow-green
  geom_segment(data = sb.scrs.vid.rotate,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm"))) +
    geom_text(data = sb.scrs.vid.rotate, aes(x = NMDS1, y = NMDS2, label = sb.scrs.vid.rotate$variable2),
            size = 3, hjust = "outward")+
    geom_text(data=video_spp.sc.rotate,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .5, size = 3, hjust = .1) +  # add the species labels -
  xlab("NMDS1")+
  ylab("NMDS2")+
labs(colour = "seabird biomass", fill = "seabird biomass", shape = "seabird biomass")+
theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
          legend.position = c(.14, .87),
       legend.background = element_blank()
     )

benthic_video_nmds_plot_rotate


#save plot
ggsave(benthic_video_nmds_plot_rotate, file = "../output/seabird-benthic/benthic_video_nmds_plot_rotate.jpg",
    width = 7, height = 5)



```



#repeat with in situ---------
#merge data
```{r}
benthic_situ

#make combined site name column in benthic data
benthic_situ_dat<-
  benthic_situ%>%
  mutate(protection = if_else(wind.exposure == "leeward", "Protected", "Exposed"))%>%
  mutate(motu = str_to_title(motu),
         protection = str_to_title(protection))%>%
  unite("site.name", c(motu, protection), sep = "_", remove = FALSE)%>%
  relocate(protection, .after = "wind.exposure")


benthic.situ.seabirds<-left_join(benthic_situ_dat,
                            select(seabirds, c("site.name", "breeding_biomass_kgha_side")), 
                                   by = "site.name")%>%
  mutate(site.name = as.factor(site.name))
benthic.situ.seabirds

```



##add seabird levels and algae n15 to data
```{r}
#add levels to data----
benthic.situ.seabirds.levels<-
  benthic.situ.seabirds%>%
    mutate(seabird_level = case_when(breeding_biomass_kgha_side<10 ~"low",
                                   breeding_biomass_kgha_side>10&breeding_biomass_kgha_side <200 ~"mid",
                                   breeding_biomass_kgha_side>200 ~"high"))%>%
  mutate(seabird_level = as.factor(seabird_level))%>%
  mutate(seabird_level = fct_relevel(seabird_level, "low", "mid", "high"))


#now add algae n15:
algae_n15
benthic.situ.seabirds.levels.algae<-left_join(benthic.situ.seabirds.levels, 
                                            select(algae_n15, c("site.name", "N.15_at_10m",  "N.15_at_20m", "N.15_at_30m", "N.15_at_40m")),
                                            by = "site.name")

benthic.situ.seabirds.levels.algae

```






#do some quick plots of data:
```{r}

benthic.situ.seabirds.levels.algae%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = coral_percent_cover))+
  geom_point()+
  geom_smooth(method = "lm")

benthic.situ.seabirds.levels.algae%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = macroalgae_percent_cover))+
  geom_point()+
  geom_smooth(method = "lm")


benthic.situ.seabirds.levels.algae%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = coral_shannon))+
  geom_point()+
  geom_smooth(method = "lm")



##stacked bar plot
benthic.situ.seabirds.levels.algae%>%
  pivot_longer(cols = ends_with("_percent_cover"),
                                          names_to = "group",
                                          values_to = "percent_cover")%>%
  mutate(group = str_remove(group, '_percent_cover'))%>%
  group_by(group, site.name)%>%
  summarize(mean_percent_cover = mean(percent_cover))%>%
  ggplot(aes(fill = group, y = mean_percent_cover, x = site.name))+
  geom_bar(position = "stack", stat =  "identity")

#doesn't look like much happening....

#limit stacked bar to most interesting groups, and do by seabird level rather than site: 
benthic_situ_stack_barplot_seabird_level<-
benthic.situ.seabirds.levels.algae%>%
  select(-c(cyano_percent_cover, other_invert_percent_cover))%>%
  pivot_longer(cols = ends_with("_percent_cover"),
                                          names_to = "group",
                                          values_to = "percent_cover")%>%
  mutate(group = str_remove(group, '_percent_cover'))%>%
  group_by(group, seabird_level)%>%
  summarize(mean_percent_cover = mean(percent_cover))%>%
  mutate(group = as.factor(group))%>%
  mutate(group = fct_relevel(group, c("coral", "macroalgae", "pavement", "rubble", "sand")))%>%
  ggplot(aes(fill = group, y = mean_percent_cover, x = seabird_level))+
  geom_bar(position = "stack", stat =  "identity")+
  scale_fill_brewer(palette = "Set2")+
  xlab("Seabird level")+
  ylab("% cover")+
    theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)
        )
  
benthic_situ_stack_barplot_seabird_level

  
#ggsave(benthic_situ_stack_barplot_seabird_level, file = "../output/seabird-benthic/benthic_situ_stack_barplot_seabird_level.jpg",
#       width = 7, height = 5)



benthic.situ.seabirds.levels.algae%>%
 # select(-c(total_percent_cover, transect_tape_percent_cover, cca_percent_cover, dead_coral_percent_cover, 
  #          other_fish_inverts_percent_cover))%>%
  pivot_longer(cols = ends_with("_percent_cover"),
                                          names_to = "group",
                                          values_to = "percent_cover")%>%
  mutate(group = str_remove(group, '_percent_cover'))%>%
  group_by(group, seabird_level)%>%
  summarize(mean_percent_cover = mean(percent_cover))


```



##do NMDS with algae n15 as overlay
```{r}

#create data - all groups-----
tet_situ_raw_meta_broad_sp_all<-
  benthic.situ.seabirds.levels.algae%>%
  ungroup()%>%
  select(coral_percent_cover:cyano_percent_cover)
tet_situ_raw_meta_broad_sp_all

#create data - remove rare groups-----
tet_situ_raw_meta_broad_sp<-
  benthic.situ.seabirds.levels.algae%>%
  ungroup()%>%
  select(coral_percent_cover:cyano_percent_cover)%>%
  select(-c(cyano_percent_cover, other_invert_percent_cover))
tet_situ_raw_meta_broad_sp

#run nmds----
nmds_situ<-metaMDS(tet_situ_raw_meta_broad_sp, distance = "bray", trymax=200, k=2, autotransform = FALSE)
nmds_situ
#2 axes stress = 0.07541151, so all good

plot(nmds_situ)
scores(nmds_situ, display="species")


#look at plot and centroids with ordfit
plot(nmds_situ)
ord.fit.level<-envfit(nmds_situ~seabird_level+protection, data = benthic.situ.seabirds.levels.algae, na.rm=TRUE)
ord.fit.level 
plot(ord.fit.level)

plot(nmds_situ)
ord.fit.algae<-envfit(nmds_situ~N.15_at_30m+protection, data = benthic.situ.seabirds.levels.algae, na.rm=TRUE)
ord.fit.algae 
plot(ord.fit.algae)



#rotate by algae n15 so can more easily interpret----
nmds_situ.rotate<-MDSrotate(nmds_situ, benthic.situ.seabirds.levels.algae$N.15_at_30m)
nmds_situ.rotate
plot(nmds_situ.rotate)

ord.fit<-envfit(nmds_situ.rotate~N.15_at_30m+protection, data = benthic.situ.seabirds.levels.algae, na.rm=TRUE)
ord.fit #p and r^2 are close, just rotated so all with NMDS1 now.


##extract site/transect scores (non-rotated)----
situ_spp.sc <- as.data.frame(scores(nmds_situ, "species")) %>% #Using the scores function from vegan to extract the species scores and convert to a data.frame
  rownames_to_column(var="Species") %>% # create a column of species, from the rownames of species.scores
  mutate(Species = str_remove(Species, '_percent_cover'))%>%
  mutate(Species = str_replace(Species,  "_", " "))%>%
  mutate(Species= str_replace(Species,  "_", "/"))

situ_spp.sc

situ_site.sc <- scores(nmds_situ, display = "sites", shrink = FALSE) 
situ_site.sc

#merge site.sc with site and transect
nmds_situ_site_scores<-
  bind_cols(benthic.situ.seabirds.levels.algae$site.name, benthic.situ.seabirds.levels.algae$transect,
                    as_tibble(situ_site.sc))%>%
  rename('site.name' = '...1', 'transect' = '...2')
nmds_situ_site_scores

#combine with other metadata:
benthic.situ.seabirds.levels.algae.w.nmds.norotate<-
 left_join(select(benthic.situ.seabirds.levels.algae, -c("Distance_to_centroid", "NMDS1", "NMDS2")), #remove old nmds from before combined with seabird and algae data
           nmds_situ_site_scores, 
             by = c("site.name", "transect"))
benthic.situ.seabirds.levels.algae.w.nmds.norotate


##extract site/transect scores (rotated)----
situ_spp.sc.rotate <- as.data.frame(scores(nmds_situ.rotate, "species")) %>% #Using the scores function from vegan to extract the species scores and convert
  rownames_to_column(var="Species") %>% # create a column of species, from the rownames of species.scores
  mutate(Species = str_remove(Species, '_percent_cover'))%>%
  mutate(Species = str_replace(Species,  "_", " "))%>%
  mutate(Species= str_replace(Species,  "_", "/"))%>%
  mutate(Species = fct_recode(Species,  "hard coral" = "coral")) #make match video name
situ_spp.sc.rotate

situ_site.sc.rotate <- scores(nmds_situ.rotate, display = "sites", shrink = FALSE) 
situ_site.sc.rotate

#merge site.sc with site and transect
nmds_situ_site_scores_rotate<-
  bind_cols(benthic.situ.seabirds.levels.algae$site.name, benthic.situ.seabirds.levels.algae$transect,
                    as_tibble(situ_site.sc.rotate))%>%
  rename('site.name' = '...1', 'transect' = '...2')
nmds_situ_site_scores_rotate


#combine with other metadata:
benthic.situ.seabirds.levels.algae.w.nmds<-
 left_join(benthic.situ.seabirds.levels.algae.w.nmds.norotate,
           nmds_situ_site_scores_rotate, 
             by = c("site.name", "transect")) %>%
             rename("NMDS1" = "NMDS1.x",
                    "NMDS2" = "NMDS2.x",
                    "NMDS1.rotate" = "NMDS1.y",
                    "NMDS2.rotate" = "NMDS2.y")
benthic.situ.seabirds.levels.algae.w.nmds

#NMDS plots - non-rotated:----
#get hull data - seabird level:
sb.low <- benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == "low", ][chull(benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == 
    "low", c("NMDS1", "NMDS2")]), ]

sb.mid <- benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == "mid", ][chull(benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == 
    "mid", c("NMDS1", "NMDS2")]), ]

sb.high <- benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == "high", ][chull(benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == 
    "high", c("NMDS1", "NMDS2")]), ]

hull.data.situ <- rbind(sb.low, sb.mid, sb.high)  #combine
hull.data.situ


##get arrows:
ord.fit.situ<-envfit(nmds_situ ~ N.15_at_30m + wind.exposure, data = benthic.situ.seabirds.levels.algae.w.nmds, na.rm=TRUE)
ord.fit.situ #looks like seabird level is marginal

sb.scrs.situ <- as.data.frame(scores(ord.fit.situ, display = "vectors"))
sb.scrs.situ <- cbind(sb.scrs.situ, variable = rownames(sb.scrs.situ))
sb.scrs.situ<-
  sb.scrs.situ%>%
  mutate(variable2 = c("algae n15"))


benthic_situ_nmds_plot<-
ggplot() + 
  geom_text(data=situ_spp.sc,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .7, size = 3, hjust = .1) +  # add the species labels - 
  geom_point(data=benthic.situ.seabirds.levels.algae.w.nmds,aes(x=NMDS1,y=NMDS2,colour=seabird_level, fill = seabird_level, pch = seabird_level), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data.situ,aes(x=NMDS1,y=NMDS2,fill=seabird_level,group=seabird_level),alpha=0.30) + # add the convex hulls
  #  coord_fixed() + ## need aspect ratio of 1!
  geom_segment(data = sb.scrs.situ,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm"))) +
    geom_text(data = sb.scrs.situ, aes(x = NMDS1, y = NMDS2, label = sb.scrs.situ$variable2),
            size = 3, vjust = "outward")+
   scale_fill_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+ #low-mid-high = red-yellow-green
    scale_colour_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+#low-mid-high = red-yellow-green
labs(colour = "seabird biomass", fill = "seabird biomass", shape = "seabird biomass")+
theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.88, .2)) 

benthic_situ_nmds_plot


#save plot
#ggsave(benthic_situ_nmds_plot, file = "../output/seabird-benthic/benthic_situ_nmds_plot.jpg",
#       width = 7, height = 5)

##


#NMDS plots - rotated:----
#get hull data - seabird level:
sb.low.rotate <- benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == "low", ][chull(benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == 
    "low", c("NMDS1.rotate", "NMDS2.rotate")]), ]

sb.mid.rotate <- benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == "mid", ][chull(benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == 
    "mid", c("NMDS1.rotate", "NMDS2.rotate")]), ]

sb.high.rotate <- benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == "high", ][chull(benthic.situ.seabirds.levels.algae.w.nmds[benthic.situ.seabirds.levels.algae.w.nmds$seabird_level == 
    "high", c("NMDS1.rotate", "NMDS2.rotate")]), ]

hull.data.situ.rotate <- rbind(sb.low.rotate, sb.mid.rotate, sb.high.rotate)  #combine
hull.data.situ.rotate


##get arrows:
ord.fit.situ.rotate<-envfit(nmds_situ.rotate ~ N.15_at_30m + wind.exposure, data = benthic.situ.seabirds.levels.algae.w.nmds, na.rm=TRUE)
ord.fit.situ.rotate #looks like seabird level is marginal

sb.scrs.situ.rotate <- as.data.frame(scores(ord.fit.situ.rotate, display = "vectors"))
sb.scrs.situ.rotate <- cbind(sb.scrs.situ.rotate, variable = rownames(sb.scrs.situ.rotate))
sb.scrs.situ.rotate<-
  sb.scrs.situ.rotate%>%
  mutate(variable2 = c("algae n15"))


benthic_situ_nmds_plot_rotate<-
ggplot() + 
  geom_point(data=benthic.situ.seabirds.levels.algae.w.nmds,aes(x=NMDS1.rotate,y=NMDS2.rotate,colour=seabird_level, fill = seabird_level, pch = seabird_level), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data.situ.rotate,aes(x=NMDS1.rotate,y=NMDS2.rotate,fill=seabird_level,group=seabird_level),alpha=0.30) + # add the convex hulls
  #  coord_fixed() + ## need aspect ratio of 1!
  geom_segment(data = sb.scrs.situ.rotate,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm"))) +
    geom_text(data = sb.scrs.situ.rotate, aes(x = NMDS1, y = NMDS2, label = sb.scrs.situ.rotate$variable2),
            size = 3, hjust = "inward", vjust = "inward")+
    geom_text(data=situ_spp.sc.rotate,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .5, size = 3, hjust = .1) +  # add the species labels - 
   scale_fill_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+ #low-mid-high = red-yellow-green
    scale_colour_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+#low-mid-high = red-yellow-green
  labs(colour = "seabird biomass", fill = "seabird biomass", shape = "seabird biomass")+
  xlab("NMDS")+
  ylab("NMDS")+
theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank()
     ) #   legend.position = c(.2, .88)

benthic_situ_nmds_plot_rotate


#save plot
ggsave(benthic_situ_nmds_plot_rotate, file = "../output/seabird-benthic/benthic_situ_nmds_plot_rotate.jpg",
    width = 7, height = 5)



```


#COMBINE NMDS PLOTS-----
```{r}
library(cowplot)

benthic_nmds_plots<-plot_grid(benthic_video_nmds_plot_rotate, benthic_situ_nmds_plot_rotate, nrow = 2,
  labels = c("a. video", "b. in situ"), label_x = c(.05, .05), label_y = c(.99, .99), label_fontface = "plain")
benthic_nmds_plots


ggsave(benthic_nmds_plots, file = "../output/seabird-benthic/benthic_COMBINED_nmds_plot_rotate.jpg",
    width = 7, height = 7)


```

#COMBINE STACKED BAR PLOTS-----
```{r}
benthic_vid_stack_barplot_seabird_level
benthic_situ_stack_barplot_seabird_level

benthic_stack_plots<-plot_grid(benthic_vid_stack_barplot_seabird_level, benthic_situ_stack_barplot_seabird_level, nrow = 2,
  labels = c("a. video", "b. in situ"), label_x = c(.02, .02), label_y = c(1, 1), label_fontface = "plain")
benthic_stack_plots


ggsave(benthic_stack_plots, file = "../output/seabird-benthic/benthic_stack_plots_COMBINED.jpg",
    width = 7, height = 7)


```



#Run PERMANOVA----
```{r}

#video - full community---
#run analysis
permanova_benthic_situ_seabird<-adonis2(tet_video_raw_meta_broad_sp_all ~ seabird_level  + protection,  data = benthic.vid.seabirds.levels.algae, by = "margin", permutations = 999)
permanova_benthic_situ_seabird
#              Df SumOfSqs      R2      F Pr(>F)  
#seabird_level  2  0.12468 0.17972 2.2962  0.063 .
#protection     1  0.02608 0.03759 0.9605  0.409  
#Residual      20  0.54299 0.78269                
#Total         23  0.69375 1.00000        

#seabird level marginal. increased permutations to check - decide # to use.


permanova_benthic_situ_seabird<-adonis2(tet_video_raw_meta_broad_sp_all ~ seabird_level  + protection,  data = benthic.vid.seabirds.levels.algae)
permanova_benthic_situ_seabird


permanova_benthic_situ_n15<-adonis2(tet_video_raw_meta_broad_sp_all ~ N.15_at_30m  + protection,  data = benthic.vid.seabirds.levels.algae)
permanova_benthic_situ_n15
#              Df SumOfSqs      R2      F Pr(>F)  
#N.15_at_30m  1  0.00820 0.01182 0.2568  0.833
#protection   1  0.01495 0.02154 0.4680  0.664
#Residual    21  0.67060 0.96664              
#Total       23  0.69375 1.00000         

#nothing significant



##video- remove rare groups-----
permanova_benthic_situ_seabird_no_rare<-adonis2(tet_video_raw_meta_broad_sp ~ seabird_level  + protection,  data = benthic.vid.seabirds.levels.algae)
permanova_benthic_situ_seabird_no_rare
#              Df SumOfSqs      R2      F Pr(>F)  
#seabird_level  2  0.12314 0.18010 2.3029  0.066 .
#protection     1  0.02588 0.03785 0.9679  0.395  
#Residual      20  0.53470 0.78205                
#Total         23  0.68371 1.00000        

#same result as above - seabird level marginal

permanova_benthic_situ_n15_no_rare<-adonis2(tet_video_raw_meta_broad_sp ~ N.15_at_30m  + protection,  data = benthic.vid.seabirds.levels.algae)
permanova_benthic_situ_n15_no_rare
#            Df SumOfSqs      R2      F Pr(>F)
#N.15_at_30m  1  0.00527 0.00771 0.1675  0.881
#protection   1  0.01459 0.02134 0.4634  0.659
#Residual    21  0.66109 0.96692              
#Total       23  0.68371 1.00000  

#same results as above - nothing significant

#situ - full community---
#run analysis
permanova_benthic_situ_seabird<-adonis2(tet_situ_raw_meta_broad_sp_all ~ seabird_level  + protection,  data = benthic.vid.seabirds.levels.algae)
permanova_benthic_situ_seabird
#              Df SumOfSqs      R2      F Pr(>F)  
#seabird_level  2  0.31961 0.28361 4.2272  0.005 **
#protection     1  0.07578 0.06724 2.0045  0.118   
#Residual      20  0.75608 0.67090                 
#Total         23  1.12695 1.00000              

#seabird level very significant.


permanova_benthic_situ_n15<-adonis2(tet_situ_raw_meta_broad_sp_all ~ N.15_at_30m  + protection,  data = benthic.vid.seabirds.levels.algae)
permanova_benthic_situ_n15
#              Df SumOfSqs      R2      F Pr(>F)  
#N.15_at_30m  1  0.06415 0.05692 1.3318  0.263
#protection   1  0.04594 0.04076 0.9537  0.416
#Residual    21  1.01154 0.89759              
#Total       23  1.12695 1.00000        

#nothing significant


##situ- remove rare groups-----
permanova_benthic_situ_seabird_no_rare<-adonis2(tet_situ_raw_meta_broad_sp ~ seabird_level  + protection,  data = benthic.vid.seabirds.levels.algae)
permanova_benthic_situ_seabird_no_rare
#              Df SumOfSqs      R2      F Pr(>F)  
#seabird_level  2  0.31421 0.28497 4.2595  0.004 **
#protection     1  0.07243 0.06569 1.9638  0.147   
#Residual      20  0.73766 0.66901                 
#Total         23  1.10260 1.00000         

#same result as above - seabird level very significant

permanova_benthic_situ_n15_no_rare<-adonis2(tet_situ_raw_meta_broad_sp ~ N.15_at_30m  + protection,  data = benthic.vid.seabirds.levels.algae)
permanova_benthic_situ_n15_no_rare
#            Df SumOfSqs      R2      F Pr(>F)
#N.15_at_30m  1  0.06416 0.05819 1.3640  0.270
#protection   1  0.04546 0.04123 0.9666  0.414
#Residual    21  0.98771 0.89579              
#Total       23  1.10260 1.00000   

#same results as above - nothing significant


#add in distance to shore or (inshore/offshore distance) - CHECKED THIS, BUT DIDN'T END UP USING-----
#load transect metadata----
tet_trans_meta<-read.csv("../../metadata/fish_benthic_focal_transect_metadata.csv", stringsAsFactors = TRUE)
str(tet_trans_meta)

#make site name to do easy merge:----
tet_trans_meta2<-
  tet_trans_meta%>%
  rename_all(str_to_lower)%>%
  mutate(protection = if_else(exposure == "Leeward", "Protected", "Exposed"))%>%
  relocate(protection, .before = exposure)%>%
    mutate(motu = str_to_title(motu))%>%
  unite("site.name", c(motu, protection), sep = "_", remove = FALSE)%>%
  mutate(transect.in.out = case_when(grepl(pattern = "off", x = transect.location) ~ "offshore",
                                     grepl(pattern = "in", x = transect.location) ~ "inshore"))%>%
  mutate(transect.in.out = as.factor(transect.in.out))

tet_trans_meta2

benthic.vid.seabirds.levels.algae.trans<-right_join(select(tet_trans_meta2, c("site.name", "transect", "start_distance_to_shore_m",
                                                             "end_distance_to_shore_m", "depth_min_m", "depth_max_m", "structural_complexity_0to5",
                                                             "transect.location", "transect.in.out")),
                                          benthic.vid.seabirds.levels.algae,
                                          by = c("site.name", "transect"))%>%
  relocate(breeding_biomass_kgha_side, .after = rat.eradication.status)
  
benthic.vid.seabirds.levels.algae.trans


benthic.situ.seabirds.levels.algae.trans<-right_join(select(tet_trans_meta2, c("site.name", "transect", "start_distance_to_shore_m",
                                                             "end_distance_to_shore_m", "depth_min_m", "depth_max_m", "structural_complexity_0to5",
                                                             "transect.location", "transect.in.out")),
                                          benthic.situ.seabirds.levels.algae,
                                          by = c("site.name", "transect"))%>%
  relocate(breeding_biomass_kgha_side, .after = rat.eradication.status)
  
  
benthic.situ.seabirds.levels.algae.trans


permanova_benthic_situ_seabird_no_rare_trans<-adonis2(tet_situ_raw_meta_broad_sp ~ seabird_level + transect.in.out  + protection,  data = benthic.situ.seabirds.levels.algae.trans, by = "margin", permutations = 999)
permanova_benthic_situ_seabird_no_rare_trans
#seabird level still significnat, no interaction, no effect of transect in/out. Same as if use start distance to shore

permanova_benthic_situ_seabird_no_rare_trans<-adonis2(tet_situ_raw_meta_broad_sp ~ seabird_level + transect.in.out  + protection + depth_min_m + depth_max_m,  data = benthic.situ.seabirds.levels.algae.trans, by = "margin", permutations = 999)
permanova_benthic_situ_seabird_no_rare_trans

#run post-hoc test - pairwise adonis can be used for fator-level comparisons.
#pair.mod<-pairwise.adonis(biotafilename,factors=factorfilename$factorname)
#pair.mod

```



#Run LMMs using seabird levels and algae N15----------
#video and in situ:--------
```{r}

#Major groups----
#Hard coral - seabird level----
hard_coral_vid.lmm<-lmer(hard_coral_percent_cover~seabird_level+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
summary(hard_coral_vid.lmm)
Anova(hard_coral_vid.lmm)
vif(hard_coral_vid.lmm)

#marginal effect of seabird level:

#compare to LRT:
hard_coral_vid.lmm.r<-lmer(hard_coral_percent_cover~wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
anova(hard_coral_vid.lmm, hard_coral_vid.lmm.r) #NOW SIGNIFICANT p = .02988

plot_summs(hard_coral_vid.lmm)
#looks like low seabirds have higher coral cover than mid (and marginal than high)


hard_coral_situ.lmm<-lmer(coral_percent_cover~seabird_level+wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels.algae)
summary(hard_coral_situ.lmm)
Anova(hard_coral_situ.lmm)
#no effect of seabird level


#emmeans for hard coral, video:
hard_coral_vid.lmm
emmeans(hard_coral_vid.lmm, list(pairwise ~ seabird_level), adjust = "fdr")

#Hard coral - algae n15-----
hard_coral.vid.algae.lmm<-lmer(hard_coral_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
summary(hard_coral.vid.algae.lmm)
Anova(hard_coral.vid.algae.lmm) #NOTHING SIGNIFICANT****
vif(hard_coral.vid.algae.lmm)

hard_coral.situ.algae.lmm<-lmer(coral_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels.algae)
summary(hard_coral.situ.algae.lmm)
Anova(hard_coral.situ.algae.lmm) #NOTHING SIGNIFICANT****



##macroalgae seabird-----
macro.vid.lmm<-lmer(macroalgae_percent_cover~seabird_level+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
summary(macro.vid.lmm)
Anova(macro.vid.lmm) #NOTHING SIGNIFICANT****

macro.situ.lmm<-lmer(macroalgae_percent_cover~seabird_level+wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels.algae)
summary(macro.situ.lmm)
Anova(macro.situ.lmm) #NOTHING SIGNIFICANT****



##macroalgae algae n15-----
macro.vid.algae.lmm<-lmer(macroalgae_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
summary(macro.vid.algae.lmm)
Anova(macro.vid.algae.lmm) #NOTHING SIGNIFICANT****

macro.situ.algae.lmm<-lmer(macroalgae_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels.algae)
summary(macro.situ.algae.lmm)
Anova(macro.situ.algae.lmm) #NOTHING SIGNIFICANT****



```

#try beta distribution for major groups (hard coral and macroalgae) - because untransformed and log-transformed didn't work**
```{r}
transform01 <- function(x) {
  (x * (length(x) - 1) + 0.5) / (length(x))
}

div100<-function(x) {
  (x/100)
}

benthic.vid.seabirds.levels.algae.beta<-
  benthic.vid.seabirds.levels.algae %>%
  mutate_at(13:20, div100)%>%
  mutate_at(13:20, transform01)
benthic.vid.seabirds.levels.algae.beta


library(glmmTMB)

##HARD CORAL-----
hard_coral_vid.lmm.beta<-glmmTMB(hard_coral_percent_cover~seabird_level+wind.exposure + (1|site.name), family=beta_family(), data = benthic.vid.seabirds.levels.algae.beta)
summary(hard_coral_vid.lmm.beta)
Anova(hard_coral_vid.lmm.beta)
plot(resid(hard_coral_vid.lmm.beta))
qqnorm(resid(hard_coral_vid.lmm.beta))


#look at emmeans:
hard_coral_vid.lmm.beta %>% 
  emmeans(~ seabird_level,
          type = "response") 
#actually looks a lot better***

emmeans(hard_coral_vid.lmm.beta, list(pairwise ~ seabird_level), type = "response", adjust = "fdr")
#but in terms of sig - only low is higher than mid, all else no sig difference.

##response plot, beta----
plot_data_hc_vid_beta<-emmip(hard_coral_vid.lmm.beta, ~ seabird_level,
          type = "response", CIs = TRUE, plotit=FALSE)

plot_data_hc_vid_beta


hc_vid_response_plot_beta<-
  ggplot(data = plot_data_hc_vid_beta, aes(x = seabird_level, y = yvar*100, color = seabird_level, fill = seabird_level))+
#  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL*100, ymax = UCL*100), alpha = .3, linewidth = 2, size = 0,  position = position_dodge(.1)) + #,  position = position_dodge(.3)
 # geom_point(data = fishn15.seabirds.cond.r, 
           #  aes(y = n15, x = seabird_level), size = 2.5, alpha = .5,  position = position_dodge(.3))+ 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
  ylab("% hard coral cover")+
#scale_y_continuous(labels = scales::label_percent(accuracy = .1, scale = 1),  limits = c(0, 100), expand = expansion(0, 0))+
  xlab("seabird biomass level")+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = "none" )

hc_vid_response_plot_beta



##MACROALGAE----
macro_vid.lmm.beta<-glmmTMB(macroalgae_percent_cover~seabird_level+wind.exposure + (1|site.name), family=beta_family(), data = benthic.vid.seabirds.levels.algae.beta)
summary(macro_vid.lmm.beta)
Anova(macro_vid.lmm.beta)
plot(resid(macro_vid.lmm.beta))
qqnorm(resid(macro_vid.lmm.beta))
#no sig differences

#look at emmeans:
macro_vid.lmm.beta %>% 
  emmeans(~ seabird_level,
          type = "response") 
#actually looks a lot better***

emmeans(macro_vid.lmm.beta, list(pairwise ~ seabird_level), type = "response", adjust = "fdr")
#no sig diff

##response plot, beta----
plot_data_macro_vid_beta<-emmip(macro_vid.lmm.beta, ~ seabird_level,
          type = "response", CIs = TRUE, plotit=FALSE)

plot_data_macro_vid_beta


macro_vid_response_plot_beta<-
  ggplot(data = plot_data_macro_vid_beta, aes(x = seabird_level, y = yvar*100, color = seabird_level, fill = seabird_level))+
#  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL*100, ymax = UCL*100), alpha = .3, linewidth = 2, size = 0,  position = position_dodge(.1)) + #,  position = position_dodge(.3)
 # geom_point(data = fishn15.seabirds.cond.r, 
           #  aes(y = n15, x = seabird_level), size = 2.5, alpha = .5,  position = position_dodge(.3))+ 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
  ylab("% hard coral cover")+
#scale_y_continuous(labels = scales::label_percent(accuracy = .1, scale = 1),  limits = c(0, 100), expand = expansion(0, 0))+
  xlab("seabird biomass level")+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = "none" )

macro_vid_response_plot_beta


plot_data_hc_vid_beta<-
  plot_data_hc_vid_beta%>%
  mutate(group = "hard coral")

plot_data_macro_vid_beta<-
  plot_data_macro_vid_beta%>%
  mutate(group = "algae")


plot_data_vid_beta<-
  rbind(plot_data_hc_vid_beta, plot_data_macro_vid_beta)
plot_data_vid_beta

#combine algae and coral plots:
 ggplot(data = plot_data_vid_beta, aes(x = seabird_level, y = yvar*100, color = group, fill = group))+
  geom_pointrange(aes(ymin = LCL*100, ymax = UCL*100), alpha = .3, linewidth = 2, size = 0,  position = position_dodge(.1)) + 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  ylab("% cover")+
  xlab("seabird biomass level")+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank())
 
  ggplot(data = plot_data_vid_beta, aes(x = group, y = yvar*100, color = seabird_level, fill = seabird_level))+
  geom_pointrange(aes(ymin = LCL*100, ymax = UCL*100), alpha = .3, linewidth = 2, size = 0,  position = position_dodge(.1)) + 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  ylab("% cover")+
  xlab("seabird biomass level")+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank())

  
###repeat for in situ:------------
benthic.situ.seabirds.levels.algae.beta<-
  benthic.situ.seabirds.levels.algae %>%
  mutate_at(13:18, div100)%>%
  mutate_at(13:18, transform01)
benthic.situ.seabirds.levels.algae.beta



##HARD CORAL-----
hard_coral_situ.lmm.beta<-glmmTMB(coral_percent_cover~seabird_level+wind.exposure + (1|site.name), family=beta_family(), data = benthic.situ.seabirds.levels.algae.beta)
summary(hard_coral_situ.lmm.beta)
Anova(hard_coral_situ.lmm.beta)
plot(resid(hard_coral_situ.lmm.beta))
qqnorm(resid(hard_coral_situ.lmm.beta))


#look at emmeans:
hard_coral_situ.lmm.beta %>% 
  emmeans(~ seabird_level,
          type = "response") 
#now high slightly lower than other 2

emmeans(hard_coral_situ.lmm.beta, list(pairwise ~ seabird_level), type = "response", adjust = "fdr")
#but in terms of sig - no significant differences

##response plot, beta----
plot_data_hc_situ_beta<-emmip(hard_coral_situ.lmm.beta, ~ seabird_level,
          type = "response", CIs = TRUE, plotit=FALSE)

plot_data_hc_situ_beta


hc_situ_response_plot_beta<-
  ggplot(data = plot_data_hc_situ_beta, aes(x = seabird_level, y = yvar*100, color = seabird_level, fill = seabird_level))+
#  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL*100, ymax = UCL*100), alpha = .3, linewidth = 2, size = 0,  position = position_dodge(.1)) + #,  position = position_dodge(.3)
 # geom_point(data = fishn15.seabirds.cond.r, 
           #  aes(y = n15, x = seabird_level), size = 2.5, alpha = .5,  position = position_dodge(.3))+ 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
  ylab("% hard coral cover")+
#scale_y_continuous(labels = scales::label_percent(accuracy = .1, scale = 1),  limits = c(0, 100), expand = expansion(0, 0))+
  xlab("seabird biomass level")+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = "none" )

hc_situ_response_plot_beta

  
##MACROALGAE----
macro_situ.lmm.beta<-glmmTMB(macroalgae_percent_cover~seabird_level+wind.exposure + (1|site.name), family=beta_family(), data = benthic.situ.seabirds.levels.algae.beta)
summary(macro_situ.lmm.beta)
Anova(macro_situ.lmm.beta)
plot(resid(macro_situ.lmm.beta))
qqnorm(resid(macro_situ.lmm.beta))
#no sig differences

#look at emmeans:
macro_situ.lmm.beta %>% 
  emmeans(~ seabird_level,
          type = "response") 
#actually looks a lot better***

emmeans(macro_situ.lmm.beta, list(pairwise ~ seabird_level), type = "response", adjust = "fdr")
#no sig diff

##response plot, beta----
plot_data_macro_situ_beta<-emmip(macro_situ.lmm.beta, ~ seabird_level,
          type = "response", CIs = TRUE, plotit=FALSE)

plot_data_macro_situ_beta


macro_situ_response_plot_beta<-
  ggplot(data = plot_data_macro_situ_beta, aes(x = seabird_level, y = yvar*100, color = seabird_level, fill = seabird_level))+
#  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL*100, ymax = UCL*100), alpha = .3, linewidth = 2, size = 0,  position = position_dodge(.1)) + #,  position = position_dodge(.3)
 # geom_point(data = fishn15.seabirds.cond.r, 
           #  aes(y = n15, x = seabird_level), size = 2.5, alpha = .5,  position = position_dodge(.3))+ 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
  ylab("% hard coral cover")+
#scale_y_continuous(labels = scales::label_percent(accuracy = .1, scale = 1),  limits = c(0, 100), expand = expansion(0, 0))+
  xlab("seabird biomass level")+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = "none" )

macro_situ_response_plot_beta


plot_data_hc_situ_beta<-
  plot_data_hc_situ_beta%>%
  mutate(group = "hard coral")

plot_data_macro_situ_beta<-
  plot_data_macro_situ_beta%>%
  mutate(group = "algae")


plot_data_situ_beta<-
  rbind(plot_data_hc_situ_beta, plot_data_macro_situ_beta)
plot_data_situ_beta

  
##combine all into one plot:------
plot_data_situ_beta<-
  plot_data_situ_beta%>%
  mutate(method = "in situ")


plot_data_vid_beta<-
  plot_data_vid_beta%>%
  mutate(method = "video")


plot_data_beta_all<-
  rbind(plot_data_situ_beta, plot_data_vid_beta)

plot_data_beta_all

plot_beta_all_est<-
  ggplot(data = plot_data_beta_all, aes(x = seabird_level, y = yvar*100, color = method, fill = method))+
  geom_pointrange(aes(ymin = LCL*100, ymax = UCL*100), alpha = .3, linewidth = 2, size = 0,  position = position_dodge(.1)) + 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  ylab("% cover")+
  xlab("seabird biomass level")+
  facet_wrap(~group)+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank())

plot_beta_all_est



###repeat for beta, macroalgae n15-----------
hard_coral_vid.lmm.beta.n15<-glmmTMB(hard_coral_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), family=beta_family(), data = benthic.vid.seabirds.levels.algae.beta)
summary(hard_coral_vid.lmm.beta.n15)
Anova(hard_coral_vid.lmm.beta.n15)
plot(resid(hard_coral_vid.lmm.beta.n15))
qqnorm(resid(hard_coral_vid.lmm.beta.n15))

macro_vid.lmm.beta.n15<-glmmTMB(macroalgae_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), family=beta_family(), data = benthic.vid.seabirds.levels.algae.beta)
summary(macro_vid.lmm.beta.n15)
Anova(macro_vid.lmm.beta.n15)
  plot(resid(macro_vid.lmm.beta.n15))
qqnorm(resid(macro_vid.lmm.beta.n15))


hard_coral_situ.lmm.beta.n15<-glmmTMB(coral_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), family=beta_family(), data = benthic.situ.seabirds.levels.algae.beta)
summary(hard_coral_situ.lmm.beta.n15)
Anova(hard_coral_situ.lmm.beta.n15)
plot(resid(hard_coral_situ.lmm.beta.n15))
qqnorm(resid(hard_coral_situ.lmm.beta.n15))

macro_situ.lmm.beta.n15<-glmmTMB(macroalgae_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), family=beta_family(), data = benthic.situ.seabirds.levels.algae.beta)
summary(macro_situ.lmm.beta.n15)
Anova(macro_situ.lmm.beta.n15)
  plot(resid(macro_situ.lmm.beta.n15))
qqnorm(resid(macro_situ.lmm.beta.n15))

```


#remake plots----
```{r}

##combine all into one plot:------
plot_data_situ_beta<-
  plot_data_situ_beta%>%
  mutate(method = "in situ")


plot_data_vid_beta<-
  plot_data_vid_beta%>%
  mutate(method = "video")


plot_data_beta_all<-
  rbind(plot_data_situ_beta, plot_data_vid_beta)%>%
  mutate(group = fct_recode(group,  "macroalgae" = "algae"))%>%
  mutate(group = fct_relevel(group, "hard coral", "macroalgae"))

plot_data_beta_all

plot_data_beta_all_plot_flipped<-
  ggplot(data = plot_data_beta_all, aes(x = method, y = yvar*100, color = seabird_level, fill = seabird_level))+
  geom_point(pch = 21,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL*100, ymax = UCL*100), alpha = .3, linewidth = 5, size = 0,  position = position_dodge(.3)) + 
 # geom_point(data = fishn15.seabirds.cond.r, 
    #         aes(y = n15, x = species), size = 2.5, alpha = .5,  position = position_dodge(.3))+
scale_fill_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+ #low-mid-high = red-yellow-green
    scale_colour_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+#low-mid-high = red-yellow-green
  ylab("% cover")+
  xlab("")+
  labs(color = "seabird level", fill = "seabird level")+
    facet_wrap(~group)+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.73,.92),
        legend.direction = "horizontal",
        legend.box.background = element_rect(colour = "black"))
#,
       # axis.text = element_text(size = 14),
       # axis.title.y = element_text(size = 14)

plot_data_beta_all_plot_flipped

#ggsave("../output/seabird-benthic/plot_data_beta_all_plot_flipped.jpg", plot = plot_data_beta_all_plot_flipped, width = 7, height = 4.5)


```

#correlation analysis and plots for in situ versus video
```{r}

```

