---
title: "seabirds_vs_benthos"
author: "CEB"
date: '2023-09-29'
output: html_document
---

#load packages
```{r}
library(tidyverse)

library(lme4)
library(car)
library(jtools)

library(emmeans)

library(corrplot)

library(vegan)

```


#load data
```{r}
seabirds <- read.csv("../output/n15_seabirds_combined_no_iti.csv", strip.white = T, header = T)
load("../../fish_benthic_surveys/output/data/benthic_community_data.Rdata")

benthic_vid<-tet_video_div_comm_dat_w_cover
benthic_situ<-tet_insitu_div_comm_dat_w_cover

```


##start with video data----
#merge data
```{r}
benthic_vid

#make combined site name column in benthic data
benthic_vid_dat<-
  benthic_vid%>%
  mutate(motu = str_to_title(motu),
         protection = str_to_title(protection))%>%
  unite("site.name", c(motu, protection), sep = "_", remove = FALSE)

benthic_vid_dat

benthic.vid.seabirds<-left_join(benthic_vid_dat,
                            select(seabirds, c("site.name", "breeding_biomass_kgha_side")), 
                                   by = "site.name")%>%
  mutate(site.name = as.factor(site.name))
benthic.vid.seabirds

```



#do some quick plots of data:
```{r}

benthic.vid.seabirds%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = hard_coral_percent_cover))+
  geom_point()+
  geom_smooth(method = "lm")

benthic.vid.seabirds%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = macroalgae_percent_cover))+
  geom_point()+
  geom_smooth(method = "lm")

benthic.vid.seabirds%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = macroalgae_percent_cover))+
  geom_point()+
  geom_smooth(method = "lm")


benthic.vid.seabirds%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = coral_shannon))+
  geom_point()+
  geom_smooth(method = "lm")



##stacked bar plot
benthic.vid.seabirds%>%
  select(-c(total_percent_cover))%>%
  pivot_longer(cols = ends_with("_percent_cover"),
                                          names_to = "group",
                                          values_to = "percent_cover")%>%
  mutate(group = str_remove(group, '_percent_cover'))%>%
  group_by(group, site.name)%>%
  summarize(mean_percent_cover = mean(percent_cover))%>%
  ggplot(aes(fill = group, y = mean_percent_cover, x = site.name))+
  geom_bar(position = "stack", stat =  "identity")

#doesn't look like much happening....

#limit stacked bar to most interesting groups: 
benthic_vid_stack_barplot<-
benthic.vid.seabirds%>%
  select(-c(total_percent_cover, transect_tape_percent_cover))%>%
  pivot_longer(cols = ends_with("_percent_cover"),
                                          names_to = "group",
                                          values_to = "percent_cover")%>%
  mutate(group = str_remove(group, '_percent_cover'))%>%
  group_by(group, site.name)%>%
  summarize(mean_percent_cover = mean(percent_cover))%>%
  mutate(group = as.factor(group))%>%
  mutate(group = fct_relevel(group, c("hard_coral", "macroalgae", "pavement", "rubble", "sand", "cca", "dead_coral",   "other_fish_inverts")))%>%
  ggplot(aes(fill = group, y = mean_percent_cover, x = site.name))+
  geom_bar(position = "stack", stat =  "identity")+
  scale_fill_brewer(palette = "Set2")+
  xlab("")+
  ylab("% cover")+
    theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)
        )
  
  benthic_vid_stack_barplot
  
ggsave(benthic_vid_stack_barplot, file = "../output/seabird-benthic/benthic_vid_stack_barplot.jpg",
       width = 7, height = 5)



```

#do corrplots:
```{r}
benthic.vid.seabirds

corr_mat_benth_vid_sb<-as.data.frame(benthic.vid.seabirds[,7:23])


cor.mtest(corr_mat_benth_vid_sb)
correlation.matrix <- cor(corr_mat_benth_vid_sb, use = "pairwise.complete.obs")
#write.csv(correlation.matrix, "../output/seabird-benthic/seabirds_benthic_video_corrmatrix.csv")


#corrplot(cor(corr_mat_benth_vid_sb, use = "pairwise.complete.obs"), type = "upper",
#         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", tl.cex = 0.5, title = "Seabirds-Benthic")

#pdf(file = "../output/seabird-benthic/seabirds_benthic_video.pdf")

#corrplot(cor(corr_mat_benth_vid_sb, use = "pairwise.complete.obs"), type = "upper",
#         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", tl.cex = 0.5, title = "Seabirds-Benthic")

#dev.off()

#pretty weak corr's, not much happening...
```

##do NMDS with seabird biomass as overlay
```{r}
tet_video_raw_meta_broad_sp<-
  benthic.vid.seabirds%>%
  ungroup()%>%
  select(hard_coral_percent_cover:macroalgae_percent_cover)
tet_video_raw_meta_broad_sp


#run nmds----
nmds_video<-metaMDS(tet_video_raw_meta_broad_sp, distance = "bray", trymax=200, k=2, autotransform = FALSE)
nmds_video
#2 axes stress = 0.06113269, so all good

plot(nmds_video)
scores(nmds_video, display="species")


#look at plot and centroids, for now just motu and exposure (so sitename). will need to add explanatory variables
plot(nmds_video)
ord.fit<-envfit(nmds_video~breeding_biomass_kgha_side+protection, data = benthic.vid.seabirds, na.rm=TRUE)
ord.fit #looks like some differences among motu
plot(ord.fit)
#draw polygons and arrows
ordihull(nmds_video, benthic.vid.seabirds$breeding_biomass_kgha_side, pty=3)
## p = 0.1 for seabirds, actually some trends...

#rotate by breeding seabird biomass so can more easily interpret----
nmds_video.rotate<-MDSrotate(nmds_video, benthic.vid.seabirds$breeding_biomass_kgha_side)
nmds_video.rotate
plot(nmds_video.rotate)

ord.fit<-envfit(nmds_video.rotate~breeding_biomass_kgha_side+protection, data = benthic.vid.seabirds, na.rm=TRUE)
ord.fit #marginal effect of seabirds, no effect of protection. 
plot(ord.fit)
#draw polygons and arrows
ordihull(nmds_video.rotate, benthic.vid.seabirds$breeding_biomass_kgha_side, pty=3)


##extract site/transect scores----
video_spp.sc <- as.data.frame(scores(nmds_video.rotate, "species"))  #Using the scores function from vegan to extract the species scores and convert to a data.frame
video_spp.sc<-
  video_spp.sc%>%
  rownames_to_column(var="Species") # create a column of species, from the rownames of species.scores


video_site.sc <- scores(nmds_video.rotate, display = "sites", shrink = FALSE) 
video_site.sc

#merge site.sc with metadata and dispersion
nmds_video_site_scores<-
  bind_cols(benthic.vid.seabirds$site.name,
                    as_tibble(video_site.sc))%>%
  rename('site.name' = '...1')
nmds_video_site_scores


#plot just to see----

#get hull data:
site.A1 <- nmds_video_site_scores[nmds_video_site_scores$site.name == "Aie_Exposed", ][chull(nmds_video_site_scores[nmds_video_site_scores$site.name == 
    "Aie_Exposed", c("NMDS1", "NMDS2")]), ]

site.A2 <- nmds_video_site_scores[nmds_video_site_scores$site.name == "Aie_Protected", ][chull(nmds_video_site_scores[nmds_video_site_scores$site.name == 
    "Aie_Protected", c("NMDS1", "NMDS2")]), ]  

site.Re1 <- nmds_video_site_scores[nmds_video_site_scores$site.name == "Reiono_Protected", ][chull(nmds_video_site_scores[nmds_video_site_scores$site.name == 
    "Reiono_Protected", c("NMDS1", "NMDS2")]), ]

site.Re2<- nmds_video_site_scores[nmds_video_site_scores$site.name == "Reiono_Exposed", ][chull(nmds_video_site_scores[nmds_video_site_scores$site.name == 
    "Reiono_Exposed", c("NMDS1", "NMDS2")]), ]  

site.Rm1 <- nmds_video_site_scores[nmds_video_site_scores$site.name == "Rimatuu_Protected", ][chull(nmds_video_site_scores[nmds_video_site_scores$site.name == 
    "Rimatuu_Protected", c("NMDS1", "NMDS2")]), ]

site.Rm2<- nmds_video_site_scores[nmds_video_site_scores$site.name == "Rimatuu_Exposed", ][chull(nmds_video_site_scores[nmds_video_site_scores$site.name == 
    "Rimatuu_Exposed", c("NMDS1", "NMDS2")]), ]  

hull.data <- rbind(site.A1, site.A2, site.Re1, site.Re2, site.Rm1, site.Rm2)  #combine
hull.data

ggplot() + 
  geom_text(data=video_spp.sc,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .2) +  # add the species labels - 
  geom_point(data=nmds_video_site_scores,aes(x=NMDS1,y=NMDS2,colour=site.name, fill = site.name, pch = site.name), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data,aes(x=NMDS1,y=NMDS2,fill=site.name,group=site.name),alpha=0.30) + # add the convex hulls
  theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), #remove gray boxes
        text = element_text(size=20))
        #legend.title = element_blank()) #remove legend title
        #legend.box.background = element_rect(colour = "black", fill='white', linetype='solid', size=1), 
       # legend.justification=c(1,.9), legend.position=c(1,.9))  #  fix legend

##add arrows
sb.scrs <- as.data.frame(scores(ord.fit, display = "vectors"))
sb.scrs <- cbind(sb.scrs, Species = rownames(sb.scrs))


video_spp.sc2<-
  video_spp.sc%>%
  mutate(Species= str_remove_all(Species, "_percent_cover"))

benthic_video_nmds_plot<-
ggplot() + 
  geom_text(data=video_spp.sc2,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .2) +  # add the species labels - 
  geom_point(data=nmds_video_site_scores,aes(x=NMDS1,y=NMDS2,colour=site.name, fill = site.name, pch = site.name), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data,aes(x=NMDS1,y=NMDS2,fill=site.name,group=site.name),alpha=0.30) + # add the convex hulls
  coord_fixed() + ## need aspect ratio of 1!
  geom_segment(data = sb.scrs,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")), colour = "black") +
    geom_text(data = sb.scrs, aes(x = NMDS1, y = NMDS2, label = "seabirds"),
            size = 3, vjust = 2)+
  theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), #remove gray boxes
        text = element_text(size=20))
        #legend.title = element_blank()) #remove legend title
        #legend.box.background = element_rect(colour = "black", fill='white', linetype='solid', size=1), 
       # legend.justification=c(1,.9), legend.position=c(1,.9))  #  fix legend

benthic_video_nmds_plot


#save plot
  
#ggsave(benthic_video_nmds_plot, file = "../output/seabird-benthic/benthic_video_nmds_plot.jpg",
#       width = 7, height = 5)


```

**May need to also account for exposure, distance from shore, depth???  Weird that seabirds positive with sand - but also sand isn't true representation of what's there (swam between channels when extra shallow)



##repeat with in situ ----
#merge data
```{r}
benthic_situ

#make combined site name column in benthic data
benthic_situ_dat<-
  benthic_situ%>%
  mutate(protection = if_else(wind.exposure == "leeward", "Protected", "Exposed"))%>%
  mutate(motu = str_to_title(motu),
         protection = str_to_title(protection))%>%
  unite("site.name", c(motu, protection), sep = "_", remove = FALSE)%>%
  select(-protection)

benthic_situ_dat

benthic.situ.seabirds<-left_join(benthic_situ_dat,
                            select(seabirds, c("site.name", "breeding_biomass_kgha_side")), 
                                   by = "site.name")%>%
  mutate(site.name = as.factor(site.name))
benthic.situ.seabirds

```



#do some quick plots of data:
```{r}

benthic.situ.seabirds%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = coral_prop_cover))+
  geom_point()+
  geom_smooth(method = "lm")

benthic.situ.seabirds%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = macroalgae_prop_cover))+
  geom_point()+
  geom_smooth(method = "lm")

benthic.situ.seabirds%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = pavement_prop_cover))+
  geom_point()+
  geom_smooth(method = "lm")


benthic.situ.seabirds%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = coral_shannon))+
  geom_point()+
  geom_smooth(method = "lm")



##stacked bar plot
benthic.situ.seabirds%>%
  pivot_longer(cols = ends_with("_prop_cover"),
                                          names_to = "group",
                                          values_to = "prop_cover")%>%
  mutate(group = str_remove(group, '_prop_cover'))%>%
  group_by(group, site.name)%>%
  summarize(mean_prop_cover = mean(prop_cover))%>%
  ggplot(aes(fill = group, y = mean_prop_cover, x = site.name))+
  geom_bar(position = "stack", stat =  "identity")

#doesn't look like much happening....


#make better stacked bar plot, combine with video: 
benthic_insitu_stack_barplot<-
benthic.situ.seabirds%>%
#  select(-c(total_percent_cover, transect_tape_percent_cover))%>%
  pivot_longer(cols = ends_with("_prop_cover"),
                                          names_to = "group",
                                          values_to = "prop_cover")%>%
  mutate(group = str_remove(group, '_prop_cover'))%>%
  group_by(group, site.name)%>%
  summarize(mean_percent_cover = mean(prop_cover)*100)%>%
  mutate(group = as.factor(group))%>%
 mutate(group = fct_relevel(group, c("coral", "macroalgae", "pavement", "rubble", "sand", "cyano",   "other_invert")))%>%
  ggplot(aes(fill = group, y = mean_percent_cover, x = site.name))+
  geom_bar(position = "stack", stat =  "identity")+
  scale_fill_brewer(palette = "Set2")+
  xlab("")+
  ylab("% cover")+
    theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)
        )
  
benthic_insitu_stack_barplot
  
#ggsave(benthic_insitu_stack_barplot, file = "../output/seabird-benthic/benthic_insitu_stack_barplot.jpg",
#       width = 7, height = 5)


```


#do corrplots:
```{r}
benthic.situ.seabirds

corr_mat_benth_situ_sb<-as.data.frame(benthic.situ.seabirds[,6:19])


cor.mtest(corr_mat_benth_situ_sb)
correlation.matrix <- cor(corr_mat_benth_situ_sb, use = "pairwise.complete.obs")
#write.csv(correlation.matrix, "../output/seabird-benthic/seabirds_benthic_situ_corrmatrix.csv")


#corrplot(cor(corr_mat_benth_situ_sb, use = "pairwise.complete.obs"), type = "upper",
#         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", tl.cex = 0.5, title = "Seabirds-Benthic")

#pdf(file = "../output/seabird-benthic/seabirds_benthic_situ.pdf")

#corrplot(cor(corr_mat_benth_situ_sb, use = "pairwise.complete.obs"), type = "upper",
#         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", tl.cex = 0.5, title = "Seabirds-Benthic In Situ")

#dev.off()
```

##do NMDS with seabird biomass as overlay - IN SITU
```{r}
tet_situ_raw_meta_broad_sp<-
  benthic.situ.seabirds%>%
  ungroup()%>%
  select(coral_prop_cover:cyano_prop_cover)
tet_situ_raw_meta_broad_sp


#run nmds----
nmds_situ<-metaMDS(tet_situ_raw_meta_broad_sp, distance = "bray", trymax=200, k=2, autotransform = FALSE)
nmds_situ
#2 axes stress = 0.07486106, so all good

plot(nmds_situ)
scores(nmds_situ, display="species")


#look at plot and centroids, for now just motu and exposure (so sitename). will need to add explanatory variables
plot(nmds_situ)
ord.fit<-envfit(nmds_situ~breeding_biomass_kgha_side+wind.exposure, data = benthic.situ.seabirds, na.rm=TRUE)
ord.fit #looks like some significant effect of seabirds
plot(ord.fit)
#draw polygons and arrows
ordihull(nmds_situ, benthic.situ.seabirds$breeding_biomass_kgha_side, pty=3)
## p = 0.036 for seabirds, actually some trends...

scores(nmds_situ, display = "sites", shrink = FALSE) 
#check species scores with nmds1:
cor(tet_situ_raw_meta_broad_sp, scores(nmds_situ, dis="si"))

#rotate by breeding seabird biomass so can more easily interpret----
nmds_situ.rotate<-MDSrotate(nmds_situ, benthic.situ.seabirds$breeding_biomass_kgha_side)
nmds_situ.rotate

plot(nmds_situ.rotate)

ord.fit.situ<-envfit(nmds_situ.rotate~breeding_biomass_kgha_side+wind.exposure, data = benthic.situ.seabirds, na.rm=TRUE)
ord.fit.situ #sig effect of seabirds, no effect of protection. 
plot(ord.fit.situ)
#draw polygons and arrows
ordihull(nmds_situ.rotate, benthic.situ.seabirds$breeding_biomass_kgha_side, pty=3)


##extract site/transect scores----
situ_spp.sc <- as.data.frame(scores(nmds_situ.rotate, "species"))  #Using the scores function from vegan to extract the species scores and convert to a data.frame
situ_spp.sc<-
  situ_spp.sc%>%
  rownames_to_column(var="Species") # create a column of species, from the rownames of species.scores


situ_site.sc <- scores(nmds_situ.rotate, display = "sites", shrink = FALSE) 
situ_site.sc

#merge site.sc with metadata and dispersion
nmds_situ_site_scores<-
  bind_cols(benthic.situ.seabirds$site.name,
                    as_tibble(situ_site.sc))%>%
  rename('site.name' = '...1')
nmds_situ_site_scores

#permanova-----
ad_insitu1<-adonis2(tet_situ_raw_meta_broad_sp ~ breeding_biomass_kgha_side + wind.exposure, data = benthic.situ.seabirds, method="euclidean")
ad_insitu1
#same as env.fit above....BUT maybe can include site as grouping level (i.e., random effect)**

#set blocks by site
perm <- how(nperm = 999)
setBlocks(perm) <- with(benthic.situ.seabirds, site.name)

#run analysis
benthic_situ_ad<-adonis2(tet_situ_raw_meta_broad_sp~ breeding_biomass_kgha_side + wind.exposure, data = benthic.situ.seabirds, permutations = perm)
benthic_situ_ad
#now nothing even close....

#set blocks by motu instead?
perm2 <- how(nperm = 999)
setBlocks(perm2) <- with(benthic.situ.seabirds, motu)

#run analysis
benthic_situ_ad2<-adonis2(tet_situ_raw_meta_broad_sp~ breeding_biomass_kgha_side + wind.exposure, data = benthic.situ.seabirds, permutations = perm2)
benthic_situ_ad2
#yup, nothing close to significant...

#HARD TO TEASE APART SITE EFFECTS VERSUS SEABIRD EFFECTS HERE.....


#plot just to see----

#get hull data:
site.A1.situ <- nmds_situ_site_scores[nmds_situ_site_scores$site.name == "Aie_Exposed", ][chull(nmds_situ_site_scores[nmds_situ_site_scores$site.name == 
    "Aie_Exposed", c("NMDS1", "NMDS2")]), ]

site.A2.situ <- nmds_situ_site_scores[nmds_situ_site_scores$site.name == "Aie_Protected", ][chull(nmds_situ_site_scores[nmds_situ_site_scores$site.name == 
    "Aie_Protected", c("NMDS1", "NMDS2")]), ]  

site.Re1.situ <- nmds_situ_site_scores[nmds_situ_site_scores$site.name == "Reiono_Protected", ][chull(nmds_situ_site_scores[nmds_situ_site_scores$site.name == 
    "Reiono_Protected", c("NMDS1", "NMDS2")]), ]

site.Re2.situ<- nmds_situ_site_scores[nmds_situ_site_scores$site.name == "Reiono_Exposed", ][chull(nmds_situ_site_scores[nmds_situ_site_scores$site.name == 
    "Reiono_Exposed", c("NMDS1", "NMDS2")]), ]  

site.Rm1.situ <- nmds_situ_site_scores[nmds_situ_site_scores$site.name == "Rimatuu_Protected", ][chull(nmds_situ_site_scores[nmds_situ_site_scores$site.name == 
    "Rimatuu_Protected", c("NMDS1", "NMDS2")]), ]

site.Rm2.situ<- nmds_situ_site_scores[nmds_situ_site_scores$site.name == "Rimatuu_Exposed", ][chull(nmds_situ_site_scores[nmds_situ_site_scores$site.name == 
    "Rimatuu_Exposed", c("NMDS1", "NMDS2")]), ]  

hull.data.situ <- rbind(site.A1.situ, site.A2.situ, site.Re1.situ, site.Re2.situ, site.Rm1.situ, site.Rm2.situ)  #combine
hull.data.situ

ggplot() + 
  geom_text(data=situ_spp.sc,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .2) +  # add the species labels - 
  geom_point(data=nmds_situ_site_scores,aes(x=NMDS1,y=NMDS2,colour=site.name, fill = site.name, pch = site.name), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data.situ,aes(x=NMDS1,y=NMDS2,fill=site.name,group=site.name),alpha=0.30) + # add the convex hulls
  theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), #remove gray boxes
        text = element_text(size=20))
        #legend.title = element_blank()) #remove legend title
        #legend.box.background = element_rect(colour = "black", fill='white', linetype='solid', size=1), 
       # legend.justification=c(1,.9), legend.position=c(1,.9))  #  fix legend

##add arrows
sb.scrs.situ <- as.data.frame(scores(ord.fit.situ, display = "vectors"))
sb.scrs.situ <- cbind(sb.scrs.situ, Species = rownames(sb.scrs.situ))


situ_spp.sc2<-
  situ_spp.sc%>%
  mutate(Species= str_remove_all(Species, "_prop_cover"))

benthic_situ_nmds_plot<-
ggplot() + 
  geom_text(data=situ_spp.sc2,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .2) +  # add the species labels - 
  geom_point(data=nmds_situ_site_scores,aes(x=NMDS1,y=NMDS2,colour=site.name, fill = site.name, pch = site.name), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data.situ,aes(x=NMDS1,y=NMDS2,fill=site.name,group=site.name),alpha=0.30) + # add the convex hulls
  coord_fixed() + ## need aspect ratio of 1!
  geom_segment(data = sb.scrs,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")), colour = "black") +
    geom_text(data = sb.scrs, aes(x = NMDS1, y = NMDS2, label = "seabirds"),
            size = 3, vjust = 2)+
  theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), #remove gray boxes
        text = element_text(size=20))
        #legend.title = element_blank()) #remove legend title
        #legend.box.background = element_rect(colour = "black", fill='white', linetype='solid', size=1), 
       # legend.justification=c(1,.9), legend.position=c(1,.9))  #  fix legend

benthic_situ_nmds_plot


#save plot
  
#ggsave(benthic_situ_nmds_plot, file = "../output/seabird-benthic/benthic_insitu_nmds_plot.jpg",
     #  width = 7, height = 5)

```



##use seabird levels----
#video:
```{r}

#add levels to data----
benthic.vid.seabirds.levels<-
  benthic.vid.seabirds%>%
    mutate(seabird_level = case_when(breeding_biomass_kgha_side<10 ~"low",
                                   breeding_biomass_kgha_side>10&breeding_biomass_kgha_side <200 ~"mid",
                                   breeding_biomass_kgha_side>200 ~"high"))%>%
  mutate(seabird_level = as.factor(seabird_level))%>%
  mutate(seabird_level = fct_relevel(seabird_level, "low", "mid", "high"))

##try manova----
benthic_video.manova <- manova(cbind(hard_coral_percent_cover, sand_percent_cover, pavement_percent_cover, rubble_percent_cover, cca_percent_cover, macroalgae_percent_cover) ~ seabird_level + wind.exposure, data = benthic.vid.seabirds.levels)
summary(benthic_video.manova)
#nothing significant

benthic_video.manova2 <- manova(cbind(hard_coral_percent_cover, sand_percent_cover, pavement_percent_cover, rubble_percent_cover, cca_percent_cover, macroalgae_percent_cover) ~ seabird_level, data = benthic.vid.seabirds.levels)
summary(benthic_video.manova2)

#nope, still not significant. And this is not including random effects, so if anything less likely to be sig when use lmm's below: 

EMM_benthic_video_manova <- emmeans(benthic_video.manova, ~seabird_level*rep.meas)
pairs(EMM_benthic_video_manova, simple = "seabird_level", type = "response")
test(pairs(EMM_benthic_video_manova, by = "rep.meas"), by = NULL, adjust = "mvt")


#plot:
plot_data_manova_video<-emmip(benthic_video.manova, ~ seabird_level*rep.meas,
          type = "response", CIs = TRUE, plotit=FALSE)

ggplot(data = plot_data_manova_video, aes(x = rep.meas, y = yvar, color = seabird_level, fill = seabird_level))+
  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL, ymax = UCL), alpha = .3, linewidth = 5, size = 0,  position = position_dodge(.3)) + 
 # geom_point(data = fishn15.seabirds.cond.r, 
    #         aes(y = n15, x = species), size = 2.5, alpha = .5,  position = position_dodge(.3))+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
  ylab("% cover video")+
  xlab("")+
  labs(color = "seabird level", fill = "seabird level")+
  scale_x_discrete(label = c("hard coral", "sand", "pavement", "rubble", "cca", "macroalgae"))+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.8,.92),
        legend.direction = "horizontal",
        legend.box.background = element_rect(colour = "black"))



#run individual lmms----
hard_coral.lmm<-lmer(hard_coral_percent_cover~seabird_level*wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels)
summary(hard_coral.lmm)
Anova(hard_coral.lmm)
#can't use interaction because rank-deficient....

hard_coral.lmm<-lmer(hard_coral_percent_cover~seabird_level+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels)
summary(hard_coral.lmm)
Anova(hard_coral.lmm)
#marginal effect of seabird level:

plot_summs(hard_coral.lmm)
#looks like low seabirds have higher coral cover than mid (and marginal than high)

benthic.vid.seabirds.levels%>%
  ggplot(aes(x = seabird_level, y = hard_coral_percent_cover))+
  geom_boxplot()



```



#in situ with levels:
```{r}

#add levels to data----
benthic.situ.seabirds.levels<-
  benthic.situ.seabirds%>%
    mutate(seabird_level = case_when(breeding_biomass_kgha_side<10 ~"low",
                                   breeding_biomass_kgha_side>10&breeding_biomass_kgha_side <200 ~"mid",
                                   breeding_biomass_kgha_side>200 ~"high"))%>%
  mutate(seabird_level = as.factor(seabird_level))%>%
  mutate(seabird_level = fct_relevel(seabird_level, "low", "mid", "high"))

##try manova----
benthic_situ.manova <- manova(cbind(coral_prop_cover, pavement_prop_cover, rubble_prop_cover, sand_prop_cover, macroalgae_prop_cover) ~ seabird_level + wind.exposure, data = benthic.situ.seabirds.levels)
summary(benthic_situ.manova)
#seabird level is marginal****

benthic_situ.manova2 <- manova(cbind(coral_prop_cover, pavement_prop_cover, rubble_prop_cover, sand_prop_cover, macroalgae_prop_cover) ~ seabird_level, data = benthic.situ.seabirds.levels)
summary(benthic_situ.manova2)
#seabird level is still marginal****

EMM_benthic_situ_manova <- emmeans(benthic_situ.manova, ~seabird_level*rep.meas)
pairs(EMM_benthic_situ_manova, simple = "seabird_level", type = "response")
test(pairs(EMM_benthic_situ_manova, by = "rep.meas"), by = NULL, adjust = "mvt")


#plot:
plot_data_manova_situ<-emmip(benthic_situ.manova, ~ seabird_level*rep.meas,
          type = "response", CIs = TRUE, plotit=FALSE)

ggplot(data = plot_data_manova_situ, aes(x = rep.meas, y = yvar*100, color = seabird_level, fill = seabird_level))+
  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL*100, ymax = UCL*100), alpha = .3, linewidth = 5, size = 0,  position = position_dodge(.3)) + 
 # geom_point(data = fishn15.seabirds.cond.r, 
    #         aes(y = n15, x = species), size = 2.5, alpha = .5,  position = position_dodge(.3))+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
    ylab("% cover in situ")+
  xlab("")+
  labs(color = "seabird level", fill = "seabird level")+
  scale_x_discrete(label = c("hard coral", "pavement", "rubble", "sand", "macroalgae"))+
   theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.23,.92),
        legend.direction = "horizontal",
        legend.box.background = element_rect(colour = "black"))


#run individual lmms----
hard_coral.lmm<-lmer(coral_prop_cover~seabird_level*wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels)
summary(hard_coral.lmm)
Anova(hard_coral.lmm)
#can't use interaction because rank-deficient....

hard_coral.lmm<-lmer(coral_prop_cover~seabird_level+wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels)
summary(hard_coral.lmm)
Anova(hard_coral.lmm)
#no effect of seabird level

plot_summs(hard_coral.lmm)
#looks like low seabirds have higher coral cover than mid and high

benthic.situ.seabirds.levels%>%
  ggplot(aes(x = seabird_level, y = coral_prop_cover))+
  geom_boxplot()

```


##run lms with algae n15: VIDEO-----
```{r}

#now add algae n15:
algae_n15<-read.csv("../output/n15_seabirds_combined_no_iti.csv")
algae_n15


benthic.vid.seabirds.levels.algae<-left_join(benthic.vid.seabirds.levels, 
                                            select(algae_n15, c("site.name", "N.15_at_10m",  "N.15_at_20m", "N.15_at_30m", "N.15_at_40m")),
                                            by = "site.name")

benthic.vid.seabirds.levels.algae


##hard coral-----
hard_coral.vid.algae.lmm<-lmer(hard_coral_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
summary(hard_coral.vid.algae.lmm)
Anova(hard_coral.vid.algae.lmm) #NOTHING SIGNIFICANT****


##macroalgael-----
macro.vid.algae.lmm<-lmer(macroalgae_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
summary(macro.vid.algae.lmm)
Anova(macro.vid.algae.lmm) #NOTHING SIGNIFICANT****


##pavement-----
pave.vid.algae.lmm<-lmer(pavement_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
summary(pave.vid.algae.lmm)
Anova(pave.vid.algae.lmm) #NOTHING SIGNIFICANT****


##cca-----
cca.vid.algae.lmm<-lmer(cca_percent_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
summary(cca.vid.algae.lmm)
Anova(cca.vid.algae.lmm) #NOTHING SIGNIFICANT****



#NMDS1----
nmds.vid.algae.lmm<-lmer(NMDS1~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
summary(nmds.vid.algae.lmm)
Anova(nmds.vid.algae.lmm) #NOTHING SIGNIFICANT****


#NMDS2----
nmds2.vid.algae.lmm<-lmer(NMDS2~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.vid.seabirds.levels.algae)
summary(nmds2.vid.algae.lmm)
Anova(nmds2.vid.algae.lmm) #NOTHING SIGNIFICANT****


```



##run lms with algae n15: IN SITU-----
```{r}

#now add algae n15:
algae_n15


benthic.situ.seabirds.levels.algae<-left_join(benthic.situ.seabirds.levels, 
                                            select(algae_n15, c("site.name", "N.15_at_10m",  "N.15_at_20m", "N.15_at_30m", "N.15_at_40m")),
                                            by = "site.name")

benthic.situ.seabirds.levels.algae


##hard coral-----
hard_coral.situ.algae.lmm<-lmer(coral_prop_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels.algae)
summary(hard_coral.situ.algae.lmm)
Anova(hard_coral.situ.algae.lmm) #NOTHING SIGNIFICANT****


##macroalgael-----
macro.situ.algae.lmm<-lmer(macroalgae_prop_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels.algae)
summary(macro.situ.algae.lmm)
Anova(macro.situ.algae.lmm) #NOTHING SIGNIFICANT****


##pavement-----
pave.situ.algae.lmm<-lmer(pavement_prop_cover~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels.algae)
summary(pave.situ.algae.lmm)
Anova(pave.situ.algae.lmm) #NOTHING SIGNIFICANT****


##no cca-----


#NMDS1----
nmds.situ.algae.lmm<-lmer(NMDS1~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels.algae)
summary(nmds.situ.algae.lmm)
Anova(nmds.situ.algae.lmm) #NOTHING SIGNIFICANT****


#NMDS2----
nmds2.situ.algae.lmm<-lmer(NMDS2~N.15_at_30m+wind.exposure + (1|site.name), data = benthic.situ.seabirds.levels.algae)
summary(nmds2.situ.algae.lmm)
Anova(nmds2.situ.algae.lmm) #MARGINAL POSITIVE EFFECT OF N15 ON NMDS2****
#looks like sand is positive NMNDS2, hard coral and rubble are negative....

algae_n15

```



##re-plot NMDS with seabird levels, algae n15
```{r}
##video-----

##extract site/transect scores----
nmds_video_spp.sc <- as.data.frame(scores(nmds_video, "species"))  #Using the scores function from vegan to extract the species scores and convert to a data.frame
nmds_video_spp.sc<-
  nmds_video_spp.sc%>%
  rownames_to_column(var="Species") %>% # create a column of species, from the rownames of species.scores
    mutate(Species = str_remove(Species, '_percent_cover'))



nmds_video_site.sc <- scores(nmds_video, display = "sites", shrink = FALSE) 
nmds_video_site.sc

#merge site.sc with metadata and dispersion
nmds_video_site_scores2<-
  bind_cols(benthic.vid.seabirds$site.name,
                    as_tibble(nmds_video_site.sc))%>%
  rename('site.name' = '...1')%>%
  mutate(transect = c(1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4))%>%
  mutate(transect = as.factor(transect))
nmds_video_site_scores2

#combine with other metadata:
benthic.vid.seabirds.levels.algae.w.nmds<-
  right_join(nmds_video_site_scores2, benthic.vid.seabirds.levels.algae,
             by = c("site.name", "transect"))
benthic.vid.seabirds.levels.algae.w.nmds

#get hull data - seabird level:
sb.low <- benthic.vid.seabirds.levels.algae[benthic.vid.seabirds.levels.algae$seabird_level == "low", ][chull(benthic.vid.seabirds.levels.algae[benthic.vid.seabirds.levels.algae$seabird_level == 
    "low", c("NMDS1", "NMDS2")]), ]

sb.mid <- benthic.vid.seabirds.levels.algae[benthic.vid.seabirds.levels.algae$seabird_level == "mid", ][chull(benthic.vid.seabirds.levels.algae[benthic.vid.seabirds.levels.algae$seabird_level == 
    "mid", c("NMDS1", "NMDS2")]), ]

sb.high <- benthic.vid.seabirds.levels.algae[benthic.vid.seabirds.levels.algae$seabird_level == "high", ][chull(benthic.vid.seabirds.levels.algae[benthic.vid.seabirds.levels.algae$seabird_level == 
    "high", c("NMDS1", "NMDS2")]), ]


hull.data.vid2 <- rbind(sb.low, sb.mid, sb.high)  #combine
hull.data.vid2

ggplot() + 
  geom_text(data=nmds_video_spp.sc,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .2) +  # add the species labels - 
  geom_point(data=benthic.vid.seabirds.levels.algae,aes(x=NMDS1,y=NMDS2,colour=seabird_level, fill = seabird_level, pch = seabird_level), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data.vid2,aes(x=NMDS1,y=NMDS2,fill=seabird_level,group=seabird_level),alpha=0.30) + # add the convex hulls
  theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank()) #remove gray boxes
        #legend.title = element_blank()) #remove legend title
        #legend.box.background = element_rect(colour = "black", fill='white', linetype='solid', size=1), 
       # legend.justification=c(1,.9), legend.position=c(1,.9))  #  fix legend


##add arrows----
ord.fit.vid<-envfit(nmds_video ~ N.15_at_30m + wind.exposure + seabird_level, data = benthic.vid.seabirds.levels.algae, na.rm=TRUE)
ord.fit.vid #looks like seabird level is marginal

sb.scrs.vid <- as.data.frame(scores(ord.fit.vid, display = "vectors"))
sb.scrs.vid <- cbind(sb.scrs.vid, variable = rownames(sb.scrs.vid))
sb.scrs.vid<-
  sb.scrs.vid%>%
  mutate(variable2 = c("algae n15"))

sb.scrs.vid2 <- as.data.frame(scores(ord.fit.vid, display = "factors"))
sb.scrs.vid2 <- cbind(sb.scrs.vid2, Factor = rownames(sb.scrs.vid2))
sb.scrs.vid2



benthic_video_nmds_plot2<-
ggplot() + 
  geom_text(data=nmds_video_spp.sc,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .7, size = 3, hjust = .1) +  # add the species labels - 
  #  geom_point(data=nmds_fish_log_dens_spp.sc,aes(x=NMDS1,y=NMDS2,pch=species2), alpha = .7) +  # add the species labels - 
  geom_point(data=benthic.vid.seabirds.levels.algae,aes(x=NMDS1,y=NMDS2,colour=seabird_level, fill = seabird_level, pch = seabird_level), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data.vid2,aes(x=NMDS1,y=NMDS2,fill=seabird_level,group=seabird_level),alpha=0.30) + # add the convex hulls
    coord_fixed() + ## need aspect ratio of 1!
  geom_segment(data = sb.scrs.vid,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")), alpha = .5) +
    geom_text(data = sb.scrs.vid, aes(x = NMDS1, y = NMDS2, label = sb.scrs.vid$variable2),
            size = 3,  alpha = .5)+
   #   geom_text(data = sb.scrs2, aes(x = NMDS1, y = NMDS2, label = sb.scrs2$Factor),
     #       size = 3)+
  theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2, .9)) #remove gray boxes

benthic_video_nmds_plot2

##DOUBLE-CHECK SPECIES SCORES CORRECT WITH NON-ROTATED NMDS*** Okay does actualyl look right - everything rotated ~90 degrees clockwise compared to nmds.rotate results




###in situ nmds figure---------
##extract site/transect scores----
nmds_situ_spp.sc <- as.data.frame(scores(nmds_situ, "species"))  #Using the scores function from vegan to extract the species scores and convert to a data.frame
nmds_situ_spp.sc<-
  nmds_situ_spp.sc%>%
  rownames_to_column(var="Species") %>% # create a column of species, from the rownames of species.scores
    mutate(Species = str_remove(Species, '_prop_cover'))



nmds_situ_site.sc <- scores(nmds_situ, display = "sites", shrink = FALSE) 
nmds_situ_site.sc

#merge site.sc with metadata and dispersion
nmds_situ_site_scores2<-
  bind_cols(benthic.vid.seabirds$site.name,
                    as_tibble(nmds_situ_site.sc))%>%
  rename('site.name' = '...1')%>%
  mutate(transect = c(1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4,1,2,3,4))%>%
  mutate(transect = as.factor(transect))
nmds_situ_site_scores2

#combine with other metadata:
benthic.situ.seabirds.levels.algae.w.nmds<-
  right_join(nmds_situ_site_scores2, benthic.situ.seabirds.levels.algae,
             by = c("site.name", "transect"))
benthic.situ.seabirds.levels.algae.w.nmds

#get hull data - seabird level:
sb.low <- benthic.situ.seabirds.levels.algae[benthic.situ.seabirds.levels.algae$seabird_level == "low", ][chull(benthic.situ.seabirds.levels.algae[benthic.situ.seabirds.levels.algae$seabird_level == 
    "low", c("NMDS1", "NMDS2")]), ]

sb.mid <- benthic.situ.seabirds.levels.algae[benthic.situ.seabirds.levels.algae$seabird_level == "mid", ][chull(benthic.situ.seabirds.levels.algae[benthic.situ.seabirds.levels.algae$seabird_level == 
    "mid", c("NMDS1", "NMDS2")]), ]

sb.high <- benthic.situ.seabirds.levels.algae[benthic.situ.seabirds.levels.algae$seabird_level == "high", ][chull(benthic.situ.seabirds.levels.algae[benthic.situ.seabirds.levels.algae$seabird_level == 
    "high", c("NMDS1", "NMDS2")]), ]


hull.data.vid2 <- rbind(sb.low, sb.mid, sb.high)  #combine
hull.data.vid2

ggplot() + 
  geom_text(data=nmds_situ_spp.sc,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .2) +  # add the species labels - 
  geom_point(data=benthic.vid.seabirds.levels.algae,aes(x=NMDS1,y=NMDS2,colour=seabird_level, fill = seabird_level, pch = seabird_level), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data.vid2,aes(x=NMDS1,y=NMDS2,fill=seabird_level,group=seabird_level),alpha=0.30) + # add the convex hulls
  theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank()) #remove gray boxes
        #legend.title = element_blank()) #remove legend title
        #legend.box.background = element_rect(colour = "black", fill='white', linetype='solid', size=1), 
       # legend.justification=c(1,.9), legend.position=c(1,.9))  #  fix legend


##add arrows----
ord.fit.vid<-envfit(nmds_situ ~ N.15_at_30m + wind.exposure + seabird_level, data = benthic.vid.seabirds.levels.algae, na.rm=TRUE)
ord.fit.vid #looks like seabird level is marginal

sb.scrs.vid <- as.data.frame(scores(ord.fit.vid, display = "vectors"))
sb.scrs.vid <- cbind(sb.scrs.vid, variable = rownames(sb.scrs.vid))
sb.scrs.vid<-
  sb.scrs.vid%>%
  mutate(variable2 = c("algae n15"))

sb.scrs.vid2 <- as.data.frame(scores(ord.fit.vid, display = "factors"))
sb.scrs.vid2 <- cbind(sb.scrs.vid2, Factor = rownames(sb.scrs.vid2))
sb.scrs.vid2



benthic_situ_nmds_plot2<-
ggplot() + 
  geom_text(data=nmds_situ_spp.sc,aes(x=NMDS1,y=NMDS2,label=Species), alpha = .7, size = 3, hjust = .1) +  # add the species labels - 
  #  geom_point(data=nmds_fish_log_dens_spp.sc,aes(x=NMDS1,y=NMDS2,pch=species2), alpha = .7) +  # add the species labels - 
  geom_point(data=benthic.situ.seabirds.levels.algae,aes(x=NMDS1,y=NMDS2,colour=seabird_level, fill = seabird_level, pch = seabird_level), stat="identity", size=5, alpha = .9) +
  geom_polygon(data=hull.data.vid2,aes(x=NMDS1,y=NMDS2,fill=seabird_level,group=seabird_level),alpha=0.30) + # add the convex hulls
    coord_fixed() + ## need aspect ratio of 1!
  geom_segment(data = sb.scrs.vid,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")), alpha = .5) +
    geom_text(data = sb.scrs.vid, aes(x = NMDS1, y = NMDS2, label = sb.scrs.vid$variable2),
            size = 3,  alpha = .5)+
   #   geom_text(data = sb.scrs2, aes(x = NMDS1, y = NMDS2, label = sb.scrs2$Factor),
     #       size = 3)+
  theme_bw() + 
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.8, .2)) #remove gray boxes

benthic_situ_nmds_plot2

##DOUBLE-CHECK SPECIES SCORES CORRECT WITH NON-ROTATED NMDS*** Okay does actualyl look right - everything rotated ~90 degrees clockwise compared to nmds.rotate results





```

