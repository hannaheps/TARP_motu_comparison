---
title: "seabirds_vs_algae_N15"
author: "HEE"
date: "2024-06-04"
output: html_document
---

#Load libraries
```{r}
#library(plyr)
library(tidyverse)
library(corrplot)
library(nlme)
library(lme4)
library(car)
library(jtools)
library(emmeans)
library(sjPlot)

```


#Combine seabird and algaeN15 data
```{r}
##Bring in seabird data
seabirds <- read.csv("../../seabird_data/outputs/seabird_dens_bio_focal_data.csv")

seabirds$site.name <- paste(seabirds$Motu, seabirds$Exposure, sep = "_") 

##bring in algae data
algae <- read.csv("../../algae_isotopes/data/Tetiaroa_Turbinaria_Transects_November_2021_compiledMarch2023.csv")
algae$Distance_to_shore <- as.factor(algae$Distance_to_shore)
algae$Side[algae$Side=="leeward"] <- "Protected"
algae$Side[algae$Side == "windward"] <- "Exposed"
names(algae)[names(algae) == 'Side'] <- 'Exposure'

algae

#manipulate algae data frame to get average N15 per motu, site and distance from shore (Don't need this anymore - just read in csv below)-------
#sum.algae <- 
#  algae%>%
#  dplyr::group_by(Motu, Exposure, Distance_to_shore)%>%
#  dplyr::summarize(mean.N15 = mean(N15))
  

#sum.algae

#spread data to get values for each distance from shore
#sum.algae <- sum.algae %>% spread(Distance_to_shore, mean.N15)

#sum.algae <- sum.algae %>% dplyr::rename(c("N.15_at_10m" = "10", 
                                 #   "N.15_at_20m" = "20",  "N.15_at_30m" ="30",
                                  #  "N.15_at_40m" = "40"))


#Create a site.name that combines motu and exposure in order to merge with seabrid data
#sum.algae$site.name <-  paste(sum.algae$Motu, sum.algae$Exposure, sep = "_")


##Combine seabird and algae data
#algae.seabirds <- right_join(seabirds, sum.algae)
#algae.seabirds
#algae.seabirds <- algae.seabirds[,-1] #This is just to remove duplicate columns
#algae.seabirds <- algae.seabirds[,-c(2,7)] #Use this one for Iti data, it has slightly different column #s 
#algae.seabirds

#save combined data
#write.csv(algae.seabirds, "../output/n15_seabirds_combined_no_iti.csv")

#bring in csv instead:----
algae.seabirds<-read.csv("../output/n15_seabirds_combined_no_iti.csv")

algae.seabirds<-
  algae.seabirds%>%
  dplyr::select(-X)

```


#Correlation plot - all seabird metrics versus algae n15 at 4 distances:
```{r}
cor.mat_sb__algae<- cor(x = algae.seabirds[c(3:18)], y =algae.seabirds[c(20:23)], method = "spearman", use = "pairwise.complete.obs")
cor.mat_sb__algae

corrplot(cor.mat_sb__algae, type = "full",
         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", tl.cex = 0.5, cl.pos = "r", cl.ratio = .5)

#save plot:
#pdf(file = "../output/seabird-algaen15/corrplot_allseabirds_vs_algaen15_spearman.pdf")
#corrplot(cor.mat_sb__algae, type = "full",
#         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", tl.cex = 0.5, cl.pos = "r", cl.ratio = .5)
#dev.off()

```


#Expand the data to include all algae data for running linear models. 
#add restoration status
```{r}

algae$site.name<-paste(algae$Motu, algae$Exposure, sep = "_") #seabirds$Exposure,


##For some reason, with lmer, getting different results when join this way as opposed to before (only for models with restoration status, and distance to shore as factor)**
#I think has to do with coding of random effects (model srealting exposure to random effects groupings??)
#estimates are the same, but different standard errors, leading to different p-values....
###SOMETHING WEIRD HAPPENING WITH RANDOM EFFECTS.....DIFFERENT VARIANCE. THEN RESULTING IN HIGHER STD ERRORS IN MODEL WITH LEFT_JOIN DATA SHEET..........
#n15.all.seabirds <- 
#  left_join( dplyr::select(algae, c("site.name", "Motu", "Exposure", "Site", "Transect", "Distance_to_shore",  "N15")),
#            dplyr::select(seabirds, -c("X")),
#           by = c("site.name", "Motu", "Exposure"))%>%
   #make distance to shore continuous:
#  mutate(Distance_to_shore_c = as.double(Distance_to_shore)*10) %>%
#  relocate(Distance_to_shore_c, .after = Distance_to_shore) %>%
  #add restoration status:
#  mutate(reststat = case_when(Motu == "Aie" ~ "reference",
 #                             Motu == "Reiono" ~ "recovering",
 #                             Motu == "Rimatuu" ~ "unrestored"))%>%
#   mutate(reststat = fct_relevel(reststat, "reference", "recovering", "unrestored")) %>% # relevel factor
#  relocate(reststat, .after = Motu) #%>%
  #rename and re-level exposure:
 # mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
# mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))




```


###getting different results with above as with this - NO IDEA WHAT'S HAPPENING----
#This is original data - proceed for now with this......
```{r}
###getting different results with above as with this:----
n15.all.seabirds <- merge(algae, seabirds[,-1], by = c("site.name"), all = TRUE, no.dups = TRUE)
names(n15.all.seabirds)[names(n15.all.seabirds) == 'Exposure.x'] <- 'Exposure'
names(n15.all.seabirds)[names(n15.all.seabirds) == 'Motu.x'] <- 'Motu'

n15.all.seabirds$reststat <- n15.all.seabirds$Motu

n15.all.seabirds$reststat[n15.all.seabirds$reststat == "Aie"] <- "reference"
n15.all.seabirds$reststat[n15.all.seabirds$reststat == "Reiono"] <- "recovering"
n15.all.seabirds$reststat[n15.all.seabirds$reststat == "Rimatuu"] <- "unrestored"

n15.all.seabirds <- 
  n15.all.seabirds %>% 
  mutate(reststat = fct_relevel(reststat, "reference", "recovering", "unrestored"))%>%
  mutate(Distance_to_shore_c = as.double(Distance_to_shore)*10) %>% #make distance to shore continuous
 relocate(Distance_to_shore_c, .after = Distance_to_shore) 


###IF INCLUDE THESE 2 LINES (RECODING EXPOSURE), THEN RESULTS MATCH THOSE OBTAINED ABOVE (REGARDLESS OF WHETHER WE RECODE EXPOSURE ABOVE)
#%>%
#  mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
# mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))

```


##Plot by restoration status - "reference" "recovering" "unrestored" - boxplots
```{r}

N15.boxplot.exposure <- ggplot(data = n15.all.seabirds, aes(x = Distance_to_shore, y = N15, fill = reststat) )+
  geom_boxplot(alpha = 0.6) +
  geom_point(alpha = 0.5, position = position_dodge(width = 0.75), aes(group = reststat, color = reststat)) +
  ylab(expression(italic(delta)^15*N)) +
  scale_fill_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) + # red-yellow-green
  scale_colour_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) +
  xlab("Distance to Shore")+
  #labs(color='Distance \nFrom Shore (m)', fill = 'Distance \nFrom Shore (m)') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.title = element_blank(),
        legend.position = c(.88, .85))+
  facet_wrap(~Exposure)
N15.boxplot.exposure


```

#Let's make a line plot
```{r}

#with exposure:----
n15.line.sum.exp <- 
  n15.all.seabirds%>%
  dplyr::group_by(Distance_to_shore, reststat, Exposure)%>%
  dplyr::summarize( mean_n15 = mean(N15), 
             n_n15 = length(N15), 
             se_n15 = sd(N15)/sqrt(n_n15))%>%
  mutate(reststat = fct_relevel(reststat, "reference", "recovering", "unrestored"))


N15.lineplot.exposure <- ggplot(data = n15.line.sum.exp, aes(x = Distance_to_shore, y = mean_n15, fill = reststat, color = reststat, group = reststat) )+
  #geom_boxplot(alpha = 0.6) +
  geom_point(alpha = 0.9, size = 5, aes(color = reststat)) +
  geom_errorbar(aes(ymin = (mean_n15-se_n15), ymax = (mean_n15+se_n15)), alpha = .5, width = 0.1)+
  geom_line(alpha = .6, lwd = 1.2)+
  ylab(expression(Algal~italic(delta)^15*N)) +
  #scale_fill_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) + # red-yellow-green
  scale_colour_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) +
  xlab("Distance to Shore")+
  #labs(color='Distance \nFrom Shore (m)', fill = 'Distance \nFrom Shore (m)') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.title = element_blank(),
        legend.position = c(.88, .85),
        strip.text = element_text(hjust = 0, size = 12))+
  facet_wrap(~Exposure, strip.position = "top",  
             labeller = labeller (Exposure = c("leeward" = "a. Leeward", "windward" = "b. Windward")))

N15.lineplot.exposure

#ggsave(N15.lineplot.exposure, file = "../output/seabird-algaen15/N15_lineplot_exposure.jpg",
#    width = 7, height = 5)

N15.lineplot.exposure2 <- ggplot(data = n15.line.sum.exp, aes(x = Distance_to_shore, y = mean_n15, fill = reststat, color = reststat,  shape = Exposure, linetype = Exposure, group = interaction(reststat,Exposure)) )+
  #geom_boxplot(alpha = 0.6) +
  geom_errorbar(aes(ymin = (mean_n15-se_n15), ymax = (mean_n15+se_n15)), alpha = .5, width = 0.1, linetype = 1)+
  geom_line(alpha = .6, lwd = 1.2)+
    geom_point(size = 5, alpha = .9) +
  ylab(expression(Algae~italic(delta)^15*N)) +
  scale_linetype_manual(values = c(2,1))+
  #scale_fill_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) + # red-yellow-green
  scale_colour_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) +
  xlab("Distance to Shore")+
  #labs(color='Distance \nFrom Shore (m)', fill = 'Distance \nFrom Shore (m)') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.title = element_blank(),
        legend.position = c(.88, .85))+
  facet_wrap(~Exposure, strip.position = "top",  
             labeller = labeller (Exposure = c("leeward" = "a. leeward", "windward" = "b. windward")))

N15.lineplot.exposure2

```


#N15 restoration status models
```{r}
#run lmm, including 2-way interactions we're interested in: -----
mod.lmer.rest <- lmer(N15 ~ reststat*Distance_to_shore + reststat*Exposure +(1|site.name), data = n15.all.seabirds)

hist(resid(mod.lmer.rest))
plot(mod.lmer.rest) 
qqnorm(resid(mod.lmer.rest))
#diagnostics look good

#test statistics
summary(mod.lmer.rest)
Anova(mod.lmer.rest)
#Response: N15
#                             Chisq Df Pr(>Chisq)    
#reststat                   45.4162  2  1.374e-10 ***
#Distance_to_shore          60.0721  3  5.673e-13 ***
#Exposure                    0.1411  1   0.707207    
#reststat:Distance_to_shore 18.1174  6   0.005945 ** 
#reststat:Exposure          62.2489  2  3.040e-14 ***

##OR: 
#reststat                    4.5247  2   0.104103    
#Distance_to_shore          60.0721  3  5.673e-13 ***
#Exposure                    0.0050  1   0.943607    
#reststat:Distance_to_shore 18.1174  6   0.005945 ** 
#reststat:Exposure           6.2255  2   0.044480 *  

#compare to nlme:
mod.lme.rest <- lme(N15 ~ reststat*Distance_to_shore + reststat*Exposure, random = (~1|site.name), data = n15.all.seabirds)
Anova(mod.lme.rest)
#reststat                   13.5694  2   0.001131 ** 
#Distance_to_shore          60.0721  3  5.673e-13 ***
#Exposure                    0.0203  1   0.886753    
#reststat:Distance_to_shore 18.1174  6   0.005945 ** 
#reststat:Exposure          18.6516  2  8.910e-05 ***

#identical, so that's good (but only if use data merged in original way, if use other way then both nlme's are identical, but nlme is different than lmer.


#likelihood ratio test-----
mod.lmer.add.exp<- lmer(N15 ~ reststat*Distance_to_shore + Exposure +(1|site.name), data = n15.all.seabirds)
anova(mod.lmer.rest, mod.lmer.add.exp)
#super significant (p<0.001) (for both dataframes, but get warning message with original one...)

mod.lmer.add.dist<- lmer(N15 ~ Distance_to_shore + reststat*Exposure +(1|site.name), data = n15.all.seabirds)
anova(mod.lmer.rest, mod.lmer.add.dist)
#also very significant (p = 0.003) (for both dataframes, but get warning message with original one...)

```


#post-hoc tests on rest status*exposure
```{r}

#extract pair-wise differences:
emmeans(mod.lmer.rest, list(pairwise ~ reststat|Distance_to_shore|Exposure), type = "response", adjust = "fdr")
###On exposed side, no differences between restoration status********
##One protected side, all distances different between recovering/reference and unrestored*******


#$`pairwise differences of reststat | Distance_to_shore, Exposure`
#Distance_to_shore = 10, Exposure = Exposed:
# 3                       estimate    SE    df t.ratio p.value
# reference - recovering     0.541 0.588 131.3   0.919  0.3596
# reference - unrestored     1.118 0.588 131.3   1.901  0.1783
# recovering - unrestored    0.578 0.576 138.3   1.003  0.3596

#Distance_to_shore = 20, Exposure = Exposed:
# 3                       estimate    SE    df t.ratio p.value
# reference - recovering     0.780 0.583 134.0   1.338  0.4699
# reference - unrestored     0.198 0.583 134.0   0.340  0.7348
# recovering - unrestored   -0.583 0.576 138.3  -1.012  0.4699

#Distance_to_shore = 30, Exposure = Exposed:
# 3                       estimate    SE    df t.ratio p.value
# reference - recovering     0.697 0.583 134.0   1.196  0.3510
# reference - unrestored    -0.304 0.583 134.0  -0.521  0.6034
# recovering - unrestored   -1.001 0.576 138.3  -1.739  0.2528

#Distance_to_shore = 40, Exposure = Exposed:
# 3                       estimate    SE    df t.ratio p.value
# reference - recovering     0.459 0.714  93.6   0.643  0.5217
# reference - unrestored    -1.052 0.714  93.6  -1.473  0.2163
# recovering - unrestored   -1.511 0.576 138.3  -2.625  0.0289

#Distance_to_shore = 10, Exposure = Protected:
# 3                       estimate    SE    df t.ratio p.value
# reference - recovering    -0.487 0.608 122.3  -0.801  0.4246
# reference - unrestored     4.946 0.608 122.3   8.138  <.0001
# recovering - unrestored    5.433 0.576 138.3   9.439  <.0001

#Distance_to_shore = 20, Exposure = Protected:
# 3                       estimate    SE    df t.ratio p.value
# reference - recovering    -0.247 0.583 134.0  -0.424  0.6724
# reference - unrestored     4.025 0.583 134.0   6.903  <.0001
# recovering - unrestored    4.272 0.576 138.3   7.424  <.0001

#Distance_to_shore = 30, Exposure = Protected:
# 3                       estimate    SE    df t.ratio p.value
# reference - recovering    -0.330 0.583 134.0  -0.567  0.5718
# reference - unrestored     3.524 0.583 134.0   6.043  <.0001
# recovering - unrestored    3.854 0.576 138.3   6.697  <.0001

#Distance_to_shore = 40, Exposure = Protected:
# 3                       estimate    SE    df t.ratio p.value
 #reference - recovering    -0.568 0.627 115.0  -0.907  0.3664
# reference - unrestored     2.776 0.627 115.0   4.429  <.0001
# recovering - unrestored    3.344 0.576 138.3   5.811  <.0001

#Degrees-of-freedom method: kenward-roger 
#P value adjustment: fdr method for 3 tests 

#repeat with different df (asymptotic):
emmeans(mod.lmer.rest, list(pairwise ~ reststat|Distance_to_shore|Exposure), type = "response", adjust = "fdr",
        lmer.df = "asymptotic")
#identical results!

#if want to do with nlme, use this:
emmeans(mod.lme.rest, list(pairwise ~ reststat|Distance_to_shore|Exposure), type = "response", adjust = "fdr",
        mode = "asymptotic")
#similar results!

emmeans(mod.lmer.rest, list(pairwise ~ Distance_to_shore|Exposure|reststat), type = "response", adjust = "fdr")

#$`pairwise differences of Distance_to_shore | reststat, Exposure`
#reststat = reference, Exposure = Exposed:
# 3                                         estimate    SE df t.ratio p.value
# Distance_to_shore10 - Distance_to_shore20   1.2086 0.426 53   2.836  0.0101
# Distance_to_shore10 - Distance_to_shore30   1.8886 0.426 53   4.431  0.0001
# Distance_to_shore10 - Distance_to_shore40   2.6881 0.552 53   4.870  0.0001
# Distance_to_shore20 - Distance_to_shore30   0.6800 0.405 53   1.679  0.1189
 #Distance_to_shore20 - Distance_to_shore40   1.4795 0.525 53   2.819  0.0101
# Distance_to_shore30 - Distance_to_shore40   0.7995 0.525 53   1.524  0.1336

#reststat = recovering, Exposure = Exposed:
# 3                                         estimate    SE df t.ratio p.value
# Distance_to_shore10 - Distance_to_shore20   1.4483 0.405 53   3.576  0.0015
# Distance_to_shore10 - Distance_to_shore30   2.0450 0.405 53   5.049  <.0001
# Distance_to_shore10 - Distance_to_shore40   2.6067 0.405 53   6.436  <.0001
# Distance_to_shore20 - Distance_to_shore30   0.5967 0.405 53   1.473  0.1713
 #Distance_to_shore20 - Distance_to_shore40   1.1583 0.405 53   2.860  0.0091
# Distance_to_shore30 - Distance_to_shore40   0.5617 0.405 53   1.387  0.1713

#reststat = unrestored, Exposure = Exposed:
# 3                                         estimate    SE df t.ratio p.value
# Distance_to_shore10 - Distance_to_shore20   0.2883 0.405 53   0.712  0.7938
# Distance_to_shore10 - Distance_to_shore30   0.4667 0.405 53   1.152  0.7633
# Distance_to_shore10 - Distance_to_shore40   0.5183 0.405 53   1.280  0.7633
# Distance_to_shore20 - Distance_to_shore30   0.1783 0.405 53   0.440  0.7938
# Distance_to_shore20 - Distance_to_shore40   0.2300 0.405 53   0.568  0.7938
# Distance_to_shore30 - Distance_to_shore40   0.0517 0.405 53   0.128  0.8990

#reststat = reference, Exposure = Protected:
# 3                                         estimate    SE df t.ratio p.value
# Distance_to_shore10 - Distance_to_shore20   1.2086 0.426 53   2.836  0.0101
# Distance_to_shore10 - Distance_to_shore30   1.8886 0.426 53   4.431  0.0001
# Distance_to_shore10 - Distance_to_shore40   2.6881 0.552 53   4.870  0.0001
# Distance_to_shore20 - Distance_to_shore30   0.6800 0.405 53   1.679  0.1189
# Distance_to_shore20 - Distance_to_shore40   1.4795 0.525 53   2.819  0.0101
 #Distance_to_shore30 - Distance_to_shore40   0.7995 0.525 53   1.524  0.1336

#reststat = recovering, Exposure = Protected:
# 3                                         estimate    SE df t.ratio p.value
# Distance_to_shore10 - Distance_to_shore20   1.4483 0.405 53   3.576  0.0015
# Distance_to_shore10 - Distance_to_shore30   2.0450 0.405 53   5.049  <.0001
# Distance_to_shore10 - Distance_to_shore40   2.6067 0.405 53   6.436  <.0001
# Distance_to_shore20 - Distance_to_shore30   0.5967 0.405 53   1.473  0.1713
# Distance_to_shore20 - Distance_to_shore40   1.1583 0.405 53   2.860  0.0091
# Distance_to_shore30 - Distance_to_shore40   0.5617 0.405 53   1.387  0.1713

#reststat = unrestored, Exposure = Protected:
# 3                                         estimate    SE df t.ratio p.value
# Distance_to_shore10 - Distance_to_shore20   0.2883 0.405 53   0.712  0.7938
# Distance_to_shore10 - Distance_to_shore30   0.4667 0.405 53   1.152  0.7633
# Distance_to_shore10 - Distance_to_shore40   0.5183 0.405 53   1.280  0.7633
# Distance_to_shore20 - Distance_to_shore30   0.1783 0.405 53   0.440  0.7938
# Distance_to_shore20 - Distance_to_shore40   0.2300 0.405 53   0.568  0.7938
# Distance_to_shore30 - Distance_to_shore40   0.0517 0.405 53   0.128  0.8990

#Degrees-of-freedom method: kenward-roger 
#P value adjustment: fdr method for 6 tests 


###Offshore gradient in n15 around BOTH exposed and protected sides for recovering and reference, but no offshore gradient on either side for unrestored (BUT NO INTERACTION BETWEEN SIDE*DISTANCE)*****

#repeat with asymptotic df:
emmeans(mod.lmer.rest, list(pairwise ~ Distance_to_shore|reststat|Exposure), type = "response", adjust = "fdr",
        lmer.df = "asymptotic")
#no change to results***


##
emmeans(mod.lmer.rest, list(pairwise ~ Exposure|reststat|Distance_to_shore), type = "response", adjust = "fdr",
        lmer.df = "asymptotic")
#reststat = reference, Distance_to_shore = 10:
# 3                   estimate    SE  df z.ratio p.value
# Exposed - Protected   -0.879 0.493 Inf  -1.782  0.0748

#reststat = recovering, Distance_to_shore = 10:
# 3                   estimate    SE  df z.ratio p.value
# Exposed - Protected   -1.907 0.456 Inf  -4.179  <.0001

#reststat = unrestored, Distance_to_shore = 10:
# 3                   estimate    SE  df z.ratio p.value
# Exposed - Protected    2.948 0.456 Inf   6.462  <.0001


##and same for every distance to shore.....so equivalent to this:
emmeans(mod.lmer.rest, list(pairwise ~ Exposure|reststat), type = "response", adjust = "fdr",
        lmer.df = "asymptotic")
#SO: reference and recovering have higher n15 values at each distance on protected side (marginal for reference)
#wherease unrestored has higher n15 values on exposed side. 



##plot-----
plot.data.rest <-emmip(mod.lmer.rest, ~ reststat*Distance_to_shore|Exposure,
          type = "response", CIs = TRUE, plotit=FALSE)

plot.data.rest



response.plot.rest<-
  ggplot(data = plot.data.rest, aes(x = Distance_to_shore, y = yvar, color = reststat, fill = reststat, group = reststat) )+
#  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL, ymax = UCL), alpha = .3, linewidth = 2, size = 0.2, position = position_dodge(.1)) + #,  position = position_dodge(.3) 
 # geom_point(data = fishn15.seabirds.cond.r, 
           #  aes(y = n15, x = seabird_level), size = 2.5, alpha = .5,  position = position_dodge(.3))+ 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  facet_wrap(~Exposure)+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
  ylab(expression(italic(delta)^15*N))+
#scale_y_continuous(labels = scales::label_percent(accuracy = .1, scale = 1),  limits = c(0, 100), expand = expansion(0, 0))+
  scale_fill_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E"))+ #low-mid-high = red-yellow-green
    scale_colour_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E"))+#low-mid-high = red-yellow-green
  xlab("Distance From Shore (m)")+
  #labs(color='Seabird Level', fill = 'Seabird Level') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.title = element_blank() ,
        legend.position = c(0.88, 0.88) )

response.plot.rest

#ggsave(response.plot.rest, file = "../output/seabird-algaen15/n15_restorationstat_by_distance_model.jpg", width = 7, height = 5)




```

##repeat with distance to shore (continuous)
```{r}
mod.lmer.rest.c <- lmer(N15 ~ reststat*Distance_to_shore_c + reststat*Exposure +(1|site.name), data = n15.all.seabirds)

hist(resid(mod.lmer.rest.c))
plot(mod.lmer.rest.c) 
qqnorm(resid(mod.lmer.rest.c))
#diagnostics look good

#test statistics
summary(mod.lmer.rest.c)
Anova(mod.lmer.rest.c)
#Response: N15
#                             Chisq Df Pr(>Chisq)    
#reststat                      4.6947  2    0.09562 .  
#Distance_to_shore_c          59.1673  1  1.448e-14 ***
#Exposure                      0.0041  1    0.94870    
#reststat:Distance_to_shore_c 18.4517  2  9.846e-05 ***
#reststat:Exposure             6.5956  2    0.03696 *  

###hmm, these results more match using second dataframe above.....


#compare to nlme:
mod.lme.rest.c <- lme(N15 ~ reststat*Distance_to_shore_c + reststat*Exposure, random = (~1|site.name), data = n15.all.seabirds)
Anova(mod.lme.rest.c)
#reststat                     13.8805  2   0.000968 ***
#Distance_to_shore_c          59.1673  1  1.448e-14 ***
#Exposure                      0.0162  1   0.898768    
#reststat:Distance_to_shore_c 18.4517  2  9.846e-05 ***
#reststat:Exposure            19.4843  2  5.875e-05 ***

##different results with nlme versus lme4....goes back to something weird happening above***


###extract emmeans, lmer:-----

emmeans(mod.lmer.rest.c, list(pairwise ~ reststat|Exposure|Distance_to_shore_c), adjust = "fdr")
#at mean distance to shore, sig differences between reference-unrestored and recovering-unrestored only on protected side. no sig differences on exposed side

emmeans(mod.lmer.rest.c, list(pairwise ~ reststat|Exposure|Distance_to_shore_c), adjust = "fdr", lmer.df = "asymptotic")
#identical results*

emmeans(mod.lmer.rest.c, list(pairwise ~ reststat|Distance_to_shore_c|Exposure), type = "response", adjust = "fdr",
         at = list(Distance_to_shore_c = c(10, 20, 30, 40)))
#or can extract for each distance to shore....now results simular to models with distance to shore as factor

emmeans(mod.lmer.rest.c, list(pairwise ~ reststat|Distance_to_shore_c|Exposure), type = "response", adjust = "fdr", lmer.df = "asymptotic",
         at = list(Distance_to_shore_c = c(10, 20, 30, 40)))
#identical results as non-asymptotic

emmeans(mod.lmer.rest.c, list(pairwise ~ Distance_to_shore_c|Exposure|reststat), type = "response", adjust = "fdr",
         at = list(Distance_to_shore_c = c(10, 20, 30, 40)))
emmeans(mod.lmer.rest.c, list( ~ Distance_to_shore_c|Exposure|reststat), type = "response", adjust = "fdr",
         at = list(Distance_to_shore_c = c(10, 20, 30, 40)))
#results on exposed and protected sides identical (because no interaction)...but overall for reference and recovering motu - decreasing n15 with increasing distance to shore. no pattern on unrestored motu. 
#BUT do get different emmeans

###extract emmeans, lme:-----
emmeans(mod.lme.rest.c, list(pairwise ~ reststat|Exposure|Distance_to_shore_c), adjust = "fdr", mode = "asymptotic")
#lower p-values than above, but conclusions identical (doesn't work without asymptotic.....)

#same results/conclusions as above....

emmeans(mod.lme.rest.c, list(pairwise ~ reststat|Distance_to_shore_c|Exposure), type = "response", adjust = "fdr",
         at = list(Distance_to_shore_c = c(10, 20, 30, 40)), mode = "asymptotic")
#lower p-values than lmer model..



```


#Run models with seabird breeding biomass as predictor----
```{r}
#compare log versus non-log:----
n15.all.seabirds2<-
  n15.all.seabirds%>%
  mutate(log_breeding_biomass_kgha_side = log(breeding_biomass_kgha_side))

n15.all.seabirds2%>%
  ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15))+
  geom_point()+
  geom_smooth(method = "lm")

n15.all.seabirds2%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = N15))+
  geom_point()+
  geom_smooth(method = "lm")

n15.all.seabirds2%>%
  ggplot(aes(x = log_breeding_biomass_kgha_side, y = log(N15)))+
  geom_point()+
  geom_smooth(method = "lm")


mod.lmer.breeding<- lmer(N15 ~ breeding_biomass_kgha_side*Distance_to_shore + breeding_biomass_kgha_side*Exposure + (1|site.name), n15.all.seabirds2)
plot(mod.lmer.breeding)
qqnorm(resid(mod.lmer.breeding))
hist(resid(mod.lmer.breeding))

mod.lmer.breeding.log <- lmer(N15 ~ log_breeding_biomass_kgha_side*Distance_to_shore + log_breeding_biomass_kgha_side*Exposure + (1|site.name), n15.all.seabirds2)
plot(mod.lmer.breeding.log)
qqnorm(resid(mod.lmer.breeding.log))
hist(resid(mod.lmer.breeding.log))

#both look fairly reasonable, log looks better though


#test statistics----
summary(mod.lmer.breeding)
Anova(mod.lmer.breeding)
#breeding_biomass_kgha_side                    4.8213  1    0.02811 *  
#Distance_to_shore                            67.9727  3  1.160e-14 ***
#Exposure                                      1.2368  1    0.26609    
#breeding_biomass_kgha_side:Distance_to_shore 24.2719  3  2.192e-05 ***
#breeding_biomass_kgha_side:Exposure           0.8127  1    0.36733  


summary(mod.lmer.breeding.log)
Anova(mod.lmer.breeding.log)
#log_breeding_biomass_kgha_side                     20.6547  1  5.500e-06 ***
#Distance_to_shore                                  68.2012  3  1.036e-14 ***
#Exposure                                           0.5241  1  0.4691040    
#log_breeding_biomass_kgha_side:Distance_to_shore   23.9758  3  2.527e-05 ***
#log_breeding_biomass_kgha_side:Exposure            11.2675  1  0.0007888 ***



#look at emmeans:---
emtrends(mod.lmer.breeding.log,  ~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side", adjust = "fdr")
#looks like positive trends on protected side, negative on exposed side. larger effects at closer distances
test(emtrends(mod.lmer.breeding.log, pairwise~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side",  adjust = "fdr", type = "response"))

emtrends(mod.lmer.breeding,  ~ Distance_to_shore|Exposure, var = "breeding_biomass_kgha_side", adjust = "fdr")


test(emtrends(mod.lmer.breeding.log, ~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side",  adjust = "fdr", type = "response"))
#all protected side p-values significant, nothing significant on exposed side...

test(emtrends(mod.lmer.breeding, ~ Distance_to_shore|Exposure, var = "breeding_biomass_kgha_side",  adjust = "fdr", type = "response"))
#neither significant

#Exposure = Exposed:
# Distance_to_shore log(breeding_biomass_kgha_side).trend    SE   df t.ratio p.value
# 10                                                0.271 0.288 2.38   0.939  0.6460
# 20                                               -0.057 0.287 2.36  -0.198  0.8587
# 30                                               -0.237 0.287 2.36  -0.825  0.6460
# 40                                               -0.395 0.290 2.44  -1.360  0.6460

#Exposure = Protected:
# Distance_to_shore log(breeding_biomass_kgha_side).trend    SE   df t.ratio p.value
# 10                                                1.366 0.197 3.11   6.931  0.0220
# 20                                                1.038 0.195 2.96   5.334  0.0266
# 30                                                0.858 0.195 2.96   4.408  0.0297
# 40                                                0.701 0.195 3.00   3.587  0.0371

#Degrees-of-freedom method: kenward-roger 
#P value adjustment: fdr method for 4 tests 

#back transform estimates: because x log-transformed, need to raise trend log(2^(coef)) so each doubling of seabird biomass is associated with a change in mean algal n15 of log(2^coef) units
log(2^1.366) #0.946839
log(2^1.038) #0.7194868
log(2^0.858) #0.5947203
log(2^0.701) #0.4858962



emtrends(mod.lmer.breeding.log,  pairwise~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side", adjust = "fdr")
#On exposed side, effect of seabirds is different at 10 vs. all other distances, and at 20 vs. 40 m
#On protected side - same pattern. (because no distance*exposure interaction?!)

#$contrasts
#Exposure = Exposed:
# contrast                                  estimate    SE   df t.ratio p.value
# Distance_to_shore10 - Distance_to_shore20    0.328 0.141 56.0   2.322  0.0358
 #Distance_to_shore10 - Distance_to_shore30    0.508 0.141 56.0   3.599  0.0020
# Distance_to_shore10 - Distance_to_shore40    0.665 0.143 56.1   4.646  0.0001
 #Distance_to_shore20 - Distance_to_shore30    0.180 0.138 56.0   1.304  0.2371
 #Distance_to_shore20 - Distance_to_shore40    0.338 0.140 56.1   2.411  0.0358
 #Distance_to_shore30 - Distance_to_shore40    0.157 0.140 56.1   1.124  0.2656

#Exposure = Protected:
# contrast                                  estimate    SE   df t.ratio p.value
 #Distance_to_shore10 - Distance_to_shore20    0.328 0.141 56.0   2.322  0.0358
 #Distance_to_shore10 - Distance_to_shore30    0.508 0.141 56.0   3.599  0.0020
 #Distance_to_shore10 - Distance_to_shore40    0.665 0.143 56.1   4.646  0.0001
 #Distance_to_shore20 - Distance_to_shore30    0.180 0.138 56.0   1.304  0.2371
 #Distance_to_shore20 - Distance_to_shore40    0.338 0.140 56.1   2.411  0.0358
 #Distance_to_shore30 - Distance_to_shore40    0.157 0.140 56.1   1.124  0.2656

#Degrees-of-freedom method: kenward-roger 
#P value adjustment: fdr method for 6 tests 

emtrends(mod.lmer.breeding,  pairwise~ Distance_to_shore|Exposure, var = "breeding_biomass_kgha_side", adjust = "fdr")


emtrends(mod.lmer.breeding.log,  ~ Exposure|Distance_to_shore, var = "log_breeding_biomass_kgha_side", adjust = "fdr")
emtrends(mod.lmer.breeding.log,  pairwise~ Exposure|Distance_to_shore, var = "log_breeding_biomass_kgha_side", adjust = "fdr")


range(n15.all.seabirds2$log_breeding_biomass_kgha_side)
 mean(n15.all.seabirds2$log_breeding_biomass_kgha_side)
emmeans(mod.lmer.breeding.log, list(pairwise ~ log_breeding_biomass_kgha_side|Distance_to_shore|Exposure), type = "response", adjust = "fdr", lmer.df = "asymptotic",
         at = list(log_breeding_biomass_kgha_side = c(1.68, 4.09, 5.94)))


emmeans(mod.lmer.breeding.log, list( ~ log_breeding_biomass_kgha_side|Distance_to_shore|Exposure), type = "response", adjust = "fdr", lmer.df = "asymptotic",
         at = list(log_breeding_biomass_kgha_side = c(1.68, 4.09, 5.94)))


emmeans(mod.lmer.breeding.log, list(pairwise ~ Distance_to_shore|Exposure|log_breeding_biomass_kgha_side), type = "response", adjust = "fdr", lmer.df = "asymptotic",
         at = list(log_breeding_biomass_kgha_side = c(1.68, 4.09, 5.94)))
#at the lowest seabird biomass, there was no effect of distance to shore. At mid and high biomass, there is decline with distance to shore. Same effect on exposed and protected (because no interaction in model). 



#check emmip plot----
emmip(mod.lmer.breeding.log, Distance_to_shore ~ log_breeding_biomass_kgha_side|Exposure, CIs = TRUE,
      at = list(log_breeding_biomass_kgha_side = seq(log(5.39), log(378), by = log(10))), type = "response")

emmip(mod.lmer.breeding, Distance_to_shore ~ breeding_biomass_kgha_side|Exposure, CIs = TRUE,
      at = list(breeding_biomass_kgha_side = seq(5.39, 379, by = 100)), type = "response")


```


#Proceed with log model - exposure interaction plots
```{r}

#plot raw data + lines: 
range(n15.all.seabirds2$breeding_biomass_kgha_side)
range(n15.all.seabirds2$log_breeding_biomass_kgha_side)


plot_dat2.log<-emmip(mod.lmer.breeding.log, Distance_to_shore ~ log_breeding_biomass_kgha_side|Exposure, 
                     at = list(log_breeding_biomass_kgha_side = seq(1.68, 5.94, by = .01)), CIs = TRUE, plotit=FALSE)

plot_dat2.log

#rename and relvel exposure:
plot_dat2.log<-
  plot_dat2.log%>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))

#limit to correct range per group:
range(n15.all.seabirds2[n15.all.seabirds2$Exposure == "Protected",]$log_breeding_biomass_kgha_side)
range(n15.all.seabirds2[n15.all.seabirds2$Exposure == "Exposed",]$log_breeding_biomass_kgha_side)

plot_dat2.log.protected<-
  plot_dat2.log%>%
  filter(Exposure == "leeward")%>%
  filter(log_breeding_biomass_kgha_side>=1.6&log_breeding_biomass_kgha_side<=6)

plot_dat2.log.exposed<-
  plot_dat2.log%>%
  filter(Exposure == "windward")%>%
  filter(log_breeding_biomass_kgha_side>=2.2&log_breeding_biomass_kgha_side<=4.9)


n15.all.seabirds2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())



n15.all.seabirds2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = exp(log_breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("seabird breeding biomass (kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


#save panels seperately to combine with other model:----
n15.all.seabirds2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
  filter(Exposure == "leeward")%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


n15.all.seabirds2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())

n15.all.seabirds2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = exp(log_breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5, size = 4, aes(shape = Exposure))+
   geom_ribbon(data = plot_dat2.log.protected, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore), lty = 1)+
   geom_line(data = plot_dat2.log.exposed, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore), lty = 2)+
  theme_bw() +
   xlab("seabird breeding biomass (kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


n15.all.seabirds2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = exp(log_breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


#try plotting with distance to shore on x-axis instead-----
plot_dat2.log.dist<-emmip(mod.lmer.breeding.log, Distance_to_shore ~ log_breeding_biomass_kgha_side|Exposure, 
                     at = list(log_breeding_biomass_kgha_side = c(1.68, 4.09, 5.94)), CIs = TRUE, plotit=FALSE)
#at min, mean, max seabird biomass

plot_dat2.log.dist

#rename and relvel exposure:
plot_dat2.log.dist<-
  plot_dat2.log.dist%>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))


n15.all.seabirds2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = Distance_to_shore, y = N15))+
 # geom_point(aes(color = log_breeding_biomass_kgha_side, fill = log_breeding_biomass_kgha_side, group = log_breeding_biomass_kgha_side), alpha = .5)+
   geom_ribbon(data = plot_dat2.log.dist, aes(x = Distance_to_shore, y = yvar, ymin = LCL, ymax=UCL, fill = as.factor(log_breeding_biomass_kgha_side), group = as.factor(log_breeding_biomass_kgha_side)), alpha = .2, lwd=0)+
   geom_line(data = plot_dat2.log.dist, aes(x = Distance_to_shore, y = yvar, color = as.factor(log_breeding_biomass_kgha_side), group = as.factor(log_breeding_biomass_kgha_side)))+
  theme_bw() +
  facet_wrap(~Exposure)+
 #  xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  #scale_fill_viridis_c()+
  #scale_color_viridis_c()+
#  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())

#nope, not going to work

##just plot 10 and 30 m to make easier to see-----
plot_dat2.log.red<-
  plot_dat2.log%>%
  filter(Distance_to_shore == "10"| Distance_to_shore == "40")

plot_dat2.log.protected.red<-
  plot_dat2.log.red%>%
  filter(Exposure == "leeward")%>%
  filter(log_breeding_biomass_kgha_side>=1.6&log_breeding_biomass_kgha_side<=6)

plot_dat2.log.exposed.red<-
  plot_dat2.log.red%>%
  filter(Exposure == "windward")%>%
  filter(log_breeding_biomass_kgha_side>=2.2&log_breeding_biomass_kgha_side<=4.9)


n15.all.seabirds2 %>%
  filter(Distance_to_shore == "10"| Distance_to_shore == "40")%>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())

```


##Check if seabird biomass on Iti explains exposed side of Rimatuu patterns-----
```{r}
#Bring in seabird data, with Iti----
seabirds2 <- read.csv("../../seabird_data/outputs/seabird_dens_bio_by_side_iti_rimatuu_exposed_combined.csv")

seabirds2$site.name <- paste(seabirds2$Motu, seabirds2$Exposure, sep = "_")


##combine with algae data:----
n15.all.seabirds.iti <- merge(algae, seabirds2[,-1], by = c("site.name", 
                                                             "Motu", "Exposure"), all = TRUE, no.dups = TRUE)

#make sure distance to shore is a factor
n15.all.seabirds.iti$Distance_to_shore_f <- as.factor(n15.all.seabirds$Distance_to_shore)

n15.all.seabirds.iti$breeding_biomass_kgha_side
n15.all.seabirds$breeding_biomass_kgha_side
#yup, changes Rimatuu exposed from ~9 kg/ha to ~500 kg/ha

```

##re-run models with iti included, biomass/side:
```{r}
#again, quick look at log versus non-log----
n15.all.seabirds.iti2<-
  n15.all.seabirds.iti%>%
    mutate(log_breeding_biomass_kgha_side = log(breeding_biomass_kgha_side))

n15.all.seabirds.iti2%>%
  ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15))+
  geom_point()+
  geom_smooth(method = "lm")

n15.all.seabirds.iti2%>%
  ggplot(aes(x = breeding_biomass_kgha_side, y = N15))+
  geom_point()+
  geom_smooth(method = "lm")

n15.all.seabirds.iti2%>%
  ggplot(aes(x = log_breeding_biomass_kgha_side, y = log(N15)))+
  geom_point()+
  geom_smooth(method = "lm")

#visually, log fit looks best, although big gap between data points

mod.lmer.breeding.iti<- lmer(N15 ~ breeding_biomass_kgha_side*Distance_to_shore + breeding_biomass_kgha_side*Exposure + (1|site.name), n15.all.seabirds.iti2)
plot(mod.lmer.breeding.iti)
qqnorm(resid(mod.lmer.breeding.iti))
hist(resid(mod.lmer.breeding.iti))

mod.lmer.breeding.log.iti <- lmer(N15 ~ log_breeding_biomass_kgha_side*Distance_to_shore + log_breeding_biomass_kgha_side*Exposure + (1|site.name), n15.all.seabirds.iti2)
plot(mod.lmer.breeding.log.iti)
qqnorm(resid(mod.lmer.breeding.log.iti))
hist(resid(mod.lmer.breeding.log.iti))

#both look fairly reasonable, can't really tell the difference


#test statistics----
summary(mod.lmer.breeding.iti)
Anova(mod.lmer.breeding.iti)
#breeding_biomass_kgha_side                    2.6842  1    0.10135    
#Distance_to_shore                            48.0597  3  2.068e-10 ***
#Exposure                                      0.0125  1    0.91112    
#breeding_biomass_kgha_side:Distance_to_shore  0.5972  3    0.89708    
#breeding_biomass_kgha_side:Exposure           2.7083  1    0.09983 . 


summary(mod.lmer.breeding.log.iti)
Anova(mod.lmer.breeding.log.iti)
#log_breeding_biomass_kgha_side                   26.2179  1   3.05e-07 ***
#Distance_to_shore                                51.1976  3   4.44e-11 ***
#Exposure                                          1.9617  1     0.1613    
#log_breeding_biomass_kgha_side:Distance_to_shore  3.6329  3     0.3039    
#log_breeding_biomass_kgha_side:Exposure           1.9543  1     0.1621    


#look at emmeans:---
emtrends(mod.lmer.breeding.log.iti,  ~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side", adjust = "fdr")
#looks like positive trends on BOTH SIDES. larger effects at closer distances

test(emtrends(mod.lmer.breeding.log.iti, ~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side",  adjust = "fdr", type = "response"))
#all protected side p-values significant, nothing significant on exposed side...weird that they're not both sig

test(emtrends(mod.lmer.breeding.log.iti, ~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side",  adjust = "fdr", type = "response", lmer.df = "asymptotic"))
#now more sig on protected, still ns on exposed


test(emtrends(mod.lmer.breeding.log.iti, pairwise~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side",  adjust = "fdr", type = "response"))
#no distances sig different than each other


range(n15.all.seabirds.iti2$log_breeding_biomass_kgha_side)
 mean(n15.all.seabirds.iti2$log_breeding_biomass_kgha_side)
emmeans(mod.lmer.breeding.log.iti, list(pairwise ~ log_breeding_biomass_kgha_side|Distance_to_shore|Exposure), type = "response", adjust = "fdr", lmer.df = "asymptotic",
         at = list(log_breeding_biomass_kgha_side = c(1.68, 4.79, 6.21)))
#looks like same resutls as when didn't include iti - all sig on protected, nothing sig on exposed


emmeans(mod.lmer.breeding.log.iti, list( ~ log_breeding_biomass_kgha_side|Distance_to_shore|Exposure), type = "response", adjust = "fdr", lmer.df = "asymptotic",
         at = list(log_breeding_biomass_kgha_side = c(1.68, 4.79, 6.21)))


emmeans(mod.lmer.breeding.log.iti, list(pairwise ~ Distance_to_shore|Exposure|log_breeding_biomass_kgha_side), type = "response", adjust = "fdr", lmer.df = "asymptotic",
         at = list(log_breeding_biomass_kgha_side = c(1.68, 4.09, 5.94)))
#at the lowest seabird biomass, there was no effect of distance to shore. At mid and high biomass, there is decline with distance to shore. Same effect on exposed and protected (because no interaction in model). 
#same as no iti models...


#check emmip plot----
emmip(mod.lmer.breeding.log.iti, Distance_to_shore ~ log_breeding_biomass_kgha_side|Exposure, CIs = TRUE,
      at = list(log_breeding_biomass_kgha_side = seq(log(5.39), log(378), by = log(10))), type = "response")

emmip(mod.lmer.breeding.iti, Distance_to_shore ~ breeding_biomass_kgha_side|Exposure, CIs = TRUE,
      at = list(breeding_biomass_kgha_side = seq(5.39, 379, by = 100)), type = "response")



#look at emmeans, but ignore interactions because ns----

emtrends(mod.lmer.breeding.log.iti,  list(pairwise~ Exposure), var = "log_breeding_biomass_kgha_side", adjust = "fdr") #
emtrends(mod.lmer.breeding.log.iti,  list(pairwise~ Exposure), var = "log_breeding_biomass_kgha_side", adjust = "fdr", lmer.df = "asymptotic") #no difference in biomass effect on 2 sides of island (averaged over distance from shore)

emtrends(mod.lmer.breeding.log,  list(pairwise~ Exposure), var = "log_breeding_biomass_kgha_side", adjust = "fdr", lmer.df = "asymptotic") #compared to model without Iti - BIG DIFF (averaged over distance from shore)


emtrends(mod.lmer.breeding.log.iti,  list(pairwise~ Distance_to_shore), var = "log_breeding_biomass_kgha_side", adjust = "fdr", lmer.df = "asymptotic") #no differences with distance to shore (averaged over exposure)
emtrends(mod.lmer.breeding.log,  list(pairwise~ Distance_to_shore), var = "log_breeding_biomass_kgha_side", adjust = "fdr", lmer.df = "asymptotic") #compared to model without Iti - BIG DIFF (averaged over distance from shore)


```

###model plots - w/ iti-----
```{r}
#plot raw data + lines: 
range(n15.all.seabirds.iti2$breeding_biomass_kgha_side)
range(n15.all.seabirds.iti2$log_breeding_biomass_kgha_side)


plot_dat2.log.iti<-emmip(mod.lmer.breeding.log.iti, Distance_to_shore ~ log_breeding_biomass_kgha_side|Exposure, 
                     at = list(log_breeding_biomass_kgha_side = seq(1.68, 6.21, by = .1)), CIs = TRUE, plotit=FALSE)

plot_dat2.log.iti

#rename and relvel exposure:
plot_dat2.log.iti<-
  plot_dat2.log.iti%>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))

#limit to correct range per group:
range(n15.all.seabirds.iti2[n15.all.seabirds.iti2$Exposure == "Protected",]$log_breeding_biomass_kgha_side)
range(n15.all.seabirds.iti2[n15.all.seabirds.iti2$Exposure == "Exposed",]$log_breeding_biomass_kgha_side)

plot_dat2.log.protected.iti<-
  plot_dat2.log.iti%>%
  filter(Exposure == "leeward")%>%
  filter(log_breeding_biomass_kgha_side>=1.6&log_breeding_biomass_kgha_side<=6)

plot_dat2.log.exposed.iti<-
  plot_dat2.log.iti%>%
  filter(Exposure == "windward")%>%
  filter(log_breeding_biomass_kgha_side>=4.7&log_breeding_biomass_kgha_side<=6.3)


n15.all.seabirds.iti2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


#save panels seperately to combine with other model:----
n15.all.seabirds.iti2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
  filter(Exposure == "leeward")%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


n15.all.seabirds.iti2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
  filter(Exposure == "windward")%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.exposed.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.exposed.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


n15.all.seabirds.iti2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


##just plot 10 and 30 m to make easier to see-----
plot_dat2.log.iti.red<-
  plot_dat2.log.iti%>%
  filter(Distance_to_shore == "10"| Distance_to_shore == "40")

plot_dat2.log.protected.iti.red<-
  plot_dat2.log.iti.red%>%
  filter(Exposure == "leeward")%>%
  filter(log_breeding_biomass_kgha_side>=1.6&log_breeding_biomass_kgha_side<=6)

plot_dat2.log.exposed.iti.red<-
  plot_dat2.log.iti.red%>%
  filter(Exposure == "windward")%>%
  filter(log_breeding_biomass_kgha_side>=4.7&log_breeding_biomass_kgha_side<=6.3)

n15.all.seabirds.iti2 %>%
  filter(Distance_to_shore == "10"| Distance_to_shore == "40")%>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected.iti.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed.iti.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected.iti.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed.iti.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


#re-run without exposure in plot-----
plot_dat2.log.iti.add<-emmip(mod.lmer.breeding.log.iti, Distance_to_shore ~ log_breeding_biomass_kgha_side, 
                     at = list(log_breeding_biomass_kgha_side = seq(1.68, 6.21, by = .1)), CIs = TRUE, plotit=FALSE)
plot_dat2.log.iti.add

n15.all.seabirds.iti2 %>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.iti.add, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.iti.add, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


n15.all.seabirds.iti2 %>%
   ggplot(aes(x = breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.iti.add, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.iti.add, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())

##plot just 10 and 40 m, no exposure-----
plot_dat2.log.iti.add.red<-
  plot_dat2.log.iti.add%>%
  filter(Distance_to_shore == "10"| Distance_to_shore == "40")

n15.all.seabirds.iti2 %>%
  filter(Distance_to_shore == "10"| Distance_to_shore == "40")%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.iti.add.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.iti.add.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())




#try plotting with distance to shore on x-axis instead-----
plot_dat2.log.iti.dist<-emmip(mod.lmer.breeding.log.iti, Distance_to_shore ~ log_breeding_biomass_kgha_side|Exposure, 
                     at = list(log_breeding_biomass_kgha_side = c(1.68, 4.09, 5.94)), CIs = TRUE, plotit=FALSE)
#at min, mean, max seabird biomass

plot_dat2.log.iti.dist

#rename and relvel exposure:
plot_dat2.log.iti.dist<-
  plot_dat2.log.iti.dist%>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))


n15.all.seabirds.iti2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = Distance_to_shore, y = N15))+
  geom_point(alpha = .5)+ #aes(color = log_breeding_biomass_kgha_side, fill = as.factor(log_breeding_biomass_kgha_side), group = log_breeding_biomass_kgha_side)
   geom_ribbon(data = plot_dat2.log.iti.dist, aes(x = Distance_to_shore, y = yvar, ymin = LCL, ymax=UCL, fill = as.factor(log_breeding_biomass_kgha_side), group = as.factor(log_breeding_biomass_kgha_side)), alpha = .2, lwd=0)+
   geom_line(data = plot_dat2.log.iti.dist, aes(x = Distance_to_shore, y = yvar, color = as.factor(log_breeding_biomass_kgha_side), group = as.factor(log_breeding_biomass_kgha_side)))+
  theme_bw() +
  facet_wrap(~Exposure)+
 #  xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  #scale_fill_viridis_c()+
  #scale_color_viridis_c()+
#  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())

#not useful.....




```


#test for interactions with LRT, drop and re-run? Models with Iti and without Iti....
```{r}

mod.lmer.breeding.log.iti.add <- lmer(N15 ~ log_breeding_biomass_kgha_side+Distance_to_shore + Exposure + (1|site.name), n15.all.seabirds.iti2)
plot(mod.lmer.breeding.log.iti.add)
qqnorm(resid(mod.lmer.breeding.log.iti.add))
hist(resid(mod.lmer.breeding.log.iti.add))
summary(mod.lmer.breeding.log.iti.add)
Anova(mod.lmer.breeding.log.iti.add)

range(n15.all.seabirds.iti2$log_breeding_biomass_kgha_side)
plot_dat2.log.iti.add2<-emmip(mod.lmer.breeding.log.iti.add, Distance_to_shore ~ log_breeding_biomass_kgha_side, 
                     at = list(log_breeding_biomass_kgha_side = seq(1.68, 6.22, by = .01)), CIs = TRUE, plotit=FALSE)


n15.all.seabirds.iti2 %>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.iti.add2, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.iti.add2, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


n15.all.seabirds.iti2 %>%
   ggplot(aes(x = breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.iti.add2, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.iti.add2, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())

##still plot 2 seperate exposure panels----
plot_dat2.log.iti.add2exp<-emmip(mod.lmer.breeding.log.iti.add, Distance_to_shore ~ log_breeding_biomass_kgha_side|Exposure, 
                     at = list(log_breeding_biomass_kgha_side = seq(1.68, 6.22, by = .01)), CIs = TRUE, plotit=FALSE)

plot_dat2.log.protected.iti.add2<-
  plot_dat2.log.iti.add2exp%>%
  filter(Exposure == "Protected")%>%
  filter(log_breeding_biomass_kgha_side>=1.6&log_breeding_biomass_kgha_side<=6)

plot_dat2.log.exposed.iti.add2<-
  plot_dat2.log.iti.add2exp%>%
  filter(Exposure == "Exposed")%>%
  filter(log_breeding_biomass_kgha_side>=4.7&log_breeding_biomass_kgha_side<=6.3)


n15.all.seabirds.iti2 %>%
 #  mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
# mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = exp(log_breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected.iti.add2, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed.iti.add2, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected.iti.add2, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed.iti.add2, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("seabird breeding biomass (kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


n15.all.seabirds.iti2 %>%
 #  mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
# mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.protected.iti.add2, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed.iti.add2, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected.iti.add2, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed.iti.add2, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())





##just plot 10 and 40 m to make easier to see-----
plot_dat2.log.iti.add2.red<-
  plot_dat2.log.iti.add2%>%
  filter(Distance_to_shore == "10"| Distance_to_shore == "40")

n15.all.seabirds.iti2 %>%
  filter(Distance_to_shore == "10"| Distance_to_shore == "40")%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.iti.add2.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.iti.add2.red, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


n15.all.seabirds.iti2 %>%
  filter(Distance_to_shore == "10"| Distance_to_shore == "40")%>%
   ggplot(aes(x = breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log.iti.add2.red, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.iti.add2.red, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("seabird breeding biomass (kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


##now without iti - drop exposure interaction for non-log model-----
mod.lmer.breeding.add <- lmer(N15 ~ breeding_biomass_kgha_side*Distance_to_shore + Exposure + (1|site.name), n15.all.seabirds2)
plot(mod.lmer.breeding.add)
qqnorm(resid(mod.lmer.breeding.add))
hist(resid(mod.lmer.breeding.add))
summary(mod.lmer.breeding.add)
Anova(mod.lmer.breeding.add)
#breeding_biomass_kgha_side                    5.1355  1    0.02344 *  
#Distance_to_shore                            67.7978  3  1.264e-14 ***
#Exposure                                      1.3173  1    0.25108    
#breeding_biomass_kgha_side:Distance_to_shore 24.2539  3  2.211e-05 ***

test(emtrends(mod.lmer.breeding.add, ~ Distance_to_shore, var = "breeding_biomass_kgha_side",  adjust = "fdr", type = "response"))

```


##COMBINE FIGURES FOR RESTORATION STATUS, ALL SEABIRD BIOMASS RESULTS------
```{r}
###NO ITI----
plot_dat2.log<-emmip(mod.lmer.breeding.log, Distance_to_shore ~ log_breeding_biomass_kgha_side|Exposure, 
                     at = list(log_breeding_biomass_kgha_side = seq(1.68, 5.94, by = .01)), CIs = TRUE, plotit=FALSE)

plot_dat2.log

#rename and relvel exposure:
plot_dat2.log<-
  plot_dat2.log%>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))

#limit to correct range per group:
range(n15.all.seabirds2[n15.all.seabirds2$Exposure == "Protected",]$log_breeding_biomass_kgha_side)
range(n15.all.seabirds2[n15.all.seabirds2$Exposure == "Exposed",]$log_breeding_biomass_kgha_side)

plot_dat2.log.protected<-
  plot_dat2.log%>%
  filter(Exposure == "leeward")%>%
  filter(log_breeding_biomass_kgha_side>=1.6&log_breeding_biomass_kgha_side<=6)

plot_dat2.log.exposed<-
  plot_dat2.log%>%
  filter(Exposure == "windward")%>%
  filter(log_breeding_biomass_kgha_side>=2.2&log_breeding_biomass_kgha_side<=4.9)

sb_algae_n15_plot<-
n15.all.seabirds2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = exp(log_breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .9, size = 3, aes(shape = Exposure))+
   geom_ribbon(data = plot_dat2.log.protected, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("Seabird breeding biomass (kg/ha)")+
  ylab(expression(Algal~delta^15~N))+
#  scale_fill_viridis_d()+
#  scale_color_viridis_d()+
    scale_fill_viridis_d(option = "mako")+
  scale_color_viridis_d(option = "mako")+
  labs(color = "Distance to shore (m)", fill = "Distance to shore (m)")+
  guides(shape = "none")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.85,.8),
        legend.background = element_blank(),
        strip.text = element_text(hjust = 0, size = 12))+
  facet_wrap(~Exposure, strip.position = "top",  
             labeller = labeller (Exposure = c("leeward" = "a. Leeward", "windward" = "b. Windward")))

sb_algae_n15_plot


### ITI----
plot_dat2.log.iti.add2<-emmip(mod.lmer.breeding.log.iti.add, Distance_to_shore ~ log_breeding_biomass_kgha_side, 
                     at = list(log_breeding_biomass_kgha_side = seq(1.68, 6.22, by = .01)), CIs = TRUE, plotit=FALSE)

sb_algae_n15_plot_iti<-
n15.all.seabirds.iti2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = exp(log_breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .9, size = 3, aes(shape = Exposure))+
   geom_ribbon(data = plot_dat2.log.iti.add2, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.iti.add2, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
   xlab("Seabird breeding biomass (kg/ha)")+
  ylab(expression(Algal~delta^15~N))+
#  scale_fill_viridis_d()+
#  scale_color_viridis_d()+
    scale_fill_viridis_d(option = "mako")+
  scale_color_viridis_d(option = "mako")+
  labs(color = "Distance to shore (m)", fill = "Distance to shore (m)", shape = "Exposure")+
  ggtitle("e. Including nearby seabirds")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.8,.25),
        legend.background = element_blank(),
        legend.box = "horizontal",
        plot.title = element_text(size=12))
sb_algae_n15_plot_iti



##REST STATUS
N15.lineplot.exposure <- 
  n15.line.sum.exp%>%
  mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
  ggplot(aes(x = Distance_to_shore, y = mean_n15, fill = reststat, color = reststat, group = reststat) )+
  #geom_boxplot(alpha = 0.6) +
  geom_point(alpha = 0.9, size = 5, aes(color = reststat, shape = Exposure)) +
  geom_errorbar(aes(ymin = (mean_n15-se_n15), ymax = (mean_n15+se_n15)), alpha = .5, width = 0.1)+
  geom_line(alpha = .6, lwd = 1.2)+
  ylab(expression(Algal~italic(delta)^15*N)) +
  #scale_fill_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) + # red-yellow-green
  scale_colour_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) +
  xlab("Distance to Shore (m)")+
  guides(shape = "none")+
  #labs(color='Distance \nFrom Shore (m)', fill = 'Distance \nFrom Shore (m)') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.title = element_blank(),
        legend.position = c(.88, .85),
        strip.text = element_text(hjust = 0, size = 12))+
  facet_wrap(~Exposure, strip.position = "top",  
             labeller = labeller (Exposure = c("leeward" = "c. Leeward", "windward" = "d. Windward")))

N15.lineplot.exposure


sb_algae_n15_plot_iti<-
  sb_algae_n15_plot_iti+
  theme(plot.margin = unit(c(0,3.5,0,3.5), "cm"),
        legend.position = c(.6,.25))

##combine all:
sb_algae_plots<-cowplot::plot_grid(sb_algae_n15_plot, N15.lineplot.exposure, sb_algae_n15_plot_iti, 
                                   ncol = 1, scale = c(1,1,1)) #, rel_heights = c(1,1,.8),
sb_algae_plots

#top_4<-cowplot::plot_grid(sb_algae_n15_plot, N15.lineplot.exposure,
                                   #ncol = 1)
#sb_algae_plots_B<-cowplot::plot_grid(top_4, sb_algae_n15_plot_iti, 
                                 #  nrow = 2, scale = c(1,.7)) #, rel_heights = c(1,1,.8),


#ggsave(sb_algae_plots, file = "../output/seabird-algaen15/sb_algae_plots_combined.jpg",
#    width = 8, height = 12)


##alternative layout-----
sb_algae_n15_plot_iti2<-
n15.all.seabirds.iti2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = exp(log_breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .9, size = 3, aes(shape = Exposure))+
   geom_ribbon(data = plot_dat2.log.iti.add2, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.iti.add2, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  #scale_fill_viridis_d(option = "rocket")+
  #scale_color_viridis_d(option = "rocket")+
 # labs(color = "Distance to shore (m)", fill = "Distance to shore (m)", shape = "Exposure")+
    guides(shape = "none", color = "none", fill = "none")+
  ggtitle("c. Including nearby seabirds - Combined")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.8,.25),
        legend.background = element_blank(),
        legend.box = "horizontal",
        plot.title = element_text(size=12),
        axis.title = element_blank(),
        axis.text.y =  element_blank(),
        axis.ticks.y = element_blank(),
        margin(0,0,0,0))
sb_algae_n15_plot_iti2


N15.lineplot.exposure2 <- 
  n15.line.sum.exp%>%
  mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
  ggplot(aes(x = Distance_to_shore, y = mean_n15, fill = reststat, color = reststat, group = reststat) )+
  #geom_boxplot(alpha = 0.6) +
  geom_point(alpha = 0.9, size = 5, aes(color = reststat, shape = Exposure)) +
  geom_errorbar(aes(ymin = (mean_n15-se_n15), ymax = (mean_n15+se_n15)), alpha = .5, width = 0.1)+
  geom_line(alpha = .6, lwd = 1.2)+
  ylab(expression(Algal~italic(delta)^15*N)) +
  #scale_fill_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) + # red-yellow-green
  scale_colour_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) +
  xlab("Distance to Shore (m)")+
  guides(shape = "none")+
  #labs(color='Distance \nFrom Shore (m)', fill = 'Distance \nFrom Shore (m)') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.title = element_blank(),
        legend.position = c(.88, .85),
        strip.text = element_text(hjust = 0, size = 12))+
  facet_wrap(~Exposure, strip.position = "top",  
             labeller = labeller (Exposure = c("leeward" = "d. Leeward", "windward" = "e. Windward")))


sb_algae_n15_plot2<-
n15.all.seabirds2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = exp(log_breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .9, size = 3, aes(shape = Exposure))+
   geom_ribbon(data = plot_dat2.log.protected, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat2.log.exposed, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log.protected, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat2.log.exposed, aes(x = exp(log_breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("Seabird breeding biomass (kg/ha)")+
  ylab(expression(Algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
 #   scale_fill_viridis_d(option = "mako")+
  #scale_color_viridis_d(option = "mako")+
#  scale_fill_brewer("blues", aesthetics = c("fill", "color"))+
#    scale_color_brewer("blues")+
  labs(color = "Distance to shore (m)", fill = "Distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.85,.5),
        legend.background = element_blank(),
        strip.text = element_text(hjust = 0, size = 12))+
  facet_wrap(~Exposure, strip.position = "top",  
             labeller = labeller (Exposure = c("leeward" = "a. Seabird by motu side - Leeward", "windward" = "b. Seabird by motu side - Windward")))

top_row<-cowplot::plot_grid(sb_algae_n15_plot2, NULL, sb_algae_n15_plot_iti2, 
                                   nrow = 1, rel_widths = c(1,-.01,.5), align = 'h', axis = 'tb') 
top_row

sb_algae_plots2<-cowplot::plot_grid(top_row, N15.lineplot.exposure2, 
                                   ncol = 1)
sb_algae_plots2



#ggsave(sb_algae_plots2, file = "../output/seabird-algaen15/sb_algae_plots_combined_alt_layout.jpg",
 #   width = 12, height = 8)

```





#double-check for 3-way interactions-----
#confusing results, and low power - leave out. 
```{r}

##rest status----
mod.lmer.rest.3way <- lmer(N15 ~ reststat*Distance_to_shore*Exposure + (1|site.name), n15.all.seabirds2)
Anova(mod.lmer.rest.3way)
#no 3-way, marginal distance*exposure

mod.lmer.rest.2way <- lmer(N15 ~ reststat*Distance_to_shore + reststat*Exposure + Exposure*Distance_to_shore+ (1|site.name), n15.all.seabirds2)
Anova(mod.lmer.rest.2way)
#same as above...

#emmeans rest status----
emmeans(mod.lmer.rest.2way, list(pairwise ~ Exposure|Distance_to_shore|reststat), type = "response", adjust = "fdr",  lmer.df = "asymptotic")
#reference motu: no sig differences between exposures at any distance to shore (trending towards diff at 10m, but nowhere near sig)
#recovering: 10 and 20-m are higher on protected than exposed side, but marginal diff at 30-m, no diff at 40-m. (so strongest effect onshore)
#unrestored: sig higher on exposed than protected at all distances (strongest effect offshore)
#matches what we saw above with no interaction....


#without iti----
mod.lmer.breeding.log.3way <- lmer(N15 ~ log_breeding_biomass_kgha_side*Distance_to_shore*Exposure + (1|site.name), n15.all.seabirds2)
Anova(mod.lmer.breeding.log.3way)

mod.lmer.breeding.log.2way <- lmer(N15 ~ log_breeding_biomass_kgha_side*Distance_to_shore + log_breeding_biomass_kgha_side*Exposure + Exposure*Distance_to_shore +(1|site.name), n15.all.seabirds2)
Anova(mod.lmer.breeding.log.2way)
#ns - only interactions already included sig

mod.lmer.breeding.3way <- lmer(N15 ~ breeding_biomass_kgha_side*Distance_to_shore*Exposure + (1|site.name), n15.all.seabirds2)
Anova(mod.lmer.breeding.3way)
#similar as non-log

###with iti----
mod.lmer.breeding.log.iti.3way <- lmer(N15 ~ log_breeding_biomass_kgha_side*Distance_to_shore*Exposure + (1|site.name), n15.all.seabirds.iti2)
Anova(mod.lmer.breeding.log.iti.3way)
#significant

mod.lmer.breeding.iti.2way <- lmer(N15 ~ breeding_biomass_kgha_side*Distance_to_shore*Exposure + (1|site.name), n15.all.seabirds.iti2)
Anova(mod.lmer.breeding.iti.2way)
#similar as non-log


#emmeans iti----
emmeans(mod.lmer.breeding.log.iti.3way, list(pairwise ~ Distance_to_shore|Exposure|log_breeding_biomass_kgha_side), type = "response", adjust = "fdr", lmer.df = "asymptotic",
         at = list(log_breeding_biomass_kgha_side = c(1.68, 4.09, 5.94)))
#at low seabird biomass, no effect of distance to shore on either side
#at mid seabirds - effects of distance on both sides.
#at high seabirds - only effects on protected side. 


emmeans(mod.lmer.breeding.log.iti.3way, list(pairwise ~ log_breeding_biomass_kgha_side|Distance_to_shore|Exposure), type = "response", adjust = "fdr", lmer.df = "asymptotic",
         at = list(log_breeding_biomass_kgha_side = c(1.68, 4.09, 5.94)))
#again, all sig on protected sides, none on exposed side. 


emmeans(mod.lmer.breeding.log.3way, list(pairwise ~ log_breeding_biomass_kgha_side|Distance_to_shore|Exposure), type = "response", adjust = "fdr", lmer.df = "asymptotic",
         at = list(log_breeding_biomass_kgha_side = c(1.68, 4.09, 5.94)))
#but same results without iti

test(emtrends(mod.lmer.breeding.log.iti.3way, pairwise~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side",  adjust = "fdr", type = "response"))
#differences on protected but not exposed side

emtrends(mod.lmer.breeding.log.iti.3way,  ~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side", adjust = "fdr")

test(emtrends(mod.lmer.breeding.log.iti.3way, ~ Distance_to_shore|Exposure, var = "log_breeding_biomass_kgha_side",  adjust = "fdr", type = "response"))
#all protected side p-values significant, nothing significant on exposed side...


#plot----------
plot_dat3.log.iti<-emmip(mod.lmer.breeding.log.iti.3way, Distance_to_shore ~ log_breeding_biomass_kgha_side|Exposure, 
                     at = list(log_breeding_biomass_kgha_side = seq(1.68, 6.21, by = .1)), CIs = TRUE, plotit=FALSE)

plot_dat3.log.iti

#rename and relvel exposure:
plot_dat3.log.iti<-
  plot_dat3.log.iti%>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))

#limit to correct range per group:
range(n15.all.seabirds.iti2[n15.all.seabirds.iti2$Exposure == "Protected",]$log_breeding_biomass_kgha_side)
range(n15.all.seabirds.iti2[n15.all.seabirds.iti2$Exposure == "Exposed",]$log_breeding_biomass_kgha_side)

plot_dat3.log.protected.iti<-
  plot_dat3.log.iti%>%
  filter(Exposure == "leeward")%>%
  filter(log_breeding_biomass_kgha_side>=1.6&log_breeding_biomass_kgha_side<=6)

plot_dat3.log.exposed.iti<-
  plot_dat3.log.iti%>%
  filter(Exposure == "windward")%>%
  filter(log_breeding_biomass_kgha_side>=4.5&log_breeding_biomass_kgha_side<=6.3)


n15.all.seabirds.iti2 %>%
   mutate(Exposure = fct_recode(Exposure, leeward = "Protected", windward = "Exposed"))%>%
 mutate(Exposure = fct_relevel(Exposure, "leeward", "windward"))%>%
   ggplot(aes(x = log_breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat3.log.protected.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
     geom_ribbon(data = plot_dat3.log.exposed.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat3.log.protected.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
   geom_line(data = plot_dat3.log.exposed.iti, aes(x = log_breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)+
   xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  facet_wrap(~Exposure)+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())


```



