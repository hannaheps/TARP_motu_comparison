---
title: "seabirds_vs_algae_N15"
author: "HEE"
date: "2024-06-04"
output: html_document
---

#Load libraries

```{r}
library(plyr)
library(tidyverse)
library(corrplot)
library(lme4)
library(nlme)
library(car)
library(jtools)
library(emmeans)
library(sjPlot)


```

#Combine seabird and algaeN15 data
```{r}
##Bring in seabird data
seabirds <- read.csv("../../seabird_data/outputs/seabird_dens_bio_focal_data.csv")

seabirds$site.name <- paste(seabirds$Motu, seabirds$Exposure, sep = "_")


##bring in algae data
algae <- read.csv("../../algae_isotopes/data/Tetiaroa_Turbinaria_Transects_November_2021_compiledMarch2023.csv")
View(algae)
algae$Distance_to_shore <- as.factor(algae$Distance_to_shore)
algae$Side[algae$Side=="leeward"] <- "Protected"
algae$Side[algae$Side == "windward"] <- "Exposed"
names(algae)[names(algae) == 'Side'] <- 'Exposure'

#manipulate algae data frame to get average N15 per motu, site and distance from shore

sum.algae <- ddply(algae, c("Motu", "Exposure", "Distance_to_shore"),summarise,
                      mean.N15 = mean(N15)
)

sum.algae
#spread data to get values for each distance from shore
sum.algae <- sum.algae %>% spread(Distance_to_shore, mean.N15)

sum.algae <- sum.algae %>% rename(c("N.15_at_10m" = "10", 
                                    "N.15_at_20m" = "20",  "N.15_at_30m" ="30",
                                    "N.15_at_40m" = "40"))


#Create a site.name that combines motu and exposure in order to merge with seabrid data
sum.algae$site.name <-  paste(sum.algae$Motu, sum.algae$Exposure, sep = "_")


##Combine seabird and algae data
algae.seabirds <- right_join(seabirds, sum.algae)
View(algae.seabirds)
algae.seabirds <- algae.seabirds[,-1] #This is just to remove duplicate columns
#algae.seabirds <- algae.seabirds[,-c(2,7)] #Use this one for Iti data, it has slightly different column #s 
View(algae.seabirds)

#save combined data
#write.csv(algae.seabirds, "../output/n15_seabirds_combined_no_iti.csv")

```


#Run a correlation test
```{r}
data.matrix <- as.data.frame(algae.seabirds[,c(3:18,20:23)])
View(data.matrix)

cor.mtest(data.matrix)
correlation.matrix.psn <- cor(data.matrix, use = "pairwise.complete.obs", method = "pearson") 
write.csv(correlation.matrix.psn, "../output/n15_seabirds_corrmatrix_no_iti_pearson.csv") 
correlation.matrix.sp <- cor(data.matrix, use = "pairwise.complete.obs", method  = "spearman") 
write.csv(correlation.matrix.sp, "../output/n15_seabirds_corrmatrix_no_iti_spearman.csv")

#file = "../output/correlation_seabird_N15_spearman.pdf")

corrplot(cor(data.matrix, use = "pairwise.complete.obs", method = "pearson"), type = "upper", 
         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", title = "seabirds vs. N15")

corrplot(cor(data.matrix, use = "pairwise.complete.obs", method = "spearman"), type = "upper", 
         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", title = "seabirds vs. N15")


```

##This is great but how about just the breeding biomass vs. all the N15 levels
```{r}

data.matrix.bb <- as.data.frame(algae.seabirds[,c(5,20:23)])
View(data.matrix.bb)


#Run a correlation test using the library corrplot
cor.mtest(data.matrix.bb)

pdf(file ="../output/seabird-algaen15/correlation_breedingbiomass_n15_spearman.pdf")

corrplot(cor(data.matrix.bb, use = "pairwise.complete.obs", method = "spearman"), type = "upper", 
         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", title = "seabirds vs. N15")

dev.off()

```

#Try a new corr matrix as another option for supplement - all seabird metrics versus algae n15 at 4 distances:
```{r}
cor.mat_sb__algae<- cor(x = algae.seabirds[c(3:18)], y =algae.seabirds[c(20:23)], method = "spearman", use = "pairwise.complete.obs")

corrplot(cor.mat_sb__algae, type = "full",
         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", tl.cex = 0.5, cl.pos = "r", cl.ratio = .5)

#save plot:
pdf(file = "../output/seabird-algaen15/corrplot_allseabirds_vs_algaen15_spearman.pdf")
corrplot(cor.mat_sb__algae, type = "full",
         addCoef.col = NULL, addCoefasPercent = FALSE, tl.col = "black", tl.cex = 0.5, cl.pos = "r", cl.ratio = .5)
dev.off()

```





#Expand the data to include all algae data for running linear models. 
```{r}
algae$site.name <- paste(algae$Motu, algae$Exposure, sep = "_")

n15.all.seabirds <- merge(algae, seabirds[,-1], by = "site.name", all = TRUE, no.dups = TRUE)
View(n15.all.seabirds)
names(n15.all.seabirds)[names(n15.all.seabirds) == 'Exposure.x'] <- 'Exposure'
names(n15.all.seabirds)[names(n15.all.seabirds) == 'Motu.x'] <- 'Motu'

n15.all.seabirds$Distance_to_shore <- as.factor(n15.all.seabirds$Distance_to_shore)

#Add in seabird_level
n15.all.seabirds <-
  n15.all.seabirds%>%
  mutate(seabird_level = case_when(breeding_biomass_kgha_side<10 ~"low",
                                   breeding_biomass_kgha_side>10&breeding_biomass_kgha_side <200 ~"mid",
                                   breeding_biomass_kgha_side>200 ~"high"))%>%
  mutate(seabird_level = as.factor(seabird_level))%>%
  mutate(seabird_level = fct_relevel(seabird_level, "low", "mid", "high"))

```

#linear models
```{r}
mod.lme <- lme(N15 ~ seabird_level*Distance_to_shore + Exposure, random = ~1|site.name, n15.all.seabirds, method = "REML")
#Trial an optimized version (more complex)
mod.lme1 <- lme(N15 ~ seabird_level*Distance_to_shore + Exposure, random = ~ seabird_level | site.name, n15.all.seabirds, 
                         method = "REML",control = lmeControl(opt = "optim", method = "BFGS"))
#Check AIC values & model fit
anova(mod.lme, mod.lme1)  #lme is better AIC value

plot_grid(plot_model(mod.lme, type = "diag"))
plot(mod.lme) #fit looks great


#test statistics
summary(mod.lme)
Anova(mod.lme)
#Response: N15
#                                 Chisq Df Pr(>Chisq)    
#seabird_level                   51.877  2  5.434e-12 ***
#Distance_to_shore               73.344  3  8.201e-16 ***
#Exposure                        21.052  1  4.471e-06 ***
#seabird_level:Distance_to_shore 32.186  6  1.503e-05 ***
vif(mod.lme)
plot_summs(mod.lme)


mod.lmer <- lmer(N15 ~ seabird_level*Distance_to_shore + seabird_level*Exposure + ( 1|site.name), n15.all.seabirds)
Anova(mod.lmer)
summary(mod.lmer)

```

#Model parameters & plotting
```{r}
#look at emmeans:
mod.lme%>% 
  emmeans(~ seabird_level,
          type = "response") 


emmeans(mod.lme, list(pairwise ~ seabird_level*Distance_to_shore), type = "response", adjust = "fdr")
#high20 - high 40 p = 0.0003
#high10 - high 40 p = <0.0001
#high10 - high 30 p = <0.0001
#high10 - high 20 p = 0.0023
#high10 - high 40 p = <0.0001
#mid10  - mid 40 p = 0.0127
#mid10  - mid 30 p = 0.0051
#mid10  - mid 20 p = 0.029


#can also look within each distance to shore or seabird level so multiple comparisons not as overwhelming:
emmeans(mod.lme, list(pairwise ~ seabird_level|Distance_to_shore), type = "response", adjust = "fdr")
emmeans(mod.lme, list(pairwise ~ Distance_to_shore|seabird_level), type = "response", adjust = "fdr")


plot_data_n15_sb<-emmip(mod.lme, ~ seabird_level*Distance_to_shore,
          type = "response", CIs = TRUE, plotit=FALSE)

plot_data_n15_sb

response_plot_n15<-
  ggplot(data = plot_data_n15_sb, aes(x = Distance_to_shore, y = yvar, color = seabird_level, fill = seabird_level, group = seabird_level) )+
#  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL, ymax = UCL), alpha = .3, linewidth = 2, size = 0.2, position = position_dodge(.1)) + #,  position = position_dodge(.3) 
 # geom_point(data = fishn15.seabirds.cond.r, 
           #  aes(y = n15, x = seabird_level), size = 2.5, alpha = .5,  position = position_dodge(.3))+ 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
  ylab(expression(italic(delta)^15*N))+
#scale_y_continuous(labels = scales::label_percent(accuracy = .1, scale = 1),  limits = c(0, 100), expand = expansion(0, 0))+
  scale_fill_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+ #low-mid-high = red-yellow-green
    scale_colour_manual(values = c( "low" = "#CD1913", "mid" = "#F2BB05", "high" ="#2F9D3E"))+#low-mid-high = red-yellow-green
  xlab("Distance From Shore (m)")+
  labs(color='Seabird Level', fill = 'Seabird Level') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank()) #,
        #legend.position = "none" )

response_plot_n15
ggsave(response_plot_n15, file = "../output/seabird-algaen15/n15_seabirdbiomass_by_distance_model.jpg", width = 7, height = 5)



#What about JUST with seabirds
plot_data_n15_sb_only<-emmip(mod.lme, ~ seabird_level,
          type = "response", CIs = TRUE, plotit=FALSE)

plot_data_n15_sb_only

response_plot_n15_sbonly<-
  ggplot(data = plot_data_n15_sb_only, aes(x = seabird_level, y = yvar, color = seabird_level, fill = seabird_level) )+
#  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL, ymax = UCL), alpha = .3, linewidth = 2, size = 0.2, position = position_dodge(.1)) + #,  position = position_dodge(.3) 
 # geom_point(data = fishn15.seabirds.cond.r, 
           #  aes(y = n15, x = seabird_level), size = 2.5, alpha = .5,  position = position_dodge(.3))+ 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
  ylab(expression(italic(delta)^15*N))+
#scale_y_continuous(labels = scales::label_percent(accuracy = .1, scale = 1),  limits = c(0, 100), expand = expansion(0, 0))+
  xlab("seabird biomass level")+
  #labs(color='Distance \nFrom Shore (m)', fill = 'Distance \nFrom Shore (m)') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank())#,
       # legend.position = "none" )

response_plot_n15_sbonly
#ggsave(response_plot_n15_sbonly, file = "../output/seabird-algaen15/n15_seabirdbiomass_only_model.jpg", width = 7, height = 5)

```

##How about plotting by motu - or "reference" "recovering" "unrestored" using the same colours as seabird level

#algal N15 on y, distance from shore on x, grouped box plots by motu

```{r}

n15.all.seabirds$reststat <- n15.all.seabirds$Motu

n15.all.seabirds$reststat[n15.all.seabirds$reststat == "Aie"] <- "reference"
n15.all.seabirds$reststat[n15.all.seabirds$reststat == "Reiono"] <- "recovering"
n15.all.seabirds$reststat[n15.all.seabirds$reststat == "Rimatuu"] <- "unrestored"

n15.all.seabirds <- n15.all.seabirds %>% mutate(reststat = fct_relevel(reststat, "reference", "recovering", "unrestored"))

N15.boxplot <- ggplot(data = n15.all.seabirds, aes(x = Distance_to_shore, y = N15, fill = reststat) )+
  geom_boxplot(alpha = 0.6) +
  geom_point(alpha = 0.5, position = position_dodge(width = 0.75), aes(group = reststat, color = reststat)) +
  ylab(expression(italic(delta)^15*N)) +
  scale_fill_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) + # red-yellow-green
  scale_colour_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) +
  xlab("Distance to Shore")+
  #labs(color='Distance \nFrom Shore (m)', fill = 'Distance \nFrom Shore (m)') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.title = element_blank(),
        legend.position = c(.88, .85))

ggsave(N15.boxplot, file = "../output/seabird-algaen15/N15_boxplot.jpg",
    width = 7, height = 5)

```

#Let's make a line plot

```{r}

n15.line.sum <- plyr::ddply(n15.all.seabirds, c("Distance_to_shore", "reststat"), summarise,
             mean_n15 = mean(N15), 
             n_n15 = length(N15), 
             se_n15 = sd(N15)/sqrt(n_n15))

n15.line.sum <- n15.line.sum %>% mutate(reststat = fct_relevel(reststat, "reference", "recovering", "unrestored"))

N15.lineplot <- ggplot(data = n15.line.sum, aes(x = Distance_to_shore, y = mean_n15, fill = reststat, color = reststat, group = reststat) )+
  #geom_boxplot(alpha = 0.6) +
  geom_point(alpha = 0.6,  aes(color = reststat)) +
  geom_errorbar(aes(ymin = (mean_n15-se_n15), ymax = (mean_n15+se_n15)), alpha = .5, width = 0.1)+
  geom_line(alpha = .5)+
  ylab(expression(italic(delta)^15*N)) +
  #scale_fill_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) + # red-yellow-green
  scale_colour_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E")) +
  xlab("Distance to Shore")+
  #labs(color='Distance \nFrom Shore (m)', fill = 'Distance \nFrom Shore (m)') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.title = element_blank(),
        legend.position = c(.88, .85))

ggsave(N15.lineplot, file = "../output/seabird-algaen15/N15_lineplot.jpg",
    width = 7, height = 5)

```


#N15 restoration status models NOT seabird level

```{r}
mod.lme.rest <- lme(N15 ~ reststat*Distance_to_shore + reststat*Exposure, random = ~1|site.name, n15.all.seabirds, method = "REML")

mod.lme.rest.noexp <- lm(N15 ~ reststat*Distance_to_shore + Exposure + site.name, data =n15.all.seabirds )
anova(mod.lme.rest.noexp)
#Trial an optimized version (more complex)
mod.lme.rest2 <- lme(N15 ~ reststat*Distance_to_shore + Exposure, random = ~ seabird_level | site.name, n15.all.seabirds, 
                         method = "REML",control = lmeControl(opt = "optim", method = "BFGS"))
#Check AIC values & model fit
anova(mod.lme.rest, mod.lme.rest2)  #lme.rest is better AIC value

plot_grid(plot_model(mod.lme.rest, type = "diag")) #nice distribution
plot(mod.lme.rest) #fit looks great


#test statistics
summary(mod.lme.rest)
Anova(mod.lme.rest)
#Response: N15
#                             Chisq Df Pr(>Chisq)    
#reststat                    1.4510  2   0.484072    
#Distance_to_shore          60.0030  3   5.87e-13 ***
#Exposure                    0.0014  1   0.969873    
#reststat:Distance_to_shore 18.0662  6   0.006069 ** 
anova(mod.lme.rest)
	
        #numDF denDF F-value  p-value
#(Intercept)	1	53	69.92763	<.0001
#reststat	2	2	0.76037	0.5681
#Distance_to_shore	3	53	20.00729	<.0001
#Exposure	1	2	0.00672	0.9421
#reststat:Distance_to_shore	6	53	3.01104	0.0132

vif(mod.lme.rest)
plot_summs(mod.lme.rest)

#compare to regular lm:
mod.lm.rest <- lm(N15 ~ reststat*Distance_to_shore+Exposure, n15.all.seabirds)
summary(mod.lm.rest)
Anova(mod.lm.rest) #both rest_status and distance to shore significant, no interaction..

```

```{r}

emmeans(mod.lme.rest, list(pairwise ~ reststat*Distance_to_shore), type = "response", adjust = "fdr")


plot.data.rest <-emmip(mod.lme.rest, ~ reststat*Distance_to_shore,
          type = "response", CIs = TRUE, plotit=FALSE)

plot.data.rest



response.plot.rest<-
  ggplot(data = plot.data.rest, aes(x = Distance_to_shore, y = yvar, color = reststat, fill = reststat, group = reststat) )+
#  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL, ymax = UCL), alpha = .3, linewidth = 2, size = 0.2, position = position_dodge(.1)) + #,  position = position_dodge(.3) 
 # geom_point(data = fishn15.seabirds.cond.r, 
           #  aes(y = n15, x = seabird_level), size = 2.5, alpha = .5,  position = position_dodge(.3))+ 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
  ylab(expression(italic(delta)^15*N))+
#scale_y_continuous(labels = scales::label_percent(accuracy = .1, scale = 1),  limits = c(0, 100), expand = expansion(0, 0))+
  scale_fill_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E"))+ #low-mid-high = red-yellow-green
    scale_colour_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E"))+#low-mid-high = red-yellow-green
  xlab("Distance From Shore (m)")+
  #labs(color='Seabird Level', fill = 'Seabird Level') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.title = element_blank() ,
        legend.position = c(0.88, 0.88) )

response.plot.rest
#ggsave(response.plot.rest, file = "../output/seabird-algaen15/n15_restorationstat_by_distance_model.jpg", width = 7, height = 5)




```


#models by breeding biomass per side
```{r}

n15.all.seabirds$breeding_biomass_kgha_side

mod.lme.breeding <- lme(N15 ~ breeding_biomass_kgha_side*Distance_to_shore + Exposure, random = ~1|site.name, n15.all.seabirds, method = "REML")

plot_grid(plot_model(mod.lme.breeding, type = "diag")) #nice distribution
plot(mod.lme.breeding) #fit looks great

#test statistics
summary(mod.lme.breeding)
Anova(mod.lme.breeding)
#Response: N15
#                                               Chisq Df Pr(>Chisq)    
#breeding_biomass_kgha_side                    5.1355  1    0.02344 *  
#Distance_to_shore                            67.7978  3  1.264e-14 ***
#Exposure                                      1.3173  1    0.25108    
#breeding_biomass_kgha_side:Distance_to_shore 24.2539  3  2.211e-05 ***

anova(mod.lme.breeding)
#(Intercept)	1	56	168.98156	<.0001
#breeding_biomass_kgha_side	1	3	3.55608	0.1558
#Distance_to_shore	3	56	22.67877	<.0001
#Exposure	1	3	1.32052	0.3338
#breeding_biomass_kgha_side:Distance_to_shore	3	56	8.08464	0.0001

vif(mod.lme.breeding)
plot_summs(mod.lme.breeding)



```


##plots by breeding biomass (CB)
```{r}

#look at emmeans:
emtrends(mod.lme.breeding,  ~ Distance_to_shore, var = "breeding_biomass_kgha_side")
#looks like all trending towards positive but overlaps 0. weaker effects at higher distances

test(emtrends(mod.lme.breeding, ~ Distance_to_shore, var = "breeding_biomass_kgha_side", adjust = "fdr"))
#no p-value actually significant....
test(emtrends(mod.lme.breeding, ~ Distance_to_shore, var = "breeding_biomass_kgha_side", adjust = "fdr"))


#extract emmeans----
emmeans(mod.lme.breeding, list( ~ Distance_to_shore*breeding_biomass_kgha_side), type = "response", adjust = "fdr")

emmip(mod.lme.breeding, Distance_to_shore ~ breeding_biomass_kgha_side, CIs = TRUE,
      at = list(breeding_biomass_kgha_side = seq(5.39, 378, by = 10)))


emmip(mod.lme.breeding, breeding_biomass_kgha_side ~ Distance_to_shore, CIs = TRUE,
      at = list(Distance_to_shore = seq(10, 40, by = 10)))
      

#plot raw data + lines: 
range(n15.all.seabirds$breeding_biomass_kgha_side)

(mylist2 <- list(
      breeding_biomass_kgha_side = seq(5.39, 379, by = 1)
))

plot_dat2<-emmip(mod.lme.breeding, Distance_to_shore ~ breeding_biomass_kgha_side, at = mylist2, CIs = TRUE, plotit=FALSE)
plot_dat2

n15.all.seabirds %>%
   ggplot(aes(x = breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_jitter(alpha = .5, width = 10)+
   geom_ribbon(data = plot_dat2, aes(x = breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2, aes(x = breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() 


n15_seabird_plot<-
n15.all.seabirds %>%
   ggplot(aes(x = breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2, aes(x = breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .1, lwd=0)+
 geom_line(data = plot_dat2, aes(x = breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore), lwd = 1.1)+
  xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())
        #legent.key = element_rect) #,
        #legend.direction = "horizontal",
      #  legend.box.background = element_rect(colour = "black"))
n15_seabird_plot

ggsave("../output/seabird-algaen15/algae_n15_vs_seabird_biomass_distance_estplot_lines_points.jpg", plot = n15_seabird_plot, width = 7, height = 5)


n15_seabird_plot_mean<-
n15.all.seabirds %>%
  dplyr::group_by(Distance_to_shore, breeding_biomass_kgha_side)%>%
  dplyr::summarize(mean_n15 = mean(N15, na.rm = TRUE),
            sd_n15 = sd(N15, na.rm = TRUE),
            se_n15 = sd_n15/length(N15))%>%
  ungroup()%>%
   ggplot(aes(x = breeding_biomass_kgha_side, y = mean_n15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+

   geom_ribbon(data = plot_dat2, aes(x = breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2, aes(x = breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
    geom_point(alpha = .5)+
  geom_errorbar(aes(ymax = mean_n15+se_n15, ymin = mean_n15 -se_n15))+
  xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())
        #legent.key = element_rect) #,
        #legend.direction = "horizontal",
      #  legend.box.background = element_rect(colour = "black"))
n15_seabird_plot_mean

```

#does log(biomass) model fit better?
```{r}
n15.all.seabirds$breeding_biomass_kgha_side

mod.lme.breeding.log <- lmer(N15 ~ log(breeding_biomass_kgha_side)*Distance_to_shore + Exposure + (1|site.name), n15.all.seabirds)

plot_grid(plot_model(mod.lme.breeding.log, type = "diag")) #nice distribution
plot(mod.lme.breeding.log) #fit looks great

#test statistics
summary(mod.lme.breeding.log)
Anova(mod.lme.breeding.log)
#Response: N15
#                                               Chisq Df Pr(>Chisq)    
#log(breeding_biomass_kgha_side)                    4.6630  1    0.03082 *  
#Distance_to_shore                                 67.1834  3  1.711e-14 ***
#Exposure                                           0.1158  1    0.73362    
#log(breeding_biomass_kgha_side):Distance_to_shore 23.5741  3  3.065e-05 ***

anova(mod.lme.breeding.log)
#(Intercept)	1	56	156.61234	<.0001
#log(breeding_biomass_kgha_side)	1	3	4.53128	0.1232
#Distance_to_shore	3	56	22.42959	<.0001
#Exposure	1	3	0.15193	0.7227
#log(breeding_biomass_kgha_side):Distance_to_shore	3	56	7.85804	0.0002

vif(mod.lme.breeding.log)
plot_summs(mod.lme.breeding.log)



#look at emmeans:
emtrends(mod.lme.breeding.log,  ~ Distance_to_shore, var = "log(breeding_biomass_kgha_side)", adjust = "fdr")
#looks like all trending towards positive but overlaps 0. weaker effects at higher distances

test(emtrends(mod.lme.breeding.log, ~ Distance_to_shore, var = "log(breeding_biomass_kgha_side)",  adjust = "fdr", type = "response"))
#no p-value actually significant....

test(emtrends(mod.lme.breeding.log,  ~ Distance_to_shore, var = "log(breeding_biomass_kgha_side)"))
#not significant because of fdr correction....


emtrends(mod.lme.breeding.log,  pairwise~ Distance_to_shore, var = "log(breeding_biomass_kgha_side)", adjust = "fdr")
#but, effect of seabirds is different at 10 m from shore compared to all other distances, and different 20 versus 40 m.


anova(mod.lme.breeding, mod.lme.breeding.log)  #log is way better AIC value* but different fixed effects, so not meaningful comparison.

emmeans(mod.lme.breeding.log, "Distance_to_shore")
emmeans(mod.lme.breeding.log, "breeding_biomass_kgha_side", by = "Distance_to_shore")
emmeans(mod.lme.breeding.log, "Distance_to_shore", by = "breeding_biomass_kgha_side")
joint_tests(mod.lme.breeding.log, by = "Distance_to_shore", adjust = "fdr" )



```


##plots by breeding biomass - log (CB)
```{r}

#extract emmeans----
emmeans(mod.lme.breeding.log, list( ~ breeding_biomass_kgha_side*Distance_to_shore), type = "response", adjust = "fdr")

emmip(mod.lme.breeding.log, Distance_to_shore ~ breeding_biomass_kgha_side, CIs = TRUE,
      at = list(breeding_biomass_kgha_side = seq(5.39, 378, by = 10)), type = "response")

#plot raw data + lines: 
range(n15.all.seabirds$breeding_biomass_kgha_side)

(mylist2 <- list(
      breeding_biomass_kgha_side = seq(5.39, 379, by = 1)
))

plot_dat2.log<-emmip(mod.lme.breeding.log, Distance_to_shore ~ breeding_biomass_kgha_side, at = mylist2, CIs = TRUE, plotit=FALSE, type = "response")
plot_dat2.log

n15.all.seabirds %>%
   ggplot(aes(x = breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_jitter(alpha = .5, width = 4)+
   geom_ribbon(data = plot_dat2.log, aes(x = breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log, aes(x = breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() 



plot_dat2.log<-emmip(mod.lme.breeding.log, Distance_to_shore ~ breeding_biomass_kgha_side, at = mylist2, CIs = TRUE, plotit=FALSE)
plot_dat2.log

n15.all.seabirds %>%
   ggplot(aes(x = log(breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() 

n15_seabird_log_plot<-
n15.all.seabirds %>%
   ggplot(aes(x = log(breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .1, lwd=0)+
 geom_line(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore), lwd = 1.2)+
  xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())
        #legent.key = element_rect) #,
        #legend.direction = "horizontal",
      #  legend.box.background = element_rect(colour = "black"))
n15_seabird_log_plot

#ggsave("../output/seabird-algaen15/algae_n15_vs_log_seabird_biomass_distance_estplot_lines_points.jpg", plot = n15_seabird_log_plot, width = 7, height = 5)

```

#try distance to shore as continuous:
```{r}

n15.all.seabirds.cont<-
  n15.all.seabirds%>%
  mutate(Distance_to_shore_c = as.integer(Distance_to_shore)*10)

mod.lme.breeding.cont <- lme(N15 ~ breeding_biomass_kgha_side*Distance_to_shore_c + Exposure, random = ~1|site.name, n15.all.seabirds.cont, method = "REML")

plot_grid(plot_model(mod.lme.breeding.cont, type = "diag")) #nice distribution
plot(mod.lme.breeding.cont) #fit looks great

#test statistics
summary(mod.lme.breeding.cont)
Anova(mod.lme.breeding.cont)
#Response: N15
#                                               Chisq Df Pr(>Chisq)    
#breeding_biomass_kgha_side                    5.1355  1    0.02344 *  
#Distance_to_shore                            67.7978  3  1.264e-14 ***
#Exposure                                      1.3173  1    0.25108    
#breeding_biomass_kgha_side:Distance_to_shore 24.2539  3  2.211e-05 ***

anova(mod.lme.breeding.cont)
#(Intercept)	1	56	168.98156	<.0001
#breeding_biomass_kgha_side	1	3	3.55608	0.1558
#Distance_to_shore	3	56	22.67877	<.0001
#Exposure	1	3	1.32052	0.3338
#breeding_biomass_kgha_side:Distance_to_shore	3	56	8.08464	0.0001

vif(mod.lme.breeding.cont)
plot_summs(mod.lme.breeding.cont)


emmip(mod.lme.breeding.cont)

emmip(mod.lme.breeding.cont, Distance_to_shore_c ~ breeding_biomass_kgha_side, CIs = TRUE,  at = list(breeding_biomass_kgha_side = seq(5.39, 378, by = 10), Distance_to_shore_c = c(10, 20, 30, 40)), type = "response")

emtrends(mod.lme.breeding.cont, "Distance_to_shore_c", var = "breeding_biomass_kgha_side")
emmeans(mod.lme.breeding.cont, pairwise ~ breeding_biomass_kgha_side | Distance_to_shore_c)

test(emtrends(mod.lme.breeding.cont, ~ Distance_to_shore_c, var = "breeding_biomass_kgha_side", adjust = "fdr", type = "response", at = list(Distance_to_shore_c = c(10, 20, 30, 40))))

emtrends(mod.lme.breeding.cont, ~ Distance_to_shore_c, var = "breeding_biomass_kgha_side", adjust = "fdr", type = "response", at = list(Distance_to_shore_c = c(10, 20, 30, 40)))

#with restoration status:----
mod.lme.rest.cont <- lme(N15 ~ reststat*Distance_to_shore_c + Exposure, random = ~1|site.name, n15.all.seabirds.cont, method = "REML")
Anova(mod.lme.rest.cont)


emmeans(mod.lme.rest.cont, "reststat")
emmeans(mod.lme.rest.cont, "reststat", by = "Distance_to_shore_c")
emmeans(mod.lme.rest.cont, "Distance_to_shore_c", by = "reststat")
joint_tests(mod.lme.rest.cont, by = "reststat", adjust = "fdr" )

test(emtrends(mod.lme.rest.cont, ~ reststat, var = "Distance_to_shore_c", adjust = "fdr", type = "response"))
test(emmeans(mod.lme.rest.cont, pairwise~"reststat", adjust = "fdr", type = "response"))


```

#try with log(n15):
```{r}
n15.all.seabirds$breeding_biomass_kgha_side

mod.lme.breeding.log.n15 <- lme(log(N15) ~breeding_biomass_kgha_side*Distance_to_shore + Exposure, random = ~1|site.name, n15.all.seabirds, method = "REML")

plot_grid(plot_model(mod.lme.breeding.log.n15, type = "diag")) #nice distribution
plot(mod.lme.breeding.log.n15) #fit looks great

#test statistics
summary(mod.lme.breeding.log.n15)
Anova(mod.lme.breeding.log.n15)
#Response: N15
#                                               Chisq Df Pr(>Chisq)    
#log(breeding_biomass_kgha_side)                    4.6630  1    0.03082 *  
#Distance_to_shore                                 67.1834  3  1.711e-14 ***
#Exposure                                           0.1158  1    0.73362    
#log(breeding_biomass_kgha_side):Distance_to_shore 23.5741  3  3.065e-05 ***

anova(mod.lme.breeding.log.n15)
#(Intercept)	1	56	156.61234	<.0001
#log(breeding_biomass_kgha_side)	1	3	4.53128	0.1232
#Distance_to_shore	3	56	22.42959	<.0001
#Exposure	1	3	0.15193	0.7227
#log(breeding_biomass_kgha_side):Distance_to_shore	3	56	7.85804	0.0002

vif(mod.lme.breeding.log.n15)
plot_summs(mod.lme.breeding.log.n15)



#look at emmeans:
emtrends(mod.lme.breeding.log.n15,  ~ Distance_to_shore, var = "breeding_biomass_kgha_side", type = "response")
#looks like all trending towards positive but overlaps 0. weaker effects at higher distances

test(emtrends(mod.lme.breeding.log.n15, ~ Distance_to_shore, var = "breeding_biomass_kgha_side", adjust = "fdr", type = "response"))
#no p-value actually significant....

test(emtrends(mod.lme.breeding.log.n15, ~ breeding_biomass_kgha_side, var = "Distance_to_shore", adjust = "fdr", type = "response"))


emmeans(mod.lme.breeding.log.n15, "Distance_to_shore")
emmeans(mod.lme.breeding.log.n15, "breeding_biomass_kgha_side", by = "Distance_to_shore")
emmeans(mod.lme.breeding.log.n15, "Distance_to_shore", by = "breeding_biomass_kgha_side")

emmeans(mod.lme.breeding.log.n15, list(pairwise ~ Distance_to_shore*breeding_biomass_kgha_side), type = "response", adjust = "fdr")




plot_dat2.log<-emmip(mod.lme.breeding.log.n15, Distance_to_shore ~ breeding_biomass_kgha_side, at = mylist2, CIs = TRUE, plotit=FALSE)
plot_dat2.log

n15.all.seabirds %>%
   ggplot(aes(x = breeding_biomass_kgha_side, y = log(N15), color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
#   geom_ribbon(data = plot_dat2.log, aes(x = breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log, aes(x = breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() 

```


#rest status:
```{r}
emmeans(mod.lme.rest, list(pairwise ~ reststat|Distance_to_shore), type = "response", adjust = "fdr")
emmeans(mod.lme.rest, list(pairwise ~ Distance_to_shore|reststat), type = "response", adjust = "fdr")
emmeans(mod.lme.rest, list( ~ reststat|Distance_to_shore), type = "response", adjust = "fdr")

emmeans(mod.lme.rest, list( pairwise ~ reststat), type = "response", adjust = "fdr")

```

#try log-log
```{r}
mod.lme.breeding.log.log <- lme(log(N15) ~log(breeding_biomass_kgha_side)*Distance_to_shore + Exposure, random = ~1|site.name, n15.all.seabirds, method = "REML")

plot_grid(plot_model(mod.lme.breeding.log.log, type = "diag")) #nice distribution
plot(mod.lme.breeding.log.log) #fit looks great

#test statistics
summary(mod.lme.breeding.log.log)
Anova(mod.lme.breeding.log.log)
#Response: N15
#                                               Chisq Df Pr(>Chisq)    
#log(breeding_biomass_kgha_side)                    4.6630  1    0.03082 *  
#Distance_to_shore                                 67.1834  3  1.711e-14 ***
#Exposure                                           0.1158  1    0.73362    
#log(breeding_biomass_kgha_side):Distance_to_shore 23.5741  3  3.065e-05 ***

anova(mod.lme.breeding.log.log)
#(Intercept)	1	56	156.61234	<.0001
#log(breeding_biomass_kgha_side)	1	3	4.53128	0.1232
#Distance_to_shore	3	56	22.42959	<.0001
#Exposure	1	3	0.15193	0.7227
#log(breeding_biomass_kgha_side):Distance_to_shore	3	56	7.85804	0.0002

vif(mod.lme.breeding.log.log)
plot_summs(mod.lme.breeding.log.log)



#look at emmeans:
emtrends(mod.lme.breeding.log.log,  ~ Distance_to_shore, var = "breeding_biomass_kgha_side", type = "response")
#looks like all trending towards positive but overlaps 0. weaker effects at higher distances

test(emtrends(mod.lme.breeding.log.log, ~ Distance_to_shore, var = "breeding_biomass_kgha_side", adjust = "fdr", type = "response"))
#no p-value actually significant....

test(emtrends(mod.lme.breeding.log.n15, ~ breeding_biomass_kgha_side, var = "Distance_to_shore", adjust = "fdr", type = "response"))


emmeans(mod.lme.breeding.log.log, "Distance_to_shore")
emmeans(mod.lme.breeding.log.log, "breeding_biomass_kgha_side", by = "Distance_to_shore")
emmeans(mod.lme.breeding.log.log, "Distance_to_shore", by = "breeding_biomass_kgha_side")

emmeans(mod.lme.breeding.log.log, list(pairwise ~ Distance_to_shore*breeding_biomass_kgha_side), type = "response", adjust = "fdr")

emmeans(mod.lme.breeding.log.log, specs = revpairwise~Distance_to_shore,
        at=list(Distance_to_shore=c(10,20)) ) 



plot_dat2.log<-emmip(mod.lme.breeding.log.log, Distance_to_shore ~ breeding_biomass_kgha_side, at = mylist2, CIs = TRUE, plotit=FALSE)
plot_dat2.log

n15.all.seabirds %>%
   ggplot(aes(x = log(breeding_biomass_kgha_side), y = log(N15), color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
 #  geom_ribbon(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() 
```


#Add exposure interaction
```{r}
n15.all.seabirds$breeding_biomass_kgha_side

mod.lme.breeding.log <- lmer(N15 ~ log(breeding_biomass_kgha_side)*Distance_to_shore + log(breeding_biomass_kgha_side)*Exposure + (1|site.name), n15.all.seabirds)

#mod.lme.breeding.log <- lmer(N15 ~ log(breeding_biomass_kgha_side)*Distance_to_shore*Exposure + (1|site.name), n15.all.seabirds)
#no 3-way interaction, few. And no distance to shore*exposure interaction.

plot_grid(plot_model(mod.lme.breeding.log, type = "diag")) #nice distribution
plot(mod.lme.breeding.log) #fit looks great

#test statistics
summary(mod.lme.breeding.log)
Anova(mod.lme.breeding.log)

anova(mod.lme.breeding.log)


vif(mod.lme.breeding.log)
plot_summs(mod.lme.breeding.log)



#look at emmeans:
emtrends(mod.lme.breeding.log,  ~ Distance_to_shore|Exposure, var = "log(breeding_biomass_kgha_side)", adjust = "fdr")
#looks like positive trends on protected side, negative on exposed side. larger effects at closer distances

test(emtrends(mod.lme.breeding.log, ~ Distance_to_shore|Exposure, var = "log(breeding_biomass_kgha_side)",  adjust = "fdr", type = "response"))
#all protected side p-values significant, nothing significant on exposed side...

emtrends(mod.lme.breeding.log,  pairwise~ Distance_to_shore|Exposure, var = "log(breeding_biomass_kgha_side)", adjust = "fdr")
#but, effect of seabirds is different at 10 m from shore compared to all other distances, and different 20 versus 40 m.

```

#Exposure interaction plots
```{r}

#extract emmeans----
emmip(mod.lme.breeding.log, Distance_to_shore ~ breeding_biomass_kgha_side|Exposure, CIs = TRUE,
      at = list(breeding_biomass_kgha_side = seq(5.39, 378, by = 10)), type = "response")

#plot raw data + lines: 
range(n15.all.seabirds$breeding_biomass_kgha_side)

(mylist2 <- list(
      breeding_biomass_kgha_side = seq(5.39, 379, by = 1)
))

plot_dat2.log<-emmip(mod.lme.breeding.log, Distance_to_shore ~ breeding_biomass_kgha_side|Exposure, at = mylist2, CIs = TRUE, plotit=FALSE, type = "response")
plot_dat2.log

n15.all.seabirds %>%
   ggplot(aes(x = breeding_biomass_kgha_side, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_jitter(alpha = .5, width = 4)+
   geom_ribbon(data = plot_dat2.log, aes(x = breeding_biomass_kgha_side, y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log, aes(x = breeding_biomass_kgha_side, y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)



plot_dat2.log<-emmip(mod.lme.breeding.log, Distance_to_shore ~ breeding_biomass_kgha_side|Exposure, at = mylist2, CIs = TRUE, plotit=FALSE)
plot_dat2.log

n15.all.seabirds %>%
   ggplot(aes(x = log(breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
 geom_line(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() +
  facet_wrap(~Exposure)

n15_seabird_log_plot<-
n15.all.seabirds %>%
   ggplot(aes(x = log(breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5)+
   geom_ribbon(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .1, lwd=0)+
 geom_line(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore), lwd = 1.2)+
  xlab("seabird breeding biomass (log kg/ha)")+
  ylab(expression(algal~delta^15~N))+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  labs(color = "distance to shore (m)", fill = "distance to shore (m)")+
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.position = c(.2,.85),
        legend.background = element_blank())
        #legent.key = element_rect) #,
        #legend.direction = "horizontal",
      #  legend.box.background = element_rect(colour = "black"))
n15_seabird_log_plot



n15.all.seabirds %>%
   ggplot(aes(x = log(breeding_biomass_kgha_side), y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5, aes(shape = Exposure))+
#   geom_ribbon(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
# geom_line(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() 


n15.all.seabirds %>%
   ggplot(aes(x = breeding_biomass_kgha_100m, y = N15, color = Distance_to_shore, fill = Distance_to_shore, group = Distance_to_shore))+
  geom_point(alpha = .5, aes(shape = Exposure))+
#   geom_ribbon(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, ymin = LCL, ymax=UCL, fill = Distance_to_shore), alpha = .2, lwd=0)+
# geom_line(data = plot_dat2.log, aes(x = log(breeding_biomass_kgha_side), y = yvar, color = Distance_to_shore, group = Distance_to_shore))+
  theme_bw() 

```
##doesn't actually work because breeding biomass range not at all exposures.

##non-log
```{r}
mod.lme.breeding <- lmer(N15 ~ breeding_biomass_kgha_side*Distance_to_shore + breeding_biomass_kgha_side*Exposure + (1|site.name), n15.all.seabirds)


mod.lme.breeding <- lmer(N15 ~ breeding_biomass_kgha_side*Distance_to_shore*Exposure + (1|site.name), n15.all.seabirds)
Anova(mod.lme.breeding)
summary(mod.lme.breeding)

#look at emmeans:
emtrends(mod.lme.breeding,  ~ Distance_to_shore|Exposure, var = "breeding_biomass_kgha_side", adjust = "fdr")

test(emtrends(mod.lme.breeding, ~ Distance_to_shore|Exposure, var = "breeding_biomass_kgha_side",  adjust = "fdr", type = "response"))
#now nothing significant....


emtrends(mod.lme.breeding,  pairwise~ Distance_to_shore|Exposure, var = "breeding_biomass_kgha_side", adjust = "fdr")
#but, effect of seabirds is different at 10 m from shore compared to all other distances, and different 20 versus 40 m.


#now no interaction
emtrends(mod.lme.breeding,  ~ Distance_to_shore, var = "breeding_biomass_kgha_side", adjust = "fdr")


#extract emmeans----
emmip(mod.lme.breeding, Distance_to_shore ~ breeding_biomass_kgha_side|Exposure, CIs = TRUE,
      at = list(breeding_biomass_kgha_side = seq(5.39, 378, by = 10)), type = "response")


##with 100 m
mod.lme.breeding <- lmer(N15 ~ breeding_biomass_kgha_100m*Distance_to_shore + breeding_biomass_kgha_100m*Exposure + (1|site.name), n15.all.seabirds)
Anova(mod.lme.breeding)
summary(mod.lme.breeding)

#look at emmeans:
emtrends(mod.lme.breeding,  ~ Distance_to_shore, var = "breeding_biomass_kgha_100m", adjust = "fdr")

test(emtrends(mod.lme.breeding, ~ Distance_to_shore, var = "breeding_biomass_kgha_100m",  adjust = "fdr", type = "response"))
#now nothing significant....


emtrends(mod.lme.breeding,  pairwise~ Distance_to_shore, var = "breeding_biomass_kgha_100m", adjust = "fdr")
#but, effect of seabirds is different at 10 m from shore compared to all other distances, and different 20 versus 40 m.


#now no interaction
emtrends(mod.lme.breeding,  ~ Distance_to_shore, var = "breeding_biomass_kgha_100m", adjust = "fdr")


#extract emmeans----
emmip(mod.lme.breeding, Distance_to_shore ~ breeding_biomass_kgha_100m, CIs = TRUE,
      at = list(breeding_biomass_kgha_100m = seq(5.39, 378, by = 10)), type = "response")


```


#N15 restoration status models*exposure

```{r}
mod.lme.rest <- lmer(N15 ~ reststat*Distance_to_shore + reststat*Exposure + (1|site.name), data = n15.all.seabirds)



#test statistics
summary(mod.lme.rest)
Anova(mod.lme.rest)
#Response: N15
#                             Chisq Df Pr(>Chisq)    
#reststat                   13.5694  2   0.001131 ** 
#Distance_to_shore          60.0721  3  5.673e-13 ***
#Exposure                    0.0203  1   0.886753    
#reststat:Distance_to_shore 18.1174  6   0.005945 ** 
#reststat:Exposure          18.6516  2  8.910e-05 ***

anova(mod.lme.rest)
	

vif(mod.lme.rest)
plot_summs(mod.lme.rest)


mod.lm.rest <- lm(N15 ~ reststat*Distance_to_shore + reststat*Exposure, data = n15.all.seabirds)
Anova(mod.lm.rest)
vif(mod.lm.rest, type = "predictor")

```



```{r}

emmeans(mod.lme.rest, list(pairwise ~ reststat*Distance_to_shore|Exposure), type = "response", adjust = "fdr")

emmeans(mod.lme.rest, list(pairwise ~ reststat|Distance_to_shore|Exposure), type = "response", adjust = "fdr")

#$`pairwise differences of reststat | Distance_to_shore, Exposure`
#Distance_to_shore = 10, Exposure = Exposed:
# 3                       estimate   SE   df t.ratio p.value
# recovering - reference    -0.541 1.49 5353  -0.364  0.7160
# recovering - unrestored    0.578 1.48 6064   0.390  0.7160
# reference - unrestored     1.118 1.49 5353   0.753  0.7160

#Distance_to_shore = 20, Exposure = Exposed:
# 3                       estimate   SE   df t.ratio p.value
# recovering - reference    -0.780 1.48 5621  -0.526  0.8939
# recovering - unrestored   -0.583 1.48 6064  -0.393  0.8939
# reference - unrestored     0.198 1.48 5621   0.133  0.8939

#Distance_to_shore = 30, Exposure = Exposed:
# 3                       estimate   SE   df t.ratio p.value
# recovering - reference    -0.697 1.48 5621  -0.470  0.8379
# recovering - unrestored   -1.001 1.48 6064  -0.676  0.8379
 #reference - unrestored    -0.304 1.48 5621  -0.205  0.8379

#Distance_to_shore = 40, Exposure = Exposed:
# 3                       estimate   SE   df t.ratio p.value
# recovering - reference    -0.459 1.54 2025  -0.298  0.7656
# recovering - unrestored   -1.511 1.48 6064  -1.020  0.7423
# reference - unrestored    -1.052 1.54 2025  -0.683  0.7423

#Distance_to_shore = 10, Exposure = Protected:
# 3                       estimate   SE   df t.ratio p.value
# recovering - reference     0.487 1.49 4464   0.326  0.7445
# recovering - unrestored    5.433 1.48 6064   3.668  0.0007
# reference - unrestored     4.946 1.49 4464   3.311  0.0014

#Distance_to_shore = 20, Exposure = Protected:
# 3                       estimate   SE   df t.ratio p.value
# recovering - reference     0.247 1.48 5621   0.167  0.8677
# recovering - unrestored    4.272 1.48 6064   2.885  0.0100
# reference - unrestored     4.025 1.48 5621   2.712  0.0100

#Distance_to_shore = 30, Exposure = Protected:
# 3                       estimate   SE   df t.ratio p.value
# recovering - reference     0.330 1.48 5621   0.223  0.8238
# recovering - unrestored    3.854 1.48 6064   2.602  0.0264
# reference - unrestored     3.524 1.48 5621   2.374  0.0264

#Distance_to_shore = 40, Exposure = Protected:
# 3                       estimate   SE   df t.ratio p.value
# recovering - reference     0.568 1.50 3792   0.378  0.7051
# recovering - unrestored    3.344 1.48 6064   2.258  0.0720
# reference - unrestored     2.776 1.50 3792   1.848  0.0969


emmeans(mod.lme.rest, list(pairwise ~ Exposure|Distance_to_shore|reststat), type = "response", adjust = "fdr")



plot.data.rest <-emmip(mod.lme.rest, ~ reststat*Distance_to_shore|Exposure,
          type = "response", CIs = TRUE, plotit=FALSE)

plot.data.rest



response.plot.rest<-
  ggplot(data = plot.data.rest, aes(x = Distance_to_shore, y = yvar, color = reststat, fill = reststat, group = reststat) )+
#  geom_point(pch = 4,  position = position_dodge(.3))+
  geom_pointrange(aes(ymin = LCL, ymax = UCL), alpha = .3, linewidth = 2, size = 0.2, position = position_dodge(.1)) + #,  position = position_dodge(.3) 
 # geom_point(data = fishn15.seabirds.cond.r, 
           #  aes(y = n15, x = seabird_level), size = 2.5, alpha = .5,  position = position_dodge(.3))+ 
    geom_line(alpha = .5 ,  position = position_dodge(.1))+
  facet_wrap(~Exposure)+
  #scale_fill_manual(values = my_colors)+
 # scale_color_manual(values = my_colors) +
  ylab(expression(italic(delta)^15*N))+
#scale_y_continuous(labels = scales::label_percent(accuracy = .1, scale = 1),  limits = c(0, 100), expand = expansion(0, 0))+
  scale_fill_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E"))+ #low-mid-high = red-yellow-green
    scale_colour_manual(values = c( "unrestored" = "#CD1913", "recovering" = "#F2BB05", "reference" ="#2F9D3E"))+#low-mid-high = red-yellow-green
  xlab("Distance From Shore (m)")+
  #labs(color='Seabird Level', fill = 'Seabird Level') +
  theme_bw() +
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
        legend.title = element_blank() ,
        legend.position = c(0.88, 0.88) )

response.plot.rest

#ggsave(response.plot.rest, file = "../output/seabird-algaen15/n15_restorationstat_by_distance_model.jpg", width = 7, height = 5)




```


##IGNORE EXPOSURE:
```{r}

mod.lme.rest <- lmer(N15 ~ reststat*Distance_to_shore + (1|site.name), data = n15.all.seabirds)



#test statistics
summary(mod.lme.rest)
Anova(mod.lme.rest)
#Response: N15
#                             Chisq Df Pr(>Chisq)    
#reststat                    2.1733  2   0.337352    
#Distance_to_shore          59.9996  3  5.879e-13 ***
#reststat:Distance_to_shore 18.0498  6   0.006109 ** 

anova(mod.lme.rest)
	

vif(mod.lme.rest)
plot_summs(mod.lme.rest)

emmeans(mod.lme.rest, list(pairwise ~ reststat|Distance_to_shore), type = "response", adjust = "fdr")
emmeans(mod.lme.rest, list(pairwise ~ Distance_to_shore|reststat), type = "response", adjust = "fdr")


emmip(mod.lme.rest, ~ reststat|Distance_to_shore,
          type = "response", CIs = TRUE, plotit=TRUE)




mod.lme.bio <- lmer(N15 ~ log(breeding_biomass_kgha_side)*Distance_to_shore + (1|site.name), data = n15.all.seabirds)
Anova(mod.lme.bio)


emtrends(mod.lme.bio,  ~ Distance_to_shore, var = "log(breeding_biomass_kgha_side)", adjust = "fdr")
test(emtrends(mod.lme.bio,  ~ Distance_to_shore, var = "log(breeding_biomass_kgha_side)", adjust = "fdr", lmer.df = "asymptotic"))


```

